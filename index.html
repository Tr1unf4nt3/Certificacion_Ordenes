<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de √ìrdenes de Trabajo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #app { display: none; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ccc; margin-top: 10px; }
        .tab-button { padding: 10px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; }
        .tab-button.active { background-color: #f0f0f0; }
        #login-form { max-width: 300px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; }
        .formulario label, .formulario input, .formulario select, .formulario textarea { display: block; margin-bottom: 10px; }
        .section-header { margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    </style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>


<div id="login-form">
    <h2>üîë Inicio de Sesi√≥n</h2>
    <input type="email" id="login-email" placeholder="Correo Electr√≥nico">
    <input type="password" id="login-password" placeholder="Contrase√±a">
    <button onclick="loginUser()">Iniciar Sesi√≥n</button>
    <button onclick="registerUser()">Registrarse</button>
</div>

<div id="app">
    <div id="tabs">
        <button class="tab-button active" onclick="openTab('orden-trabajo', this)">üìã Orden de Trabajo</button>
        <button class="tab-button" onclick="openTab('ordenes-creadas', this)">üìù √ìrdenes Creadas</button>
        <button class="tab-button" onclick="openTab('ordenes-finalizadas', this)">‚úÖ √ìrdenes Finalizadas</button>
        <button class="tab-button" onclick="openTab('certificacion-final', this)">üìÑ Certificaci√≥n Final</button>
        <button class="tab-button" onclick="openTab('certificaciones-finales', this)">üìú Certificaciones Finales</button>
        <button class="tab-button" onclick="openTab('graficas', this)">üìà Gr√°ficas</button>
        <button class="tab-button admin-only" id="tab-export-import" onclick="openTab('exportacion-importacion', this)">üíæ Exportaci√≥n/Importaci√≥n</button>
        <button onclick="logoutUser()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
    </div>

    <div id="orden-trabajo" class="tab-content" style="display: block;">
        <h3>üìã Formulario Creaci√≥n Orden de Trabajo</h3>
        <div id="ot-form-container">
            <div id="ot-content-pdf" class="formulario">
                <h4>I. Informaci√≥n General</h4>
                <label>N√∫mero de la Orden de Trabajo: <span id="ot-numero"></span></label>
                <label>Usuario: <span id="ot-usuario"></span></label>
                <label>Fecha Actual: <span id="ot-fecha"></span></label>
                
                <label for="ot-contrato">Contrato:</label>
                <select id="ot-contrato">
                    <option>Acometidas y Empotrados</option>
                    <option>Relevamientos y Proyectos</option>
                </select>

                <h4>II. Informaci√≥n de la Contratista</h4>
                <label for="ot-empresa">Empresa:</label>
                <select id="ot-empresa">
                    <option>Empresa A</option>
                    <option>Empresa B</option>
                </select>
                <label>Rif: <span id="ot-rif"></span></label>
                <label>Responsable: <span id="ot-responsable"></span></label>

                </div>
            <button onclick="saveOrder()">Guardar Orden de Trabajo</button>
            <button onclick="generatePDF('ot-content-pdf', 'Orden de Trabajo', 'Firma Contratista', 'Firma Responsable')">Generar PDF</button>
        </div>
    </div>

    <div id="ordenes-creadas" class="tab-content">
        <h3>üìù √ìrdenes Creadas (En Proceso)</h3>
        <input type="text" id="filter-creadas" placeholder="Filtrar √ìrdenes...">
        <button onclick="exportToExcel('creadas-table', 'Ordenes_Creadas')">Exportar a Excel</button>
        <div id="creadas-list">
            <table id="creadas-table">
                <thead><tr><th>N¬∞</th><th>Usuario</th><th>Fecha</th><th>Trabajo</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="certificacion-obra-form" class="formulario" style="display: none; border-top: 2px solid #333; margin-top: 20px; padding-top: 20px;">
            <h4>Formulario de Certificaci√≥n de Obra</h4>
            <div id="cert-content-pdf">
                <label>N√∫mero de Certificaci√≥n: <span id="cert-numero"></span></label>
                <label>Empresa: <span id="cert-empresa"></span></label>
                <label>Corresponde Orden de trabajo N¬∞: <span id="cert-ot-numero"></span></label>
                <label for="cert-fecha-fin">Fin de la Obra:</label>
                <input type="date" id="cert-fecha-fin">
                <label for="cert-importe">Importe Total de la Obra ($):</label>
                <input type="number" id="cert-importe" value="0" step="0.01">
                <label for="cert-desviaciones">Desviaciones y Justificaci√≥n:</label>
                <textarea id="cert-desviaciones"></textarea>
            </div>
            <button onclick="document.getElementById('certificacion-obra-form').style.display='none'">Atr√°s</button>
            <button onclick="acceptFinalization()">Aceptar Finalizaci√≥n</button>
        </div>
    </div>

    <div id="ordenes-finalizadas" class="tab-content">
        <h3>‚úÖ √ìrdenes Finalizadas</h3>
        <input type="text" id="filter-finalizadas" placeholder="Filtrar √ìrdenes...">
        <button onclick="exportToExcel('finalizadas-table', 'Ordenes_Finalizadas')">Exportar √ìrdenes a Excel</button>
        <button onclick="exportToExcel('certificaciones-table', 'Certificaciones_Obra')">Exportar Certificaciones a Excel</button>
        <div id="finalizadas-list">
            <table id="finalizadas-table">
                <thead><tr><th>N¬∞ OT</th><th>N¬∞ Cert.</th><th>Empresa</th><th>Importe</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="certificacion-final" class="tab-content">
        <h3>üìÑ Formulario Certificaci√≥n Final</h3>
        <div class="formulario">
            <label>N√∫mero de Certificaci√≥n Final: <span id="cert-final-numero"></span></label>
            <label for="cert-final-empresa">Empresa:</label>
            <select id="cert-final-empresa" onchange="loadFinalizedOrdersForCert()"></select>
            
            <h4>√ìrdenes Realizadas</h4>
            <div id="ordenes-para-certificacion">
                </div>
            
            <label>Total ($): <span id="cert-final-total">0.00</span></label>
            <button onclick="acceptFinalCert()">Aceptar Certificaci√≥n Final</button>
        </div>
    </div>

    <div id="certificaciones-finales" class="tab-content">
        <h3>üìú Certificaciones Finales</h3>
        <input type="text" id="filter-cert-final" placeholder="Filtrar Certificaciones...">
        <button onclick="exportToExcel('cert-final-table', 'Certificaciones_Finales')">Exportar a Excel</button>
        <div id="cert-final-list">
            <table id="cert-final-table">
                <thead><tr><th>N¬∞ Cert.</th><th>Empresa</th><th>Total</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="graficas" class="tab-content">
        <h3>üìà Gr√°ficas</h3>
        <p>Aqu√≠ se integrar√≠an librer√≠as de gr√°ficos como Chart.js o D3.js para visualizar los datos de las √ìrdenes Creadas, Finalizadas y Certificaciones Finales, con opciones de filtrado por Fecha, Empresa, Cantidad de √ìrdenes, Sumatoria de Importes y Trabajo / Obra a realizar.</p>
        

[Image of Chart.js example bar chart]

    </div>

    <div id="exportacion-importacion" class="tab-content admin-only">
        <h3>üíæ Exportaci√≥n e Importaci√≥n de Informaci√≥n</h3>
        <h4>Exportar Informaci√≥n</h4>
        <button onclick="exportAllData()">Exportar Informaci√≥n (JSON)</button>
        
        <h4>Importar Informaci√≥n</h4>
        <input type="file" id="import-file" accept=".json">
        <button onclick="importAllData()">Importar Informaci√≥n (JSON)</button>
    </div>

</div>

<script>
    // 3._ DATOS DEL SDK DE FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyD8kNT9Fx_nTWh6PPu5zol5K8uzjrSQ0HY",
        authDomain: "certificacionordenes.firebaseapp.com",
        projectId: "certificacionordenes",
        storageBucket: "certificacionordenes.firebasestorage.app",
        messagingSenderId: "1031284418081",
        appId: "1:1031284418081:web:7e921d43798a305756a560"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const db = app.firestore();

    let currentUserRole = 'Usuario Normal'; // Rol por defecto
    let currentUserId = null;
    let otGlobalCounter = 0; // Contador de √≥rdenes de trabajo

    // 1._ INICIO DE SESI√ìN Y ROLES
    
    /**
     * Verifica la autenticaci√≥n, carga el rol del usuario y actualiza la interfaz.
     */
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            currentUserId = user.uid;
            document.getElementById('ot-usuario').textContent = user.email; // Mostrar el correo

            // 4._ ASIGNACI√ìN DE ROL: Admin para el primero, Normal para el resto.
            let userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists) {
                // Primer inicio de sesi√≥n. Determinar rol.
                const firstUserCheck = await db.collection('users').limit(1).get();
                const isFirstUser = firstUserCheck.empty;

                currentUserRole = isFirstUser ? 'Administrador' : 'Usuario Normal';
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    role: currentUserRole
                });
            } else {
                currentUserRole = userDoc.data().role;
            }

            // Actualizar interfaz seg√∫n el rol
            updateUIByRole();
            // Inicializar contadores y cargar datos
            await loadGlobalCounters();
            openTab('orden-trabajo', document.querySelector('#tabs .tab-button')); // Abrir pesta√±a por defecto

        } else {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('app').style.display = 'none';
            currentUserId = null;
            currentUserRole = 'Usuario Normal';
        }
    });

    /**
     * Actualiza la visibilidad de las pesta√±as seg√∫n el rol.
     */
    function updateUIByRole() {
        const adminElements = document.querySelectorAll('.admin-only');
        const normalElements = document.querySelectorAll('.normal-only');
        const isAdmin = currentUserRole === 'Administrador';

        adminElements.forEach(el => el.style.display = isAdmin ? 'block' : 'none');
        // L√≥gica de botones de "Eliminar" (solo visible para Admin)
        // Se manejar√° en el renderizado de listas.
        
        console.log("Rol del usuario:", currentUserRole);
    }
    
    /**
     * Inicia sesi√≥n con correo y contrase√±a.
     */
    async function loginUser() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
            alert('Inicio de sesi√≥n exitoso!');
        } catch (error) {
            alert('Error al iniciar sesi√≥n: ' + error.message);
        }
    }

    /**
     * Registra un nuevo usuario.
     */
    async function registerUser() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await auth.createUserWithEmailAndPassword(email, password);
            alert('Registro exitoso. Se ha iniciado sesi√≥n.');
        } catch (error) {
            alert('Error al registrar: ' + error.message);
        }
    }

    /**
     * Cierra la sesi√≥n del usuario.
     */
    function logoutUser() {
        auth.signOut();
    }

    // 2._ NAVEGACI√ìN POR PESTA√ëAS
    /**
     * Abre una pesta√±a y oculta las dem√°s.
     */
    function openTab(tabName, elmnt) {
        let i, tabcontent, tabbuttons;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tabbuttons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabbuttons.length; i++) {
            tabbuttons[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        elmnt.classList.add("active");
        
        // Carga din√°mica de datos al abrir pesta√±as
        if (tabName === 'ordenes-creadas') {
            loadOrders('En Proceso');
        } else if (tabName === 'ordenes-finalizadas') {
            loadOrders('Finalizado');
        } else if (tabName === 'certificacion-final') {
            // Se asume que las empresas de la lista de Cert. Final provienen de una lista maestra o las OT finalizadas
            document.getElementById('cert-final-empresa').innerHTML = '<option value="">Seleccione Empresa</option><option>Empresa A</option><option>Empresa B</option>';
            loadFinalCertNumber();
        }
    }


    // --- GESTI√ìN DE FIREBASE FIRESTORE Y CONTADORES ---

    /**
     * Carga los contadores globales (OT, Cert. Final)
     */
    async function loadGlobalCounters() {
        const counterRef = db.collection('settings').doc('counters');
        const doc = await counterRef.get();
        if (doc.exists) {
            otGlobalCounter = doc.data().otCounter || 0;
        } else {
            await counterRef.set({ otCounter: 0, certFinalCounter: 0 });
        }
        // Asignar el nuevo n√∫mero de OT al formulario
        document.getElementById('ot-numero').textContent = otGlobalCounter + 1;
        document.getElementById('ot-fecha').textContent = new Date().toLocaleDateString('es-VE', { timeZone: 'America/Caracas' });
    }

    /**
     * Guarda la Orden de Trabajo en Firestore e incrementa el contador.
     */
    async function saveOrder() {
        // Obtenemos los datos del formulario (simplicado)
        const newOtNumber = otGlobalCounter + 1;
        const orderData = {
            numeroOT: newOtNumber,
            usuario: auth.currentUser.email,
            fechaCreacion: new Date().toISOString(),
            contrato: document.getElementById('ot-contrato').value,
            empresa: document.getElementById('ot-empresa').value,
            // ... agregar todos los campos del formulario ...
            estado: 'En Proceso'
        };

        try {
            // Guardar la OT
            await db.collection('ordenes').doc(String(newOtNumber)).set(orderData);
            
            // Actualizar el contador
            const counterRef = db.collection('settings').doc('counters');
            await counterRef.update({ otCounter: newOtNumber });
            otGlobalCounter = newOtNumber;
            
            document.getElementById('ot-numero').textContent = otGlobalCounter + 1; // Actualizar UI
            alert(`Orden de Trabajo N¬∞ ${newOtNumber} creada con √©xito.`);
            loadOrders('En Proceso'); // Recargar lista
        } catch (error) {
            console.error("Error al guardar la orden: ", error);
            alert("Error al guardar la orden: " + error.message);
        }
    }

    /**
     * Carga y muestra las √ìrdenes de Trabajo seg√∫n el estado.
     */
    async function loadOrders(estado) {
        const listBody = document.querySelector(estado === 'En Proceso' ? '#creadas-list tbody' : '#finalizadas-list tbody');
        listBody.innerHTML = '';
        const snapshot = await db.collection('ordenes').where('estado', '==', estado).orderBy('numeroOT').get();
        
        snapshot.forEach(doc => {
            const data = doc.data();
            const row = listBody.insertRow();
            row.insertCell().textContent = data.numeroOT;
            row.insertCell().textContent = data.usuario;
            row.insertCell().textContent = new Date(data.fechaCreacion).toLocaleDateString();
            row.insertCell().textContent = data.contrato;

            const actionsCell = row.insertCell();
            
            // Bot√≥n de Descargar PDF
            actionsCell.innerHTML += `<button onclick="downloadOTPDF(${data.numeroOT})">PDF OT</button>`;

            if (estado === 'En Proceso') {
                // Bot√≥n Finalizar (solo para √≥rdenes en proceso)
                actionsCell.innerHTML += `<button onclick="showFinalizationForm(${data.numeroOT})">Finalizar</button>`;
            } else if (estado === 'Finalizado') {
                // Bot√≥n de Certificaci√≥n de Obra (solo para √≥rdenes finalizadas)
                actionsCell.innerHTML += `<button onclick="downloadCertObraPDF(${data.numeroOT})">PDF Cert.</button>`;
            }

            // Bot√≥n de Eliminar (solo para Admin)
            if (currentUserRole === 'Administrador') {
                actionsCell.innerHTML += `<button style="color: red;" onclick="deleteOrder(${data.numeroOT}, '${estado}')">Eliminar</button>`;
            }
        });
    }

    /**
     * Muestra el formulario de Certificaci√≥n de Obra.
     */
    async function showFinalizationForm(otNumber) {
        const otDoc = await db.collection('ordenes').doc(String(otNumber)).get();
        if (!otDoc.exists) return alert('Orden de Trabajo no encontrada.');
        const otData = otDoc.data();

        document.getElementById('cert-numero').textContent = otNumber;
        document.getElementById('cert-empresa').textContent = otData.empresa;
        document.getElementById('cert-ot-numero').textContent = otNumber;
        // Asumiendo que la fecha de inicio es parte de los datos guardados de la OT
        // document.getElementById('cert-fecha-inicio').textContent = otData.fechaInicio; 
        
        document.getElementById('certificacion-obra-form').style.display = 'block';
        // Guardar el n√∫mero de OT en una variable global o en un atributo para usarlo al aceptar
        document.getElementById('certificacion-obra-form').dataset.otNumber = otNumber; 
    }

    /**
     * Acepta la finalizaci√≥n, guarda la certificaci√≥n y cambia el estado de la OT.
     */
    async function acceptFinalization() {
        const otNumber = document.getElementById('certificacion-obra-form').dataset.otNumber;
        const certData = {
            otNumber: Number(otNumber),
            numeroCertificacion: Number(otNumber), // Usar el mismo n√∫mero de OT
            fechaCertificacion: new Date().toISOString(),
            empresa: document.getElementById('cert-empresa').textContent,
            // ... Otros campos del formulario de certificaci√≥n ...
            importeTotal: Number(document.getElementById('cert-importe').value),
            desviaciones: document.getElementById('cert-desviaciones').value
        };

        try {
            // 1. Guardar la Certificaci√≥n de Obra
            await db.collection('certificacionesObra').doc(String(otNumber)).set(certData);
            
            // 2. Cambiar el estado de la Orden de Trabajo a 'Finalizado'
            await db.collection('ordenes').doc(String(otNumber)).update({ estado: 'Finalizado' });

            alert(`Orden N¬∞ ${otNumber} Finalizada y Certificaci√≥n de Obra generada.`);
            
            // 3. Generar PDF de Certificaci√≥n de Obra
            generatePDF('cert-content-pdf', 'Certificaci√≥n de Obra', 'Firma Jefe T√©cnico', 'Firma Gerente T√©cnico');
            
            // 4. Actualizar listas y ocultar formulario
            document.getElementById('certificacion-obra-form').style.display = 'none';
            loadOrders('En Proceso'); 
            // La lista de finalizadas se cargar√° al cambiar de pesta√±a

        } catch (error) {
            console.error("Error al finalizar la orden: ", error);
            alert("Error al finalizar la orden: " + error.message);
        }
    }

    // --- FUNCIONES DE UTILIDAD (PDF, Excel, Exportaci√≥n/Importaci√≥n) ---

    /**
     * Genera un PDF de un elemento HTML usando jsPDF y html2canvas.
     * @param {string} elementId ID del elemento contenedor.
     * @param {string} title T√≠tulo del documento (e.g., Orden de Trabajo).
     * @param {string} signature1 Texto de la primera firma.
     * @param {string} signature2 Texto de la segunda firma.
     */
    function generatePDF(elementId, title, signature1, signature2) {
        // Uso de window.jspdf.jsPDF por el CDN
        const { jsPDF } = window.jspdf;
        const input = document.getElementById(elementId);
        
        // Clonar el contenido para a√±adir las firmas y trabajar con un DOM temporal
        const content = input.cloneNode(true);
        // T√≠tulo especial: "Orden de Trabajo N¬∞(N√∫mero)"
        const otNumber = content.querySelector('#ot-numero')?.textContent || content.querySelector('#cert-numero')?.textContent || 'N/A';
        const docTitle = `${title} N¬∞${otNumber}`;

        const margin = 10; // 1cm = 10mm

        // Estilos para el PDF (m√°rgenes y firmas)
        const style = document.createElement('style');
        style.textContent = `
            .pdf-page { padding: ${margin}mm; box-sizing: border-box; }
            .pdf-signatures { margin-top: 50px; display: flex; justify-content: space-around; width: 100%; }
            .pdf-signature-box { border-top: 1px solid #000; padding-top: 5px; text-align: center; width: 45%; }
        `;
        document.head.appendChild(style);

        // Crear contenedor para firmas (y texto en Certificaci√≥n Final)
        const signatureContainer = document.createElement('div');
        signatureContainer.classList.add('pdf-signatures');
        
        if (title === 'Certificaci√≥n Final') {
            const finalCertText = document.createElement('p');
            finalCertText.textContent = "Quedan archivadas cada una de las Ordenes de Trabajo finalizadas indicadas en la presente Certificaci√≥n Final.";
            content.appendChild(finalCertText);
        }

        signatureContainer.innerHTML = `
            <div class="pdf-signature-box">${signature1}</div>
            <div class="pdf-signature-box">${signature2}</div>
        `;
        content.appendChild(signatureContainer);
        
        // A√±adir el contenido clonado y estilizado al cuerpo (temporalmente)
        content.classList.add('pdf-page');
        document.body.appendChild(content);

        // Configuraci√≥n para html2canvas y jsPDF (para multi-p√°gina, aunque es complejo)
        html2canvas(content, { 
            scale: 2 // Aumentar la escala para mejor calidad
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            let imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.setFontSize(14);
            pdf.text(docTitle, 105, 15, null, null, 'center'); // T√≠tulo centrado

            // L√≥gica b√°sica para salto de p√°gina (divide el canvas en p√°ginas)
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`${docTitle}.pdf`);
            
            // Eliminar elementos temporales
            document.body.removeChild(content);
            document.head.removeChild(style);
        });
    }
    
    /**
     * Exporta los datos de una tabla HTML a un archivo Excel (.xlsx) usando SheetJS.
     * @param {string} tableId ID de la tabla HTML.
     * @param {string} filename Nombre base del archivo.
     */
    function exportToExcel(tableId, filename) {
        const table = document.getElementById(tableId);
        if (!table) return alert('Tabla no encontrada para exportar.');
        
        // Convertir la tabla HTML a un libro de trabajo de SheetJS
        const workbook = XLSX.utils.table_to_book(table, { sheet: filename });
        
        // Escribir y descargar el archivo XLSX
        XLSX.writeFile(workbook, `${filename}.xlsx`);
    }

    /**
     * Exporta TODA la informaci√≥n de Firestore a un archivo JSON. (Solo Admin)
     */
    async function exportAllData() {
        if (currentUserRole !== 'Administrador') return alert('Acceso denegado.');

        const collectionsToExport = ['ordenes', 'certificacionesObra', 'certificacionesFinales', 'users', 'settings'];
        const exportData = {};

        try {
            for (const colName of collectionsToExport) {
                const snapshot = await db.collection(colName).get();
                exportData[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_firestore_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Informaci√≥n exportada con √©xito.');

        } catch (error) {
            console.error("Error al exportar datos: ", error);
            alert("Error al exportar datos: " + error.message);
        }
    }

    /**
     * Importa informaci√≥n desde un archivo JSON a Firestore. (Solo Admin)
     */
    function importAllData() {
        if (currentUserRole !== 'Administrador') return alert('Acceso denegado.');
        const fileInput = document.getElementById('import-file');
        const file = fileInput.files[0];

        if (!file) return alert('Por favor, seleccione un archivo JSON.');

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importData = JSON.parse(e.target.result);
                
                // Advertencia y confirmaci√≥n para evitar sobreescritura accidental
                if (!confirm('ADVERTENCIA: ¬øEst√° seguro que desea importar estos datos? Esto SOBREESCRIBIR√Å la informaci√≥n existente en las colecciones de Firestore.')) {
                    return;
                }

                const batch = db.batch();
                let docCount = 0;

                for (const colName in importData) {
                    if (Array.isArray(importData[colName])) {
                        importData[colName].forEach(docData => {
                            const docId = docData.id;
                            delete docData.id; // Remover el ID del objeto para evitar que se guarde como campo
                            const docRef = db.collection(colName).doc(docId);
                            batch.set(docRef, docData);
                            docCount++;
                        });
                    }
                }

                await batch.commit();
                alert(`Importaci√≥n exitosa. ${docCount} documentos guardados.`);
                // Recargar contadores y datos despu√©s de la importaci√≥n
                await loadGlobalCounters();
                loadOrders('En Proceso'); 

            } catch (error) {
                console.error("Error al importar datos: ", error);
                alert("Error al procesar el archivo o importar a Firestore: " + error.message);
            }
        };
        reader.readAsText(file);
    }
    
    // Funci√≥n de ejemplo para descarga de PDF de OT
    function downloadOTPDF(otNumber) {
        // En una aplicaci√≥n completa, cargar√≠as los datos de la OT y luego llamar√≠as a generatePDF
        alert(`Generando PDF para Orden de Trabajo N¬∞ ${otNumber}`);
        // Llamada simulada: generatePDF(..., 'Orden de Trabajo', ...);
    }

    // Funci√≥n de ejemplo para descarga de PDF de Certificaci√≥n de Obra
    function downloadCertObraPDF(otNumber) {
        // En una aplicaci√≥n completa, cargar√≠as los datos de la Certificaci√≥n de Obra y luego llamar√≠as a generatePDF
        alert(`Generando PDF para Certificaci√≥n de Obra N¬∞ ${otNumber}`);
        // Llamada simulada: generatePDF(..., 'Certificaci√≥n de Obra', 'Firma Jefe T√©cnico', 'Firma Gerente T√©cnico');
    }

</script>
</body>
</html>

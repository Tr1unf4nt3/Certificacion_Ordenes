<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Edici√≥n Avanzada Completa</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <!-- NUEVA LIBRER√çA: Exportaci√≥n a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;         /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;    /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE;  /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;     /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;       /* Gris carb√≥n (Charcoal) */
            --color-white: #ffffff;
            --color-error: #FF6961;      /* Rojo pastel para errores */
            --color-success: #77DD77;    /* Verde pastel para √©xito */
            --color-warning: #FFB347;    /* Naranja pastel para advertencias */
            --color-filter: #DDA0DD;     /* Color para elementos de filtro */
            --color-in-progress: #FFD700; /* Amarillo para "En curso" */
            --color-completed: #77DD77;  /* Verde para "Finalizada" */
            --color-excel: #28a745;      /* Verde para botones Excel */
            --color-excel-light: #17a2b8; /* Azul para botones Excel secundarios */
            --color-certification: #9C27B0; /* P√∫rpura para certificaciones finales */
            --color-certified: #4CAF50;  /* Verde para certificadas */
            --color-not-certified: #FF9800; /* Naranja para no certificadas */
            --color-company: #6A5ACD;    /* Azul pizarra para empresas */
            --color-edit: #2196F3;       /* Azul para edici√≥n */
            --color-admin: #FF4081;      /* Rosa para funciones admin */
            --color-edit-certified: #9C27B0; /* P√∫rpura para editar certificadas */
        }

        /* Estilos Generales (Dise√±o Pastel) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2, h3, h4 {
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 25px;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="email"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-white);
        }

        /* Estilo para campos autollenados/deshabilitados */
        input:disabled {
            background-color: #f0f0f0; 
            border: 1px dashed var(--color-secondary);
        }

        /* Estilo de validaci√≥n (el navegador se encarga de lo b√°sico, pero esto ayuda) */
        input:invalid:not(:placeholder-shown), select:invalid:not(:placeholder-shown), textarea:invalid:not(:placeholder-shown) {
            border: 2px solid var(--color-error);
        }

        .form-section {
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #f7fbff;
        }

        /* Contenedor Flex para Campos de C√°lculo */
        .calculation-group {
            display: flex;
            align-items: center;
            gap: 10px;
            /* Flex vertical para etiquetas y horizontal para inputs/resultados */
            flex-wrap: wrap; 
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            background-color: #e0f7fa; /* Fondo azul claro para destacar el c√°lculo */
        }

        /* Estilo para la etiqueta y el input del Total calculado */
        .calculation-total-section {
            display: flex;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }

        .calculation-total-section label {
            font-weight: bold;
            flex-basis: auto; 
            margin-right: 15px;
            white-space: nowrap;
        }

        .total-display {
            background-color: var(--color-white);
            font-weight: bold;
            text-align: right;
            border: 1px dashed var(--color-accent);
            padding: 10px;
            border-radius: 6px;
            flex-grow: 1;
        }

        .calculation-input { 
            flex-basis: calc(45% - 20px); 
        } 
        .calculation-group .formula-symbol {
            font-size: 1.5em; 
            font-weight: bold; 
            margin-left: 5px; 
            margin-right: 5px;
        }

        button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 10px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        button:hover {
            background-color: var(--color-primary);
        }
        
        /* Botones de Check Condicional */
        .conditional-check {
            background-color: var(--color-secondary);
            color: var(--color-white);
            font-weight: bold;
            padding: 15px;
            margin-bottom: 10px;
            display: block;
            text-align: left;
        }
        .conditional-check.active {
            background-color: var(--color-success);
        }


        /* Layout de Pesta√±as */
        .tab { overflow: hidden; border-bottom: 1px solid var(--color-secondary); margin-bottom: 20px; }
        .tablinks { background-color: var(--color-bg); color: var(--color-text); float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: 0.3s; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .tablinks:hover { background-color: var(--color-primary); }
        .tablinks.active { background-color: var(--color-primary); border-bottom: 3px solid var(--color-accent); margin-bottom: -1px; }
        .tabcontent { display: none; padding: 30px 0; }

        /* Estilos de Edici√≥n */
        .field-editor-item { border: 1px dashed var(--color-secondary); border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: var(--color-white); }
        .required-fixed-field { padding: 10px; background-color: var(--color-secondary); color: var(--color-white); border-radius: 4px; margin-bottom: 10px; }
        
        /* Estilos para la tabla */
        #orders-table, #companies-table { width: 100%; border-collapse: collapse; }
        #orders-table th, #orders-table td, #companies-table th, #companies-table td { border: 1px solid var(--color-secondary); padding: 12px; text-align: left; }
        #orders-table th, #companies-table th { background-color: var(--color-primary); color: var(--color-text); }
        #orders-table tr:nth-child(even), #companies-table tr:nth-child(even) { background-color: var(--color-bg); }
        #orders-table tr:hover, #companies-table tr:hover { background-color: var(--color-accent); color: var(--color-white); }

        /* Login View */
        #login-view { width: 350px; padding: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--color-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-error { color: var(--color-error); font-weight: bold; }
        
        /* Estilo para las firmas en el PDF */
        .pdf-signatures {
            margin-top: 60px; /* 1cm m√°s abajo */
            padding-top: 30px;
            border-top: 1px dashed #B0C4DE;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
        }
        .pdf-signatures span {
            display: inline-block;
            width: 45%; /* Ajuste para espacio entre firmas */
        }
        .pdf-signatures hr {
            border: none;
            border-top: 1px solid #36454F;
            margin: 5px 0 0 0;
        }
        
        /* Estilos espec√≠ficos para el encabezado en p√°ginas > 1 del PDF */
        .pdf-header-secondary {
            position: fixed; /* Fijo en la parte superior */
            top: 10px; /* Posici√≥n ajustada para evitar margen */
            right: 20px; /* Posici√≥n ajustada para el lado derecho */
            font-size: 14px; /* Tama√±o similar al de las secciones */
            color: #555;
            font-weight: bold;
            z-index: 1000;
        }

        /* Estilos para las funciones de exportaci√≥n/importaci√≥n */
        .backup-section {
            border: 2px solid var(--color-warning);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #fffaf0;
        }
        
        .backup-section h4 {
            color: var(--color-warning);
            border-bottom: 1px solid var(--color-warning);
        }
        
        .backup-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .backup-button {
            background-color: var(--color-warning);
            color: var(--color-text);
            font-weight: bold;
        }
        
        .backup-button:hover {
            background-color: #ffa726;
        }
        
        #import-file {
            margin: 10px 0;
        }

        /* NUEVOS ESTILOS PARA FILTROS */
        .filters-section {
            border: 2px solid var(--color-filter);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #faf0ff;
        }
        
        .filters-section h4 {
            color: var(--color-filter);
            border-bottom: 1px solid var(--color-filter);
            margin-top: 0;
        }
        
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-text);
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .filter-button {
            background-color: var(--color-filter);
            color: var(--color-white);
            font-weight: bold;
            white-space: nowrap;
        }
        
        .filter-button:hover {
            background-color: #ba55d3;
        }
        
        .active-filters {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--color-bg);
            border-radius: 6px;
            border-left: 4px solid var(--color-filter);
        }
        
        .active-filter-tag {
            display: inline-block;
            background-color: var(--color-filter);
            color: var(--color-white);
            padding: 5px 10px;
            margin: 5px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .active-filter-tag .remove-filter {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .range-inputs {
            display: flex;
            gap: 10px;
        }
        
        .range-inputs input {
            flex: 1;
        }

        /* NUEVOS ESTILOS PARA ESTADOS DE √ìRDENES */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85em;
            text-align: center;
        }
        
        .status-in-progress {
            background-color: var(--color-in-progress);
            color: #333;
        }
        
        .status-completed {
            background-color: var(--color-completed);
            color: white;
        }
        
        .complete-button {
            background-color: var(--color-success);
            color: white;
        }
        
        .complete-button:hover {
            background-color: #66bb6a;
        }
        
        /* Estilos para el modal de certificaci√≥n */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .modal-back-button {
            background-color: var(--color-secondary);
            color: white;
        }
        
        .modal-accept-button {
            background-color: var(--color-success);
            color: white;
        }

        /* NUEVOS ESTILOS PARA EXPORTACI√ìN EXCEL */
        .export-section {
            border: 2px solid var(--color-excel);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #f0fff4;
        }
        
        .export-section h4 {
            color: var(--color-excel);
            border-bottom: 1px solid var(--color-excel);
            margin-top: 0;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .excel-button {
            background-color: var(--color-excel);
            color: white;
            font-weight: bold;
        }
        
        .excel-button:hover {
            background-color: #218838;
        }
        
        .excel-button-secondary {
            background-color: var(--color-excel-light);
            color: white;
            font-weight: bold;
        }
        
        .excel-button-secondary:hover {
            background-color: #138496;
        }

        /* NUEVOS ESTILOS PARA CERTIFICACI√ìN FINAL */
        .certification-section {
            border: 2px solid var(--color-certification);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #faf4ff;
        }
        
        .certification-section h4 {
            color: var(--color-certification);
            border-bottom: 1px solid var(--color-certification);
            margin-top: 0;
        }
        
        .certification-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .certification-button {
            background-color: var(--color-certification);
            color: white;
            font-weight: bold;
        }
        
        .certification-button:hover {
            background-color: #7b1fa2;
        }
        
        .certification-total-section {
            background-color: #e1bee7;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid var(--color-certification);
        }
        
        .certification-total-display {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            color: var(--color-certification);
        }
        
        /* Estilos para la lista de certificaciones finales */
        .certification-list {
            margin-top: 20px;
        }
        
        .certification-item {
            border: 2px solid var(--color-certification);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f3e5f5;
        }
        
        .certification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .certification-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-certification);
        }
        
        .orders-list {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e1bee7;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-actions {
            display: flex;
            gap: 5px;
        }
        
        .order-pdf-button {
            background-color: #87CEFA;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .certification-pdf-button {
            background-color: var(--color-certification);
            color: white;
        }

        /* Estilos para checkboxes de √≥rdenes */
        .orders-checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .order-checkbox-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .order-checkbox-item:last-child {
            border-bottom: none;
        }
        
        .order-amount {
            font-weight: bold;
            color: var(--color-certification);
        }

        /* Estilos para √≥rdenes ya certificadas */
        .order-certified {
            opacity: 0.6;
            background-color: #f5f5f5;
        }
        
        .certified-badge {
            background-color: var(--color-certification);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 10px;
        }

        /* NUEVOS ESTILOS PARA FILTRO DE CERTIFICACI√ìN */
        .certification-filter-section {
            border: 2px solid var(--color-certified);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background-color: #f1f8e9;
        }
        
        .certification-filter-section h5 {
            color: var(--color-certified);
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .certification-filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .certification-filter-button {
            background-color: var(--color-certified);
            color: white;
            font-weight: bold;
            padding: 8px 15px;
        }
        
        .certification-filter-button.not-certified {
            background-color: var(--color-not-certified);
        }
        
        .certification-filter-button.active {
            box-shadow: 0 0 0 2px var(--color-text);
        }
        
        .certification-filter-button:hover {
            opacity: 0.9;
        }

        /* NUEVOS ESTILOS PARA PESTA√ëA DE EMPRESAS */
        .company-section {
            border: 2px solid var(--color-company);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #f8f7ff;
        }
        
        .company-section h4 {
            color: var(--color-company);
            border-bottom: 1px solid var(--color-company);
            margin-top: 0;
        }
        
        .company-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .company-button {
            background-color: var(--color-company);
            color: white;
            font-weight: bold;
        }
        
        .company-button:hover {
            background-color: #483D8B;
        }
        
        .company-form-container {
            border: 1px solid var(--color-company);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #f0f0ff;
        }
        
        .company-form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        
        .company-form-field {
            flex: 1;
        }
        
        .company-form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-company);
        }

        /* Estilo para mensaje de no empresas */
        .no-companies-message {
            text-align: center;
            padding: 40px;
            color: var(--color-text);
            background-color: #f0f8ff;
            border-radius: 8px;
            border: 2px dashed var(--color-secondary);
            margin: 20px 0;
        }

        /* NUEVOS ESTILOS PARA EDICI√ìN ADMINISTRATIVA AVANZADA */
        .admin-section {
            border: 2px solid var(--color-admin);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #fff0f5;
        }
        
        .admin-section h4 {
            color: var(--color-admin);
            border-bottom: 1px solid var(--color-admin);
            margin-top: 0;
        }
        
        .edit-button {
            background-color: var(--color-edit);
            color: white;
            font-weight: bold;
        }
        
        .edit-button:hover {
            background-color: #1976D2;
        }
        
        .edit-certified-button {
            background-color: var(--color-edit-certified);
            color: white;
            font-weight: bold;
        }
        
        .edit-certified-button:hover {
            background-color: #7b1fa2;
        }
        
        .revert-button {
            background-color: var(--color-warning);
            color: white;
            font-weight: bold;
        }
        
        .revert-button:hover {
            background-color: #ff9800;
        }
        
        .certification-edit-section {
            border: 2px solid var(--color-certification);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #f3e5f5;
        }
        
        .certification-edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .remove-order-button {
            background-color: var(--color-error);
            color: white;
            font-size: 0.8em;
            padding: 5px 10px;
        }
        
        .add-order-button {
            background-color: var(--color-success);
            color: white;
            font-size: 0.8em;
            padding: 5px 10px;
        }
        
        .available-orders-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .order-edit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f8f8f8;
        }
        
        .order-edit-item:hover {
            background-color: #e0f7fa;
        }
        
        .order-edit-item.selected {
            background-color: #e8f5e9;
            border-left: 4px solid var(--color-success);
        }
        
        /* Modal de edici√≥n avanzada */
        .edit-advanced-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .edit-form-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .field-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .field-group {
            flex: 1;
            min-width: 200px;
        }
        
        .field-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-text);
        }
        
        .edit-modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--color-secondary);
        }
        
        .save-edit-button {
            background-color: var(--color-success);
            color: white;
            font-weight: bold;
            padding: 10px 25px;
        }
        
        .cancel-edit-button {
            background-color: var(--color-secondary);
            color: white;
            font-weight: bold;
            padding: 10px 25px;
        }
        
        .warning-section {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .warning-section h5 {
            color: #856404;
            margin-top: 0;
        }
        
        /* Tabs dentro de modales */
        .modal-tabs {
            overflow: hidden;
            border-bottom: 1px solid var(--color-secondary);
            margin-bottom: 20px;
        }
        
        .modal-tablinks {
            background-color: var(--color-bg);
            color: var(--color-text);
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
            font-size: 0.9em;
        }
        
        .modal-tablinks:hover {
            background-color: var(--color-primary);
        }
        
        .modal-tablinks.active {
            background-color: var(--color-primary);
            border-bottom: 3px solid var(--color-accent);
            margin-bottom: -1px;
        }
        
        .modal-tabcontent {
            display: none;
            padding: 15px 0;
        }
        
        /* Indicador de estado */
        .status-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-en-curso {
            background-color: var(--color-in-progress);
            color: #333;
        }
        
        .status-finalizada {
            background-color: var(--color-completed);
            color: white;
        }
        
        .status-certificada {
            background-color: var(--color-certification);
            color: white;
        }
        
        /* Estilos para la visualizaci√≥n de historial de cambios */
        .history-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .history-item {
            border-left: 3px solid #6c757d;
            padding-left: 10px;
            margin-bottom: 10px;
        }
        
        .history-date {
            font-weight: bold;
            color: #6c757d;
        }
        
        .history-action {
            color: var(--color-text);
        }

    </style>
</head>
<body>

    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tab">
            <!-- ID A√ëADIDO: new-order-tab-button -->
            <button class="tablinks" id="new-order-tab-button" onclick="openTab(event, 'new-order')">üìã Nueva Orden de Trabajo</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes en Curso</button>
            <button class="tablinks" onclick="openTab(event, 'completed-orders')">‚úÖ √ìrdenes Finalizadas</button>
            <button class="tablinks" onclick="openTab(event, 'companies')">üè¢ Empresas</button>
            <button class="tablinks" onclick="openTab(event, 'final-certification')">üìú Certificaci√≥n Final</button>
            <button class="tablinks" onclick="openTab(event, 'view-certifications')">üìã Certificaciones Finales</button>
            <!-- NUEVA PESTA√ëA: Edici√≥n Administrativa Avanzada -->
            <button class="tablinks" onclick="openTab(event, 'admin-edits')" id="admin-edits-tab" style="background-color: var(--color-admin); color: white;">üîß Edici√≥n Avanzada</button>
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Contenido de las Pesta√±as -->

        <!-- Pesta√±a 1: Creaci√≥n de Orden de Trabajo -->
        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <!-- Pesta√±a 2: Visualizaci√≥n de √ìrdenes de Trabajo en Curso -->
        <div id="view-orders" class="tabcontent">
            <h3>√ìrdenes de Trabajo en Curso</h3>
            
            <!-- SECCI√ìN: Exportaci√≥n a Excel -->
            <div class="export-section">
                <h4>üìä Exportaci√≥n a Excel</h4>
                <p>Exporte los datos de las √≥rdenes a formato Excel para an√°lisis y reportes.</p>
                <div class="export-buttons">
                    <button class="excel-button" onclick="exportToExcel('current')">
                        üìã Exportar Todas las √ìrdenes
                    </button>
                    <button class="excel-button-secondary" onclick="exportFilteredToExcel('current')">
                        üîç Exportar √ìrdenes Filtradas
                    </button>
                    <button class="excel-button-secondary" onclick="exportCurrentViewToExcel('current')">
                        üëÅÔ∏è Exportar Vista Actual
                    </button>
                </div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">
                    <strong>Tip:</strong> Use los filtros para refinar los datos antes de exportar.
                </p>
            </div>
            
            <!-- SECCI√ìN: Filtros de B√∫squeda -->
            <div class="filters-section">
                <h4>üîç Filtros de B√∫squeda</h4>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="filter-field">Campo a filtrar:</label>
                        <select id="filter-field" onchange="updateFilterInput()">
                            <option value="">Seleccionar campo...</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-operator">Tipo de filtro:</label>
                        <select id="filter-operator" onchange="updateFilterInput()">
                            <option value="contains">Contiene texto</option>
                            <option value="equals">Es igual a</option>
                            <option value="startsWith">Comienza con</option>
                            <option value="endsWith">Termina con</option>
                            <option value="range">Rango</option>
                            <option value="greater">Mayor que</option>
                            <option value="less">Menor que</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="filter-value-container">
                        <label for="filter-value">Valor:</label>
                        <input type="text" id="filter-value" placeholder="Texto a buscar...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-button" onclick="addFilter()">‚ûï Agregar Filtro</button>
                        <button class="filter-button" onclick="clearAllFilters()" style="background-color: var(--color-error);">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                
                <div id="active-filters" class="active-filters" style="display: none;">
                    <strong>Filtros activos:</strong>
                    <div id="active-filters-list"></div>
                </div>
            </div>
            
            <table id="orders-table">
                <thead>
                    <tr>
                        <th>Nro. OT</th>
                        <th>T√≠tulo</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div id="no-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                <p>No se encontraron √≥rdenes que coincidan con los filtros aplicados.</p>
            </div>
        </div>

        <!-- Pesta√±a 3: √ìrdenes Finalizadas -->
        <div id="completed-orders" class="tabcontent">
            <h3>√ìrdenes de Trabajo Finalizadas</h3>
            
            <!-- SECCI√ìN: Exportaci√≥n a Excel -->
            <div class="export-section">
                <h4>üìä Exportaci√≥n a Excel</h4>
                <p>Exporte los datos de las √≥rdenes finalizadas a formato Excel para an√°lisis y reportes.</p>
                <div class="export-buttons">
                    <button class="excel-button" onclick="exportToExcel('completed')">
                        üìã Exportar Todas las √ìrdenes
                    </button>
                    <button class="excel-button-secondary" onclick="exportFilteredToExcel('completed')">
                        üîç Exportar √ìrdenes Filtradas
                    </button>
                    <button class="excel-button-secondary" onclick="exportCurrentViewToExcel('completed')">
                        üëÅÔ∏è Exportar Vista Actual
                    </button>
                </div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">
                    <strong>Tip:</strong> Los archivos incluyen todos los campos de las √≥rdenes.
                </p>
            </div>
            
            <!-- SECCI√ìN: Filtro por Estado de Certificaci√≥n -->
            <div class="certification-filter-section">
                <h5>üîç Filtro por Estado de Certificaci√≥n</h5>
                <div class="certification-filter-buttons">
                    <button class="certification-filter-button active" onclick="setCertificationFilter('all')">
                        üìã Todas las √ìrdenes
                    </button>
                    <button class="certification-filter-button" onclick="setCertificationFilter('certified')">
                        ‚úÖ Solo Certificadas
                    </button>
                    <button class="certification-filter-button not-certified" onclick="setCertificationFilter('not-certified')">
                        ‚è≥ No Certificadas
                    </button>
                </div>
            </div>
            
            <!-- SECCI√ìN: Filtros para √ìrdenes Finalizadas -->
            <div class="filters-section">
                <h4>üîç Filtros de B√∫squeda</h4>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="completed-filter-field">Campo a filtrar:</label>
                        <select id="completed-filter-field" onchange="updateCompletedFilterInput()">
                            <option value="">Seleccionar campo...</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="completed-filter-operator">Tipo de filtro:</label>
                        <select id="completed-filter-operator" onchange="updateCompletedFilterInput()">
                            <option value="contains">Contiene texto</option>
                            <option value="equals">Es igual a</option>
                            <option value="startsWith">Comienza con</option>
                            <option value="endsWith">Termina con</option>
                            <option value="range">Rango</option>
                            <option value="greater">Mayor que</option>
                            <option value="less">Menor que</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="completed-filter-value-container">
                        <label for="completed-filter-value">Valor:</label>
                        <input type="text" id="completed-filter-value" placeholder="Texto a buscar...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-button" onclick="addCompletedFilter()">‚ûï Agregar Filtro</button>
                        <button class="filter-button" onclick="clearAllCompletedFilters()" style="background-color: var(--color-error);">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                
                <div id="completed-active-filters" class="active-filters" style="display: none;">
                    <strong>Filtros activos:</strong>
                    <div id="completed-active-filters-list"></div>
                </div>
            </div>
            
            <table id="completed-orders-table">
                <thead>
                    <tr>
                        <th>Nro. OT</th>
                        <th>T√≠tulo</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Fecha Finalizaci√≥n</th>
                        <th>Estado Certificaci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div id="no-completed-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                <p>No se encontraron √≥rdenes finalizadas.</p>
            </div>
        </div>

        <!-- Pesta√±a 4: Gesti√≥n de Empresas (Solo Admin) -->
        <div id="companies" class="tabcontent">
            <h3>üè¢ Gesti√≥n de Empresas</h3>
            
            <div id="company-management" style="display: none;">
                <!-- Formulario para agregar/editar empresa -->
                <div class="company-section">
                    <h4>üìù Agregar/Editar Empresa</h4>
                    <div class="company-form-container">
                        <div class="company-form-row">
                            <div class="company-form-field">
                                <label for="company-name">Nombre de la Empresa *</label>
                                <input type="text" id="company-name" placeholder="Ej: JERM TELECOMTRONICS TECHNOLOGY MULTISERVICES C.A" required>
                            </div>
                        </div>
                        
                        <div class="company-form-row">
                            <div class="company-form-field">
                                <label for="company-responsible">Apellido y Nombre del Responsable *</label>
                                <input type="text" id="company-responsible" placeholder="Ej: JOHN RIVAS" required>
                            </div>
                        </div>
                        
                        <div class="company-form-row">
                            <div class="company-form-field">
                                <label for="company-rif">RIF *</label>
                                <input type="text" id="company-rif" placeholder="Ej: J-50507058-4" required>
                            </div>
                        </div>
                        
                        <div class="company-form-row">
                            <div class="company-form-field">
                                <input type="hidden" id="company-id">
                                <button type="button" class="company-button" onclick="saveCompany()" id="save-company-btn">
                                    üíæ Guardar Empresa
                                </button>
                                <button type="button" onclick="clearCompanyForm()" style="background-color: var(--color-secondary); color: white;">
                                    üóëÔ∏è Limpiar Formulario
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de empresas existentes -->
                <div class="company-section">
                    <h4>üìã Empresas Registradas</h4>
                    <div id="companies-list">
                        <table id="companies-table">
                            <thead>
                                <tr>
                                    <th>Nombre de la Empresa</th>
                                    <th>Responsable</th>
                                    <th>RIF</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="companies-table-body">
                                <!-- Las empresas se cargar√°n din√°micamente aqu√≠ -->
                            </tbody>
                        </table>
                        
                        <div id="no-companies-message" class="no-companies-message" style="display: none;">
                            <p>üì≠ No hay empresas registradas.</p>
                            <p>Agregue una empresa usando el formulario superior.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="company-access-denied" style="text-align: center; padding: 40px; color: var(--color-error);">
                <h4>üö´ Acceso Restringido</h4>
                <p>Esta secci√≥n solo est√° disponible para administradores.</p>
            </div>
        </div>

        <!-- Pesta√±a 5: Certificaci√≥n Final -->
        <div id="final-certification" class="tabcontent">
            <h3>Certificaci√≥n Final</h3>
            
            <div class="certification-section">
                <h4>üìã Formulario de Certificaci√≥n Final</h4>
                <form id="final-certification-form">
                    <div class="form-section">
                        <h4>I. Informaci√≥n de la Certificaci√≥n</h4>
                        <p>
                            <label for="certification-title">T√≠tulo del Formulario:</label>
                            <input type="text" id="certification-title" value="Certificaci√≥n Final" disabled>
                        </p>
                        <p>
                            <label for="certification-number">N√∫mero de Certificaci√≥n Final:</label>
                            <input type="text" id="certification-number" disabled>
                        </p>
                        <p>
                            <label for="certification-year">A√±o:</label>
                            <input type="text" id="certification-year" disabled>
                        </p>
                    </div>
                    
                    <div class="form-section">
                        <h4>II. Informaci√≥n de la Empresa</h4>
                        <p>
                            <label for="certification-company">Empresa:</label>
                            <select id="certification-company" onchange="updateOrdersForCertification()" required>
                                <option value="">Seleccionar empresa...</option>
                            </select>
                        </p>
                    </div>
                    
                    <div class="form-section">
                        <h4>III. √ìrdenes Realizadas</h4>
                        <p>
                            <label for="certification-orders">√ìrdenes Realizadas:</label>
                            <div id="certification-orders-container" class="orders-checkbox-group" style="display: none;">
                                <!-- Las √≥rdenes se cargar√°n din√°micamente aqu√≠ -->
                            </div>
                            <div id="no-orders-message" style="display: none; color: var(--color-error); text-align: center; padding: 10px;">
                                No hay √≥rdenes finalizadas para esta empresa.
                            </div>
                            <div id="all-orders-certified-message" style="display: none; color: var(--color-warning); text-align: center; padding: 10px;">
                                Todas las √≥rdenes de esta empresa ya han sido certificadas en certificaciones finales anteriores.
                            </div>
                        </p>
                    </div>
                    
                    <div class="certification-total-section">
                        <h4>Total Certificaci√≥n</h4>
                        <div class="certification-total-display" id="certification-total">0.00</div>
                        <input type="hidden" id="certification-total-hidden" value="0.00">
                    </div>
                </form>
                
                <div class="certification-buttons">
                    <button class="certification-button" onclick="generateFinalCertification()">
                        ‚úÖ Aceptar Certificaci√≥n Final
                    </button>
                    <button onclick="clearCertificationForm()" style="background-color: var(--color-error); color: white;">
                        üóëÔ∏è Limpiar Formulario
                    </button>
                </div>
            </div>
        </div>

        <!-- Pesta√±a 6: Certificaciones Finales -->
        <div id="view-certifications" class="tabcontent">
            <h3>Certificaciones Finales</h3>
            
            <!-- SECCI√ìN: Exportaci√≥n a Excel -->
            <div class="export-section">
                <h4>üìä Exportaci√≥n a Excel</h4>
                <p>Exporte los datos de las certificaciones finales a formato Excel.</p>
                <div class="export-buttons">
                    <button class="excel-button" onclick="exportCertificationsToExcel()">
                        üìã Exportar Todas las Certificaciones
                    </button>
                </div>
            </div>
            
            <!-- SECCI√ìN: Filtros para Certificaciones Finales -->
            <div class="filters-section">
                <h4>üîç Filtros de B√∫squeda</h4>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="certification-filter-field">Campo a filtrar:</label>
                        <select id="certification-filter-field" onchange="updateCertificationFilterInput()">
                            <option value="">Seleccionar campo...</option>
                            <option value="N√∫mero de Certificaci√≥n Final">N√∫mero de Certificaci√≥n</option>
                            <option value="Empresa">Empresa</option>
                            <option value="Total">Total</option>
                            <option value="Fecha de Creaci√≥n">Fecha de Creaci√≥n</option>
                            <option value="A√±o">A√±o</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="certification-filter-operator">Tipo de filtro:</label>
                        <select id="certification-filter-operator" onchange="updateCertificationFilterInput()">
                            <option value="contains">Contiene texto</option>
                            <option value="equals">Es igual a</option>
                            <option value="startsWith">Comienza con</option>
                            <option value="endsWith">Termina con</option>
                            <option value="range">Rango</option>
                            <option value="greater">Mayor que</option>
                            <option value="less">Menor que</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="certification-filter-value-container">
                        <label for="certification-filter-value">Valor:</label>
                        <input type="text" id="certification-filter-value" placeholder="Texto a buscar...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-button" onclick="addCertificationFilter()">‚ûï Agregar Filtro</button>
                        <button class="filter-button" onclick="clearAllCertificationFilters()" style="background-color: var(--color-error);">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                
                <div id="certification-active-filters" class="active-filters" style="display: none;">
                    <strong>Filtros activos:</strong>
                    <div id="certification-active-filters-list"></div>
                </div>
            </div>
            
            <div id="certifications-list" class="certification-list">
                <!-- Las certificaciones se cargar√°n din√°micamente aqu√≠ -->
            </div>
            
            <div id="no-certifications-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                <p>No se encontraron certificaciones finales.</p>
            </div>
        </div>

        <!-- NUEVA PESTA√ëA 7: Edici√≥n Administrativa Avanzada -->
        <div id="admin-edits" class="tabcontent">
            <h3>üîß Edici√≥n Administrativa Avanzada</h3>
            <p style="color: var(--color-admin); font-weight: bold; margin-bottom: 20px;">
                ‚ö†Ô∏è Esta secci√≥n solo est√° disponible para administradores. Use con precauci√≥n.
                <br>Permite editar √≥rdenes y certificaciones en cualquier estado, incluso si ya est√°n certificadas.
            </p>
            
            <!-- SECCI√ìN: Edici√≥n de √ìrdenes en Curso -->
            <div class="admin-section">
                <h4>üìù Editar √ìrdenes en Curso</h4>
                <p>Edite los datos de las √≥rdenes de trabajo que est√°n en curso.</p>
                
                <div class="filters-section">
                    <h5>üîç Buscar Orden para Editar</h5>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label for="admin-edit-order-search">Buscar por N√∫mero OT:</label>
                            <input type="text" id="admin-edit-order-search" placeholder="Ej: (11-1)" onkeyup="searchOrderForEdit()">
                        </div>
                    </div>
                </div>
                
                <div id="admin-orders-edit-container">
                    <table id="admin-orders-edit-table">
                        <thead>
                            <tr>
                                <th>Nro. OT</th>
                                <th>T√≠tulo</th>
                                <th>Fecha Creaci√≥n</th>
                                <th>Empresa</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-orders-edit-tbody">
                            <!-- Las √≥rdenes se cargar√°n din√°micamente aqu√≠ -->
                        </tbody>
                    </table>
                    
                    <div id="no-orders-edit-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                        <p>No se encontraron √≥rdenes en curso para editar.</p>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN: Edici√≥n de √ìrdenes Finalizadas (Incluye certificadas) -->
            <div class="admin-section">
                <h4>‚úÖ Editar √ìrdenes Finalizadas (Incluye Certificadas)</h4>
                <p>Edite las √≥rdenes finalizadas, incluso si ya est√°n incluidas en certificaciones finales.</p>
                
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="admin-edit-completed-search">Buscar por N√∫mero OT:</label>
                        <input type="text" id="admin-edit-completed-search" placeholder="Ej: (11-1)" onkeyup="searchCompletedOrderForEdit()">
                    </div>
                </div>
                
                <div id="admin-completed-edit-container">
                    <table id="admin-completed-edit-table">
                        <thead>
                            <tr>
                                <th>Nro. OT</th>
                                <th>T√≠tulo</th>
                                <th>Fecha Finalizaci√≥n</th>
                                <th>Empresa</th>
                                <th>Importe</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-completed-edit-tbody">
                            <!-- Las √≥rdenes finalizadas se cargar√°n din√°micamente aqu√≠ -->
                        </tbody>
                    </table>
                    
                    <div id="no-completed-edit-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                        <p>No se encontraron √≥rdenes finalizadas para editar.</p>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN: Edici√≥n de Certificaciones Finales -->
            <div class="certification-edit-section">
                <h4>üìú Editar Certificaciones Finales</h4>
                <p>Modifique las certificaciones finales existentes: edite datos b√°sicos, agregue o elimine √≥rdenes.</p>
                
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="admin-edit-certification-search">Buscar Certificaci√≥n Final:</label>
                        <input type="text" id="admin-edit-certification-search" placeholder="Ej: (11-1)" onkeyup="searchCertificationForEdit()">
                    </div>
                </div>
                
                <div id="admin-certification-edit-container">
                    <div id="admin-certification-edit-list">
                        <!-- Las certificaciones para editar se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                    
                    <div id="no-certification-edit-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                        <p>No se encontraron certificaciones finales para editar.</p>
                    </div>
                </div>
            </div>
            
            <!-- NUEVA SECCI√ìN: Recalcular Totales de Certificaciones -->
            <div class="admin-section">
                <h4>üßÆ Recalcular Totales de Certificaciones</h4>
                <p>Si ha editado √≥rdenes certificadas, use esta herramienta para recalcular autom√°ticamente los totales de las certificaciones finales.</p>
                
                <div class="certification-buttons">
                    <button class="certification-button" onclick="recalculateAllCertificationTotals()">
                        üîÑ Recalcular Todos los Totales
                    </button>
                    <button class="certification-button" style="background-color: var(--color-warning);" onclick="showCertificationRecalculationReport()">
                        üìä Ver Reporte de Desajustes
                    </button>
                </div>
                
                <div id="recalculation-results" style="display: none; margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                    <!-- Los resultados del rec√°lculo se mostrar√°n aqu√≠ -->
                </div>
            </div>
        </div>

    </div>

    <!-- Modal para Certificaci√≥n de Obras -->
    <div id="certification-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="certification-title">Certificaci√≥n de Obras</h3>
            <form id="certification-form">
                <div class="form-section">
                    <h4>I. Datos de Certificaci√≥n</h4>
                    <p>
                        <label for="certification-number">N√∫mero de Certificaci√≥n:</label>
                        <input type="text" id="certification-number" disabled>
                    </p>
                    <p>
                        <label for="certification-date">Fecha de la Certificaci√≥n:</label>
                        <input type="text" id="certification-date" disabled>
                    </p>
                    <p>
                        <label for="certification-year">A√±o:</label>
                        <input type="text" id="certification-year" disabled>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>II. Identificaci√≥n</h4>
                    <p>
                        <label for="contractor-company">Empresa Contratista:</label>
                        <input type="text" id="contractor-company" disabled>
                    </p>
                    <p>
                        <label for="contractor-rif">Identificaci√≥n Fiscal RIF:</label>
                        <input type="text" id="contractor-rif" disabled>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>III. Informaci√≥n del Proyecto</h4>
                    <p>
                        <label for="work-order-reference">Corresponde Orden de trabajo N¬∞:</label>
                            <input type="text" id="work-order-reference" disabled>
                        </p>
                        <p>
                            <label for="start-date">Fechas de Inicio:</label>
                            <input type="date" id="start-date" required>
                        </p>
                        <p>
                            <label for="end-date">Fin de la Obra:</label>
                            <input type="date" id="end-date" required>
                        </p>
                    </div>
                    
                    <div class="form-section">
                        <h4>IV. Detalle de los trabajos realizados</h4>
                        <p>
                            <textarea id="work-details" required style="min-height: 120px;" placeholder="Describa detalladamente los trabajos realizados..."></textarea>
                        </p>
                        <p>
                            <label for="total-amount">Importe total de la obra:</label>
                            <input type="number" id="total-amount" step="0.01" min="0" required placeholder="0.00">
                        </p>
                    </div>
                    
                    <div class="form-section">
                        <h4>V. Desviaciones y Justificaci√≥n</h4>
                        <p>
                            <textarea id="deviations" style="min-height: 100px;" placeholder="Detalle de desviaciones respecto al plan original (Justificar y valorar en caso de existir)..."></textarea>
                        </p>
                    </div>
                    
                    <div class="form-section">
                        <h4>Firmas</h4>
                        <div style="display: flex; justify-content: space-between;">
                            <div style="width: 45%;">
                                <p><strong>Firma Jefe T√©cnico (Firma/Sello)</strong></p>
                                <div style="border-bottom: 1px solid #36454F; margin-top: 40px;"></div>
                            </div>
                            <div style="width: 45%;">
                                <p><strong>Firma Gerente T√©cnico (Firma/Sello)</strong></p>
                                <div style="border-bottom: 1px solid #36454F; margin-top: 40px;"></div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <div class="modal-actions">
                    <button class="modal-back-button" onclick="closeCertificationModal()">‚Üê Atr√°s</button>
                    <button class="modal-accept-button" onclick="completeWorkOrder()">‚úÖ Aceptar y Finalizar Orden</button>
                </div>
            </div>
        </div>

        <!-- Modal para Editar Orden en Curso -->
        <div id="edit-order-modal" class="modal-overlay" style="display: none;">
            <div class="edit-advanced-modal-content">
                <h3>‚úèÔ∏è Editar Orden de Trabajo en Curso</h3>
                <form id="edit-order-form">
                    <div id="edit-order-form-container"></div>
                </form>
                
                <div class="edit-modal-actions">
                    <button class="cancel-edit-button" onclick="closeEditOrderModal()">‚ùå Cancelar</button>
                    <button class="save-edit-button" onclick="saveEditedOrder()">üíæ Guardar Cambios</button>
                </div>
            </div>
        </div>

        <!-- Modal para Editar Orden Finalizada (Avanzado - Incluye certificadas) -->
        <div id="edit-completed-advanced-modal" class="modal-overlay" style="display: none;">
            <div class="edit-advanced-modal-content">
                <div class="modal-tabs">
                    <button class="modal-tablinks active" onclick="openModalTab(event, 'edit-order-basic')">üìã Datos B√°sicos</button>
                    <button class="modal-tablinks" onclick="openModalTab(event, 'edit-order-certification')">üìÑ Certificaci√≥n</button>
                    <button class="modal-tablinks" onclick="openModalTab(event, 'edit-order-history')">üìä Historial</button>
                    <button class="modal-tablinks" onclick="openModalTab(event, 'edit-order-impact')">‚ö†Ô∏è Impacto</button>
                </div>
                
                <div id="edit-order-basic" class="modal-tabcontent" style="display: block;">
                    <h3>‚úèÔ∏è Editar Orden Finalizada N¬∞ <span id="edit-order-number-display"></span></h3>
                    
                    <div class="warning-section" id="edit-certified-warning" style="display: none;">
                        <h5>‚ö†Ô∏è ADVERTENCIA: ORDEN CERTIFICADA</h5>
                        <p>Esta orden est√° incluida en la(s) siguiente(s) certificaci√≥n(es) final(es):</p>
                        <ul id="certification-list-warning"></ul>
                        <p><strong>Los cambios afectar√°n los totales de las certificaciones. Use la pesta√±a "Impacto" para ver detalles.</strong></p>
                    </div>
                    
                    <form id="edit-completed-advanced-form">
                        <div id="edit-completed-advanced-form-container"></div>
                    </form>
                </div>
                
                <div id="edit-order-certification" class="modal-tabcontent">
                    <h3>üìÑ Editar Certificaci√≥n de Obra</h3>
                    <div id="edit-order-certification-container"></div>
                </div>
                
                <div id="edit-order-history" class="modal-tabcontent">
                    <h3>üìä Historial de Cambios</h3>
                    <div class="history-section" id="edit-order-history-container">
                        <!-- El historial se cargar√° aqu√≠ -->
                    </div>
                </div>
                
                <div id="edit-order-impact" class="modal-tabcontent">
                    <h3>‚ö†Ô∏è Impacto de los Cambios</h3>
                    <div class="warning-section" id="edit-order-impact-container">
                        <!-- El impacto se calcular√° y mostrar√° aqu√≠ -->
                    </div>
                </div>
                
                <div class="edit-modal-actions">
                    <button class="cancel-edit-button" onclick="closeEditCompletedAdvancedModal()">‚ùå Cancelar</button>
                    <button class="save-edit-button" onclick="saveEditedCompletedOrderAdvanced()">üíæ Guardar Todos los Cambios</button>
                </div>
            </div>
        </div>

        <!-- Modal para Editar Certificaci√≥n Final (Avanzado) -->
        <div id="edit-certification-advanced-modal" class="modal-overlay" style="display: none;">
            <div class="edit-advanced-modal-content">
                <div class="modal-tabs">
                    <button class="modal-tablinks active" onclick="openModalTab(event, 'edit-cert-basic')">üìã Datos B√°sicos</button>
                    <button class="modal-tablinks" onclick="openModalTab(event, 'edit-cert-orders')">üìä √ìrdenes</button>
                    <button class="modal-tablinks" onclick="openModalTab(event, 'edit-cert-total')">üí∞ Total</button>
                </div>
                
                <div id="edit-cert-basic" class="modal-tabcontent" style="display: block;">
                    <h3>‚úèÔ∏è Editar Certificaci√≥n Final N¬∞ <span id="edit-cert-number-display"></span></h3>
                    
                    <form id="edit-certification-advanced-form">
                        <div id="edit-certification-advanced-form-container"></div>
                    </form>
                </div>
                
                <div id="edit-cert-orders" class="modal-tabcontent">
                    <h3>üìä Gesti√≥n de √ìrdenes en la Certificaci√≥n</h3>
                    <div id="edit-certification-orders-container"></div>
                </div>
                
                <div id="edit-cert-total" class="modal-tabcontent">
                    <h3>üí∞ Recalcular Total</h3>
                    <div id="edit-certification-total-container"></div>
                </div>
                
                <div class="edit-modal-actions">
                    <button class="cancel-edit-button" onclick="closeEditCertificationAdvancedModal()">‚ùå Cancelar</button>
                    <button class="save-edit-button" onclick="saveEditedCertificationAdvanced()">üíæ Guardar Cambios</button>
                </div>
            </div>
        </div>

        <script>
            // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
            
            // ** CONFIGURACI√ìN DE FIREBASE ACTUALIZADA **
            const firebaseConfig = {
                apiKey: "AIzaSyD8kNT9Fx_nTWh6PPu5zol5K8uzjrSQ0HY",
                authDomain: "certificacionordenes.firebaseapp.com",
                databaseURL: "https://certificacionordenes-default-rtdb.firebaseio.com",
                projectId: "certificacionordenes",
                storageBucket: "certificacionordenes.firebasestorage.app",
                messagingSenderId: "1031284418081",
                appId: "1:1031284418081:web:7e921d43798a305756a560"
            };
            
            // Verificar si Firebase ya est√° inicializado
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();
            
            // Referencias a las "colecciones" de la base de datos
            const ORDERS_COLLECTION = db.collection("workOrders");
            const COMPLETED_ORDERS_COLLECTION = db.collection("completedWorkOrders");
            const CONFIG_COLLECTION = db.collection("config"); 
            const FINAL_CERTIFICATIONS_COLLECTION = db.collection("finalCertifications");
            const COMPANIES_COLLECTION = db.collection("companies");
            const CHANGE_HISTORY_COLLECTION = db.collection("changeHistory"); // Nueva colecci√≥n para historial
            
            // Variables de estado
            let formStructure = null; 
            let workOrders = []; 
            let completedOrders = [];
            let finalCertifications = [];
            let companies = [];
            let changeHistory = [];
            let otCounter = 1; 
            let finalCertificationCounter = 1;
            let currentRole = null; 
            let activeFilters = [];
            let completedActiveFilters = [];
            let certificationActiveFilters = [];
            let currentOrderForCertification = null;
            let certificationFilter = 'all';
            let editingCompanyId = null;
            
            // Variables para edici√≥n avanzada
            let editingOrderId = null;
            let editingCompletedOrderId = null;
            let editingCertificationId = null;
            let currentEditingOrder = null;
            let currentEditingCompletedOrder = null;
            let currentEditingCertification = null;
            let editingOrderOriginalData = null;
            let editingCertificationOriginalData = null;

            // ----------------------------------------------------------------------------------
            // *** CONFIGURACI√ìN DE ROLES CON M√öLTIPLES CORREOS (LISTAS/ARRAYS) ***
            // ----------------------------------------------------------------------------------

            // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de administrador
            const ADMIN_EMAILS = [
                'labortradingsg@gmail.com',
                'jesus.longa@inter.com.ve' // Otro administrador de ejemplo
            ]; 

            // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de solo visualizaci√≥n
            const VIEWER_EMAILS = [
                'visualizador1@empresa.com',
                'visualizador2@empresa.com',
                'solo.ver@tudominio.com'
            ]; 

            // ----------------------------------------------------------------------------------
            // *** FIN CONFIGURACI√ìN DE ROLES ***
            // ----------------------------------------------------------------------------------
            
            // *** NUEVA ESTRUCTURA FIJA DEL FORMULARIO - NOMBRES DE CAMPOS CORREGIDOS ***
            const FIXED_FORM_STRUCTURE = [
                { 
                    title: "I. Informaci√≥n General", 
                    fields: [
                        { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                        { id: "ot_number", label: "Orden de Trabajo", type: "ot_counter", required: true },
                        { id: "user_auto_fill", label: "Usuario que Crea la Orden", type: "user-auto-fill", required: true },
                        { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true },
                        { id: "current_year", label: "A√±o", type: "year-auto", required: true },
                        { id: "trabajo_obra", label: "Trabajo Obra a realizar", type: "select", required: true, 
                          options: ["Construcci√≥n de Acometida", "Construcci√≥n Nodo Acceso", "Construcci√≥n ISP", "Construcci√≥n Feeder (Pedestales - Zanjados - Tanquillas - Instalaci√≥n de Postes)", "Mantenimiento de Red", "Relevamiento"] },
                        { id: "municipio", label: "Municipio", type: "select", required: true, 
                          options: ["Libertador", "Sucre", "Baruta", "Chacao", "El Hatillo"] },
                        { id: "zona", label: "Zona", type: "text", required: true },
                        { id: "responsable_solicita", label: "Responsable que Solicita la Obra", type: "text", required: true },
                        { id: "responsable_autoriza", label: "Responsable que Autoriza", type: "text", required: true },
                        { id: "tipo_contrato", label: "Tipo de Contrato", type: "select", required: true, 
                          options: ["Acometidas", "Nodo de Acceso", "Relevamiento", "Desmantelado"] }
                    ]
                },
                { 
                    title: "II. Informaci√≥n de la Contratista", 
                    fields: [
                        { id: "empresa", label: "Empresa", type: "autofill-select", required: true },
                        { id: "responsable", label: "Apellido y Nombre del Responsable", type: "text", required: true },
                        { id: "rif", label: "Rif", type: "text", required: true }
                    ]
                },
                { 
                    title: "III. Informaci√≥n del Trabajo Obra", 
                    fields: [
                        { id: "descripcion_detallada", label: "Descripci√≥n Detallada", type: "textarea", required: true },
                        { id: "mano_obra", label: "Mano de Obra", type: "select", required: true, 
                          options: ["Contratista", "Inter", "Ambos (Contratista - Inter)"] },
                        { id: "materiales", label: "Materiales", type: "select", required: true, 
                          options: ["Contratista", "Inter"] },
                        { id: "equipos", label: "Equipos", type: "select", required: true, 
                          options: ["Contratista", "Inter"] },
                        { id: "fecha_inicio", label: "Fecha de inicio", type: "date-input", required: true },
                        { id: "fecha_finalizacion", label: "Fecha de Finalizaci√≥n", type: "date-input", required: true },
                        { id: "ubicacion_exacta", label: "Ubicaci√≥n Exacta de la Obra", type: "textarea", required: true },
                        { id: "presupuesto_total", label: "Presupuesto Total de la Obra", type: "number", required: true }
                    ]
                }
            ];

            // *** FUNCI√ìN AUXILIAR MEJORADA PARA EXTRAER A√ëO DE FECHA ***
            function extractYearFromDate(dateString) {
                if (!dateString) return getCurrentCaracasYear();
                
                // Formato DD/MM/YYYY
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        const year = parseInt(parts[2]);
                        if (!isNaN(year) && year > 2000 && year < 2100) {
                            return year;
                        }
                    }
                }
                
                // Formato YYYY-MM-DD
                if (dateString.includes('-')) {
                    const parts = dateString.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        if (!isNaN(year) && year > 2000 && year < 2100) {
                            return year;
                        }
                    }
                }
                
                // Por defecto, a√±o actual
                return getCurrentCaracasYear();
            }

            // *** NUEVA FUNCI√ìN: Obtener el mes actual en zona horaria de Caracas ***
            function getCurrentCaracasMonth() {
                const now = new Date();
                const caracasOffset = -4 * 60;
                const localOffset = now.getTimezoneOffset();
                const caracasTime = new Date(now.getTime() + (localOffset - caracasOffset) * 60000);
                
                return String(caracasTime.getMonth() + 1).padStart(2, '0'); // Mes en formato 01-12
            }

            // *** FUNCI√ìN DE LOGIN - DEFINIDA AL INICIO ***
            async function login() {
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                const errorElement = document.getElementById('login-error');
                errorElement.textContent = '';
                
                try {
                    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
                    const user = userCredential.user;
                    
                    let role = getRoleFromEmail(user.email); 
                    
                    currentRole = role;
                    
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    initializeApp(role);
                    
                } catch (error) {
                    console.error("Error de autenticaci√≥n:", error.code, error.message);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        errorElement.textContent = 'Credenciales incorrectas o usuario no encontrado.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorElement.textContent = 'El formato del correo es inv√°lido.';
                    } else if (error.code === 'auth/api-key-not-valid') {
                        errorElement.textContent = 'ERROR DE CONFIGURACI√ìN: La Clave API de Firebase no es v√°lida. Por favor, verifique la configuraci√≥n de Firebase en el c√≥digo.';
                    } else {
                        errorElement.textContent = 'Error de conexi√≥n. Intente de nuevo.';
                    }
                }
            }

            // *** FUNCI√ìN DE LOGOUT ***
            function logout() {
                firebase.auth().signOut().then(() => {
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                    alert('Sesi√≥n cerrada correctamente.');
                }).catch((error) => {
                    console.error("Error al cerrar sesi√≥n:", error);
                    alert('Error al cerrar sesi√≥n.');
                });
            }

            // *** 2. L√ìGICA DE FIREBASE: CARGA Y GUARDADO ***

            async function loadInitialData() {
                try {
                    console.log("üîç Iniciando carga de datos...");
                    
                    // Verificar autenticaci√≥n primero
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        throw new Error("Usuario no autenticado");
                    }
                    
                    console.log("‚úÖ Usuario autenticado:", user.email);

                    // Cargar Estructura del Formulario y Contador
                    console.log("üìã Cargando configuraci√≥n...");
                    const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                    
                    if (configDoc.exists) {
                        console.log("‚úÖ Configuraci√≥n encontrada");
                        const data = configDoc.data();
                        formStructure = FIXED_FORM_STRUCTURE;
                        otCounter = data.otCounter || 1;
                        finalCertificationCounter = data.finalCertificationCounter || 1;
                    } else {
                        console.log("‚ö†Ô∏è Configuraci√≥n no encontrada, usando valores por defecto");
                        formStructure = FIXED_FORM_STRUCTURE;
                        await saveFormStructure(true); 
                    }
                    
                    // Cargar Empresas desde Firebase
                    console.log("üè¢ Cargando empresas...");
                    await loadCompanies();
                    
                    // Cargar Historial de Cambios
                    console.log("üìú Cargando historial de cambios...");
                    await loadChangeHistory();
                    
                    // Cargar √ìrdenes de Trabajo EN CURSO
                    console.log("üìÇ Cargando √≥rdenes en curso...");
                    const ordersSnapshot = await ORDERS_COLLECTION.get();
                    workOrders = ordersSnapshot.docs.map(doc => {
                        const data = doc.data();
                        // Convertir nombres de campos antiguos a nuevos si es necesario
                        const convertedData = convertFieldNamesForCompatibility(data);
                        return { id: doc.id, ...convertedData };
                    });
                    workOrders = sortOrdersByNumberDescending(workOrders);
                    console.log(`‚úÖ ${workOrders.length} √≥rdenes en curso cargadas y ordenadas`);

                    // Cargar √ìrdenes de Trabajo FINALIZADAS
                    console.log("‚úÖ Cargando √≥rdenes finalizadas...");
                    const completedSnapshot = await COMPLETED_ORDERS_COLLECTION.get();
                    completedOrders = completedSnapshot.docs.map(doc => {
                        const data = doc.data();
                        // Convertir nombres de campos antiguos a nuevos si es necesario
                        const convertedData = convertFieldNamesForCompatibility(data);
                        return { id: doc.id, ...convertedData };
                    });
                    completedOrders = sortOrdersByNumberDescending(completedOrders);
                    console.log(`‚úÖ ${completedOrders.length} √≥rdenes finalizadas cargadas y ordenadas`);

                    // Cargar Certificaciones Finales
                    console.log("üìú Cargando certificaciones finales...");
                    const certificationsSnapshot = await FINAL_CERTIFICATIONS_COLLECTION.get();
                    finalCertifications = certificationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`‚úÖ ${finalCertifications.length} certificaciones finales cargadas`);

                    // Asegurar que los contadores est√©n correctos al inicio
                    recalculateOtCounter();
                    recalculateFinalCertificationCounter();
                    console.log("üéØ Contador actualizado:", otCounter);
                    console.log("üéØ Contador certificaciones finales:", finalCertificationCounter);

                    console.log("üöÄ Carga de datos completada exitosamente");

                } catch (error) {
                    console.error("‚ùå Error cargando datos iniciales: ", error);
                    console.error("C√≥digo del error:", error.code);
                    console.error("Mensaje del error:", error.message);
                    
                    let errorMessage = "Error al conectar con la base de datos. ";
                    
                    if (error.code === 'permission-denied') {
                        errorMessage += "ERROR DE PERMISOS: Configure las reglas de seguridad de Firestore para permitir acceso a usuarios autenticados.";
                    } else if (error.code === 'unavailable') {
                        errorMessage += "Error de conexi√≥n a internet.";
                    } else if (error.message.includes("no autenticado")) {
                        errorMessage += "Usuario no autenticado correctamente.";
                    } else {
                        errorMessage += `Detalles: ${error.message}`;
                    }
                    
                    alert(errorMessage);
                    throw error;
                }
            }

            async function loadChangeHistory() {
                try {
                    const historySnapshot = await CHANGE_HISTORY_COLLECTION.get();
                    changeHistory = historySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`‚úÖ ${changeHistory.length} registros de historial cargados`);
                } catch (error) {
                    console.error("‚ùå Error cargando historial de cambios:", error);
                    changeHistory = [];
                }
            }

            async function logChangeHistory(action, entityType, entityId, entityName, changes, userId) {
                try {
                    const historyEntry = {
                        action: action,
                        entityType: entityType,
                        entityId: entityId,
                        entityName: entityName,
                        changes: changes,
                        userId: userId || (firebase.auth().currentUser ? firebase.auth().currentUser.email : 'system'),
                        timestamp: new Date().toISOString(),
                        date: getCurrentCaracasDate(),
                        time: new Date().toLocaleTimeString('es-VE')
                    };
                    
                    await CHANGE_HISTORY_COLLECTION.add(historyEntry);
                    changeHistory.push(historyEntry);
                    
                    console.log(`üìù Historial registrado: ${action} en ${entityType} ${entityName}`);
                } catch (error) {
                    console.error("‚ùå Error registrando historial:", error);
                }
            }

            // *** FUNCI√ìN PARA CONVERTIR NOMBRES DE CAMPOS ANTIGUOS A NUEVOS ***
            function convertFieldNamesForCompatibility(data) {
                const fieldMappings = {
                    'Trabajo / Obra a realizar': 'Trabajo Obra a realizar',
                    'Trabajo  Obra a realizar': 'Trabajo Obra a realizar'
                };
                
                const convertedData = { ...data };
                
                Object.keys(fieldMappings).forEach(oldField => {
                    if (convertedData.hasOwnProperty(oldField)) {
                        const newField = fieldMappings[oldField];
                        convertedData[newField] = convertedData[oldField];
                        delete convertedData[oldField];
                    }
                });
                
                return convertedData;
            }
            
            async function loadCompanies() {
                try {
                    const companiesSnapshot = await COMPANIES_COLLECTION.get();
                    companies = companiesSnapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    companies.sort((a, b) => a.name.localeCompare(b.name));
                    
                    console.log(`‚úÖ ${companies.length} empresas cargadas`);
                    return companies;
                } catch (error) {
                    console.error("‚ùå Error cargando empresas:", error);
                    companies = [];
                    return [];
                }
            }
            
            async function saveFormStructure(initial = false) {
                try {
                    await CONFIG_COLLECTION.doc("systemConfig").set({
                        formStructure: FIXED_FORM_STRUCTURE,
                        otCounter: otCounter,
                        finalCertificationCounter: finalCertificationCounter
                    }, { merge: true });

                    if (!initial) {
                         alert('üéâ Contador guardado exitosamente en la nube.');
                         renderWorkOrderForm();
                    }
                } catch (e) {
                    console.error("Error al guardar la estructura:", e);
                    alert("Error al guardar en Firebase.");
                }
            }
            
            function getRoleFromEmail(email) {
                if (ADMIN_EMAILS.includes(email)) {
                    return 'admin';
                } 
                else if (VIEWER_EMAILS.includes(email)) { 
                    return 'viewer'; 
                } 
                else {
                    return 'normal'; 
                }
            }

            async function initializeApp(role) {
                try {
                    console.log("üîê Inicializando app para rol:", role);
                    
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        throw new Error("Usuario no autenticado durante inicializaci√≥n");
                    }
                    
                    const isCreator = (role === 'admin' || role === 'normal');

                    document.getElementById('new-order-tab-button').style.display = isCreator ? 'inline-block' : 'none';
                    document.getElementById('admin-edits-tab').style.display = (role === 'admin') ? 'inline-block' : 'none';
                    
                    await loadInitialData(); 
                    
                    if (role === 'admin' || role === 'normal') {
                        openTab(null, 'new-order');
                    } else if (role === 'viewer') {
                        openTab(null, 'view-orders'); 
                    }
                    
                    renderWorkOrderForm();
                    renderOrdersTable();
                    renderCompletedOrdersTable();
                    renderCompaniesTable();
                    renderFinalCertificationForm();
                    renderFinalCertificationsList();
                    renderAdminEditTables();
                    
                    console.log("‚úÖ App inicializada correctamente");
                    
                } catch (error) {
                    console.error("‚ùå Error en initializeApp:", error);
                    alert("Error al inicializar la aplicaci√≥n: " + error.message);
                    logout();
                }
            }

            window.onload = function() {
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        let role = getRoleFromEmail(user.email); 
                        currentRole = role;
                        
                        document.getElementById('login-view').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        initializeApp(role);
                    } else {
                        currentRole = null;
                        document.getElementById('main-app').style.display = 'none';
                        document.getElementById('login-view').style.display = 'block';
                    }
                });
            }
            
            function openTab(evt, tabName) {
                let i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabContent = tabcontent[i];
                    tabContent.style.display = "none";
                    tabContent.classList.remove("active-tab");
                }
                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                const selectedTab = document.getElementById(tabName);
                selectedTab.style.display = "block";
                selectedTab.classList.add("active-tab");
                if (evt) evt.currentTarget.className += " active";

                if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
                else if (tabName === 'view-orders') {
                    renderOrdersTable();
                    initializeFilters();
                }
                else if (tabName === 'completed-orders') {
                    renderCompletedOrdersTable();
                    initializeCompletedFilters();
                }
                else if (tabName === 'companies') {
                    renderCompaniesTable();
                }
                else if (tabName === 'final-certification') {
                    renderFinalCertificationForm();
                }
                else if (tabName === 'view-certifications') {
                    renderFinalCertificationsList();
                    initializeCertificationFilters();
                }
                else if (tabName === 'admin-edits') {
                    renderAdminEditTables();
                }
            }

            function openModalTab(evt, tabName) {
                let i, tabcontent, tablinks;
                const modal = evt.currentTarget.closest('.modal-overlay');
                
                tabcontent = modal.querySelectorAll(".modal-tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                
                tablinks = modal.querySelectorAll(".modal-tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
            }

            // *** 5. L√ìGICA DE CREACI√ìN DE ORDEN DE TRABAJO ***
            
            function formatDateToDDMMYYYY(dateString) {
                if (!dateString) return 'N/A';
                
                if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    return dateString;
                }

                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const [year, month, day] = parts;
                    return `${day}/${month}/${year}`;
                }

                return dateString;
            }

            function getCurrentCaracasDate() {
                const now = new Date();
                const caracasOffset = -4 * 60;
                const localOffset = now.getTimezoneOffset();
                const caracasTime = new Date(now.getTime() + (localOffset - caracasOffset) * 60000);
                
                const day = String(caracasTime.getDate()).padStart(2, '0');
                const month = String(caracasTime.getMonth() + 1).padStart(2, '0');
                const year = caracasTime.getFullYear();
                
                return `${day}/${month}/${year}`;
            }
            
            function getCurrentCaracasYear() {
                const now = new Date();
                const caracasOffset = -4 * 60;
                const localOffset = now.getTimezoneOffset();
                const caracasTime = new Date(now.getTime() + (localOffset - caracasOffset) * 60000);
                
                return caracasTime.getFullYear();
            }
            
            function autofillContratistaData(selectElement) {
                const selectedCompanyName = selectElement.value;
                
                if (!selectedCompanyName) {
                    document.getElementById('responsable').value = '';
                    document.getElementById('rif').value = '';
                    return;
                }

                const company = companies.find(c => c.name === selectedCompanyName);
                
                if (!company) {
                    document.getElementById('responsable').value = '';
                    document.getElementById('rif').value = '';
                    return;
                }

                const responsibleField = document.getElementById('responsable');
                const rifField = document.getElementById('rif');

                if (responsibleField && company.responsible) {
                    responsibleField.value = company.responsible;
                }
                if (rifField && company.rif) {
                    rifField.value = company.rif;
                }
            }

            function calculateNewTotal(prefix) {
                try {
                    const precioUnitario = parseFloat(
                        (document.getElementById(`${prefix}_precio_unitario`).value || '0')
                        .replace(',', '.')
                    ) || 0;
                    
                    const puntos = parseFloat(
                        (document.getElementById(`${prefix}_puntos`).value || '0')
                        .replace(',', '.')
                    ) || 0;
                    
                    const total = precioUnitario * puntos;
                    
                    const totalDisplay = document.getElementById(`${prefix}_total_display`);
                    const totalHidden = document.getElementById(`${prefix}_total_hidden`);
                    
                    if (totalDisplay) totalDisplay.textContent = total.toFixed(2);
                    if (totalHidden) totalHidden.value = total.toFixed(2);
                    
                    const precioUnitario1 = parseFloat(
                        (document.getElementById(`${prefix}_precio_unitario1`).value || '0')
                        .replace(',', '.')
                    ) || 0;
                    
                    const puntos1 = parseFloat(
                        (document.getElementById(`${prefix}_puntos1`).value || '0')
                        .replace(',', '.')
                    ) || 0;
                    
                    const total1 = precioUnitario1 * puntos1;
                    
                    const totalDisplay1 = document.getElementById(`${prefix}_total_display1`);
                    const totalHidden1 = document.getElementById(`${prefix}_total_hidden1`);
                    
                    if (totalDisplay1) totalDisplay1.textContent = total1.toFixed(2);
                    if (totalHidden1) totalHidden1.value = total1.toFixed(2);
                    
                } catch (error) {
                    console.error('Error en calculateNewTotal:', error);
                }
            }

            function toggleConditionalSection(type) {
                try {
                    const nodeAccessSection = document.getElementById('conditional_node_acceso_section');
                    const ispSection = document.getElementById('conditional_isp_section');
                    const nodeAccessButton = document.getElementById('check_node_acceso');
                    const ispButton = document.getElementById('check_isp');

                    if (!nodeAccessSection || !ispSection || !nodeAccessButton || !ispButton) {
                        console.error('Elementos de secci√≥n condicional no encontrados');
                        return;
                    }

                    nodeAccessSection.style.display = 'none';
                    ispSection.style.display = 'none';
                    nodeAccessButton.classList.remove('active');
                    ispButton.classList.remove('active');
                    
                    const fieldsToReset = ['costo_proyectado', 'precio_unitario', 'puntos', 'precio_unitario1', 'puntos1', 'descripcion', 'abono_mensual'];
                    const selectsToReset = ['pago_por_realizado'];

                    ['node_acceso', 'isp'].forEach(prefix => {
                        fieldsToReset.forEach(field => {
                            const el = document.getElementById(`${prefix}_${field}`);
                            if (el) el.value = '';
                        });
                        selectsToReset.forEach(field => {
                            const el = document.getElementById(`${prefix}_${field}`);
                            if (el) el.value = 'Inter';
                        });
                        
                        const totalDisplay = document.getElementById(`${prefix}_total_display`);
                        const totalDisplay1 = document.getElementById(`${prefix}_total_display1`);
                        const totalHidden = document.getElementById(`${prefix}_total_hidden`);
                        const totalHidden1 = document.getElementById(`${prefix}_total_hidden1`);
                        
                        if (totalDisplay) totalDisplay.textContent = '0.00';
                        if (totalDisplay1) totalDisplay1.textContent = '0.00';
                        if (totalHidden) totalHidden.value = '0.00';
                        if (totalHidden1) totalHidden1.value = '0.00';
                    });

                    if (type === 'node_acceso') {
                        nodeAccessSection.style.display = 'block';
                        nodeAccessButton.classList.add('active');
                    } else if (type === 'isp') {
                        ispSection.style.display = 'block';
                        ispButton.classList.add('active');
                    }
                } catch (error) {
                    console.error('Error en toggleConditionalSection:', error);
                }
            }

            function renderWorkOrderForm() {
                const formElement = document.getElementById('work-order-form');
                formElement.innerHTML = '';
                const todayCaracas = getCurrentCaracasDate(); 
                const currentYear = getCurrentCaracasYear();
                const currentMonth = getCurrentCaracasMonth();
                const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'USUARIO NO LOGUEADO';

                if (!formStructure) {
                     formElement.innerHTML = '<p>Cargando estructura del formulario...</p>';
                     return;
                }
                
                formStructure.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'form-section';
                    sectionDiv.innerHTML = `<h4>${section.title}</h4>`;

                    section.fields.forEach(field => {
                        const requiredStar = field.required ? '<span style="color: var(--color-error); margin-left: 5px;">*</span>' : '';
                        let inputHTML = '';
                        let value = '';
                        let isDisabled = '';
                        let onChangeEvent = '';
                        let isAutofillField = false;

                        if (section.title.includes('II. Informaci√≥n de la Contratista')) {
                            const autofillKeys = ["responsable", "rif"];
                            if (autofillKeys.includes(field.id)) {
                                isDisabled = 'disabled';
                                isAutofillField = true;
                            } else if (field.type === 'autofill-select') {
                                onChangeEvent = `onchange="autofillContratistaData(this)"`;
                            }
                        }

                        const fieldId = field.id;
                        
                        const isFixedField = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill' || field.type === 'year-auto';
                        const requiredAttribute = field.required && !isFixedField ? 'required' : '';

                        switch (field.type) {
                            case 'static':
                                value = field.value;
                                inputHTML = `<input type="text" value="${value}" disabled>`;
                                break;
                            case 'ot_counter':
                                value = `(${currentMonth}-${otCounter})`;
                                inputHTML = `<input type="text" value="${value}" disabled>`;
                                break;
                            case 'user-auto-fill':
                                value = currentUserEmail;
                                inputHTML = `<input type="text" value="${value}" disabled>`;
                                break;
                            case 'date-auto':
                                value = todayCaracas;
                                inputHTML = `<input type="text" value="${value}" disabled>`; 
                                break;
                            case 'year-auto':
                                value = currentYear;
                                inputHTML = `<input type="text" value="${value}" disabled>`;
                                break;
                            case 'date-input':
                                inputHTML = `<input type="date" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`;
                                break;
                            case 'text':
                            case 'number':
                                if (field.label === 'Presupuesto Total de la Obra') {
                                    inputHTML = `<input type="number" id="${fieldId}" name="${fieldId}" step="0.01" min="0" max="9999999999.99" placeholder="0.00" ${requiredAttribute} ${isDisabled} oninput="validatePresupuestoTotal(this)">`;
                                } else {
                                    inputHTML = `<input type="${field.type}" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`;
                                }
                                break;
                            case 'textarea':
                                inputHTML = `<textarea id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} style="min-height: 100px;"></textarea>`;
                                break;
                            case 'select':
                                inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>`;
                                break;
                            case 'autofill-select': 
                                const optionsHTML = '<option value="">Seleccionar empresa...</option>' + 
                                    companies.map(company => `<option value="${company.name}">${company.name}</option>`).join('');
                                inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                    ${optionsHTML}
                                </select>`;
                                break;
                        }

                        sectionDiv.innerHTML += `<p><label for="${fieldId}">${field.label}${requiredStar}:</label>${inputHTML}</p>`;
                    });
                    formElement.appendChild(sectionDiv);
                });
                
                formElement.innerHTML += `
                    <h4>Secciones Opcionales de Construcci√≥n</h4>
                    <p><em>Complete solo si aplica a su tipo de trabajo</em></p>
                    <button type="button" class="conditional-check" id="check_node_acceso" onclick="toggleConditionalSection('node_acceso')">
                        üì° Datos Espec√≠ficos para Construcci√≥n de Nodo de Acceso
                    </button>
                    <button type="button" class="conditional-check" id="check_isp" onclick="toggleConditionalSection('isp')">
                        üåê Datos Espec√≠ficos para Construcci√≥n de ISP
                    </button>
                    <button type="button" style="background-color: var(--color-error); color: var(--color-white); margin-top: 15px;" onclick="toggleConditionalSection(null)">
                        ‚ùå Ocultar Secciones Opcionales
                    </button>
                `;
                
                formElement.innerHTML += renderConditionalSection('node_acceso', 'Datos Espec√≠ficos: Construcci√≥n de Nodo de Acceso');
                formElement.innerHTML += renderConditionalSection('isp', 'Datos Espec√≠ficos: Construcci√≥n de ISP');
                
                toggleConditionalSection(null);
                
                const autofillSelects = document.querySelectorAll('select[onchange="autofillContratistaData(this)"]');
                autofillSelects.forEach(select => autofillContratistaData(select));
            }

            function validatePresupuestoTotal(input) {
                const value = parseFloat(input.value);
                const maxValue = 9999999999.99;
                
                if (value > maxValue) {
                    input.setCustomValidity(`El valor m√°ximo permitido es ${maxValue.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    input.reportValidity();
                } else {
                    input.setCustomValidity('');
                }
            }

            function renderConditionalSection(prefix, title) {
                const onChangeFunc = `calculateNewTotal('${prefix}')`;
                
                return `
                    <div class="form-section" id="conditional_${prefix}_section" style="display: none;">
                        <h4>${title}</h4>
                        
                        <p><label for="${prefix}_costo_proyectado">Costo Proyectado de la Obra (*):</label>
                            <input type="text" id="${prefix}_costo_proyectado" name="${prefix}_costo_proyectado" required></p>
                        
                        <p><label for="${prefix}_pago_por_realizado">Pago realizado por (*):</label>
                            <select id="${prefix}_pago_por_realizado" name="${prefix}_pago_por_realizado" required>
                                <option value="Inter">Inter</option>
                                <option value="Cliente">Cliente</option>
                            </select></p>
                            
                        <hr>
                        
                        <!-- SECCI√ìN CANTV -->
                        <h5>Pago x VGT CANTV</h5>
                        <div class="calculation-group">
                            <label for="${prefix}_precio_unitario">Precio Unitario (*):</label>
                            <input type="number" step="0.01" min="0" id="${prefix}_precio_unitario" name="${prefix}_precio_unitario" placeholder="0.00" oninput="${onChangeFunc}" class="calculation-input" required>
                            
                            <span class="formula-symbol">X</span>
                            
                            <label for="${prefix}_puntos">Puntos (*):</label>
                            <input type="number" step="1" min="0" id="${prefix}_puntos" name="${prefix}_puntos" placeholder="0" oninput="${onChangeFunc}" class="calculation-input" required>
                            
                            <span class="formula-symbol">=</span>
                            
                            <div class="calculation-total-section">
                                <label style="flex-basis: auto;">Pago x VGT CANTV a cargo de Inter (*):</label>
                                <div id="${prefix}_total_display" class="total-display">0.00</div>
                                <input type="hidden" id="${prefix}_total_hidden" name="${prefix}_total_hidden" value="0.00">
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- SECCI√ìN EDC -->
                        <h5>Pago x VGT EDC</h5>
                        <div class="calculation-group">
                            <label for="${prefix}_precio_unitario1">Precio Unitario (*):</label>
                            <input type="number" step="0.01" min="0" id="${prefix}_precio_unitario1" name="${prefix}_precio_unitario1" placeholder="0.00" oninput="${onChangeFunc}" class="calculation-input" required>
                            
                            <span class="formula-symbol">X</span>
                            
                            <label for="${prefix}_puntos1">Puntos (*):</label>
                            <input type="number" step="1" min="0" id="${prefix}_puntos1" name="${prefix}_puntos1" placeholder="0" oninput="${onChangeFunc}" class="calculation-input" required>
                            
                            <span class="formula-symbol">=</span>
                            
                            <div class="calculation-total-section">
                                <label style="flex-basis: auto;">Pago x VGT EDC a cargo de Inter (*):</label>
                                <div id="${prefix}_total_display1" class="total-display">0.00</div>
                                <input type="hidden" id="${prefix}_total_hidden1" name="${prefix}_total_hidden1" value="0.00">
                            </div>
                        </div>

                        <hr>

                        <p><label for="${prefix}_descripcion">Descripci√≥n (*):</label>
                            <textarea id="${prefix}_descripcion" name="${prefix}_descripcion" required style="min-height: 120px;"></textarea></p>
                        
                        <p><label for="${prefix}_abono_mensual">Abono Mensual a Recibir por el cliente (*):</label>
                            <input type="text" id="${prefix}_abono_mensual" name="${prefix}_abono_mensual" required></p>
                            
                    </div>
                `;
            }

            function sanitizeInput(str) {
                if (typeof str !== 'string' || !str) return str;
                return str.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;')
                          .replace(/'/g, '&#039;');
            }

            async function generateWorkOrder() {
                const form = document.getElementById('work-order-form');
                let firstInvalidField = null;

                for (const section of formStructure) {
                    for (const field of section.fields) {
                        const isFixed = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill' || field.type === 'year-auto';
                        
                        if (!field.required || isFixed) continue;

                        let fieldId = field.id;
                        
                        const inputElement = document.getElementById(fieldId);

                        if (inputElement && !inputElement.disabled && !inputElement.checkValidity()) {
                            firstInvalidField = inputElement;
                            break; 
                        }
                    }
                    if (firstInvalidField) break; 
                }

                if (firstInvalidField) {
                    alert('‚ö†Ô∏è Atenci√≥n: Debe completar los campos obligatorios faltantes marcados con (*). El sistema lo llevar√° al primer error.');
                    
                    firstInvalidField.reportValidity();
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidField.focus();
                    return;
                }

                const formData = new FormData(form);
                const orderData = {};
                
                const caracasDate = getCurrentCaracasDate(); 
                const currentYear = getCurrentCaracasYear();
                const currentMonth = getCurrentCaracasMonth();
                const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'ERROR';

                formStructure.forEach(section => {
                    section.fields.forEach(field => {
                        let value;
                        let fieldId = field.id;

                        if (field.type === 'ot_counter') {
                            value = `(${currentMonth}-${otCounter})`;
                        }
                        else if (field.type === 'user-auto-fill') value = currentUserEmail; 
                        else if (field.type === 'date-auto') value = caracasDate;
                        else if (field.type === 'year-auto') value = currentYear.toString();
                        else if (field.type === 'static') value = field.value;
                        else {
                            const inputElement = document.getElementById(fieldId);
                            value = inputElement ? inputElement.value : formData.get(fieldId);
                        }
                        
                        if (field.type === 'date-input' && value && value.trim() !== '') {
                            orderData[field.label] = formatDateToDDMMYYYY(value);
                        } else {
                            const sanitizedValue = sanitizeInput(value);
                            orderData[field.label] = (sanitizedValue && sanitizedValue.trim() !== '') ? sanitizedValue : 'N/A';
                        }
                    });
                });
                
                const selectedType = document.querySelector('.conditional-check.active');
                orderData['Tipo de Construcci√≥n Espec√≠fica'] = selectedType ? selectedType.textContent.trim() : 'No aplica';

                if (selectedType) {
                    const prefix = selectedType.id.replace('check_', '');
                    
                    calculateNewTotal(prefix); 

                    orderData[`${prefix} | Costo Proyectado de la Obra`] = sanitizeInput(document.getElementById(`${prefix}_costo_proyectado`).value) || 'N/A';
                    orderData[`${prefix} | Pago realizado por`] = sanitizeInput(document.getElementById(`${prefix}_pago_por_realizado`).value) || 'N/A';
                    
                    orderData[`${prefix} | Pago x VGT CANTV a cargo de Inter`] = formData.get(`${prefix}_total_hidden`) || '0.00';
                    orderData[`${prefix} | Pago x VGT EDC a cargo de Inter`] = formData.get(`${prefix}_total_hidden1`) || '0.00';

                    orderData[`${prefix} | Precio Unitario CANTV`] = parseFloat(document.getElementById(`${prefix}_precio_unitario`).value.replace(',', '.')).toFixed(2) || '0.00';
                    orderData[`${prefix} | Puntos CANTV`] = parseFloat(document.getElementById(`${prefix}_puntos`).value.replace(',', '.')).toFixed(0) || '0'; 
                    
                    orderData[`${prefix} | Precio Unitario EDC`] = parseFloat(document.getElementById(`${prefix}_precio_unitario1`).value.replace(',', '.')).toFixed(2) || '0.00';
                    orderData[`${prefix} | Puntos EDC`] = parseFloat(document.getElementById(`${prefix}_puntos1`).value.replace(',', '.')).toFixed(0) || '0'; 

                    orderData[`${prefix} | Descripci√≥n`] = sanitizeInput(document.getElementById(`${prefix}_descripcion`).value) || 'N/A';
                    orderData[`${prefix} | Abono Mensual a Recibir por el cliente`] = sanitizeInput(document.getElementById(`${prefix}_abono_mensual`).value) || 'N/A';
                }

                orderData['Estado'] = 'En curso';
                orderData['Fecha de Creaci√≥n'] = caracasDate;
                orderData['Creado por'] = currentUserEmail;
                orderData['√öltima modificaci√≥n'] = caracasDate;
                orderData['Modificado por'] = currentUserEmail;

                console.log("Datos a guardar en Firebase:", orderData);
                
                try {
                    const docRef = await ORDERS_COLLECTION.add(orderData); 
                    
                    orderData.id = docRef.id; 
                    workOrders.push(orderData);
                    otCounter++;
                    
                    await saveFormStructure(true); 

                    // Registrar en historial
                    await logChangeHistory(
                        'CREACI√ìN',
                        'Orden de Trabajo',
                        docRef.id,
                        orderData['Orden de Trabajo'],
                        { tipo: 'nueva_orden', detalles: 'Orden creada desde formulario' },
                        currentUserEmail
                    );

                    console.log('Generando PDF para nueva orden...');
                    await generatePDF(orderData);
                    console.log('PDF generado exitosamente');

                    form.reset();
                    renderWorkOrderForm(); 
                    renderOrdersTable(); 
                    renderAdminEditTables();
                    
                    alert('‚úÖ Orden de Trabajo creada exitosamente y PDF generado.');
                    
                } catch (e) {
                    console.error("Error al crear la orden:", e);
                    console.error("Detalles completos del error:", e.message, e.stack);
                    
                    let errorMessage = "Error al guardar la orden de trabajo en Firebase. ";
                    
                    if (e.code === 'permission-denied') {
                        errorMessage += "Error de permisos. Verifique las reglas de seguridad de Firestore.";
                    } else if (e.code === 'unavailable') {
                        errorMessage += "Error de conexi√≥n. Verifique su conexi√≥n a internet.";
                    } else {
                        errorMessage += `Detalles: ${e.message}`;
                    }
                    
                    alert(errorMessage);
                }
            }

            // *** 6. GENERACI√ìN DE PDF ***

            function formatLongTextForPDF(text, maxLineLength = 70) {
                if (!text || text === 'N/A') return 'N/A';
                
                let formattedText = text.replace(/<br\s*\/?>/gi, '\n');
                
                if (formattedText.length <= maxLineLength && !formattedText.includes('\n')) {
                    return formattedText;
                }
                
                const lines = formattedText.split('\n');
                let resultLines = [];
                
                lines.forEach(line => {
                    if (line.length <= maxLineLength) {
                        resultLines.push(line);
                    } else {
                        const words = line.split(' ');
                        let currentLine = '';
                        
                        words.forEach(word => {
                            if ((currentLine + ' ' + word).length <= maxLineLength) {
                                currentLine += (currentLine ? ' ' : '') + word;
                            } else {
                                if (currentLine) resultLines.push(currentLine);
                                currentLine = word;
                            }
                        });
                        
                        if (currentLine) resultLines.push(currentLine);
                    }
                });
                
                return resultLines.join('\n');
            }

            function generatePDF(data) {
                return new Promise((resolve, reject) => {
                    try {
                        const otNumber = data['Orden de Trabajo'];
                        const creationDate = data['Fecha Actual'] || 'N/A';
                        const fileName = `Orden_Trabajo_${otNumber}_${creationDate.replace(/\//g, '-')}.pdf`;
                        
                        console.log('Iniciando generaci√≥n de PDF para orden:', otNumber);

                        const printContainer = document.createElement('div');
                        printContainer.id = 'pdf-print-container';
                        printContainer.style.cssText = `
                            position: absolute;
                            left: -9999px;
                            top: 0;
                            width: 190mm;
                            min-height: 277mm;
                            background: white;
                            padding: 10mm;
                            font-family: Arial, sans-serif;
                            box-sizing: border-box;
                            line-height: 1.4;
                            font-size: 12px;
                        `;

                        let formContentHTML = `
                            <div style="font-family: 'Arial', sans-serif; color: #36454F; line-height: 1.4; width: 100%;">
                                <div class="pdf-main-header">
                                    <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px;">
                                        ${data['T√≠tulo del Formulario']} Nro. ${otNumber}
                                    </h1>
                                    
                                    <div style="text-align: right; margin-bottom: 25px; font-weight: bold; color: #555; font-size: 12px;">
                                        Fecha de Emisi√≥n: ${data['Fecha Actual']} | A√±o: ${data['A√±o'] || getCurrentCaracasYear()}
                                    </div>
                                </div>
                                
                                <div class="pdf-secondary-header" style="display: none;">
                                    <div style="text-align: right; font-weight: bold; color: #555; font-size: 11px; margin-bottom: 15px;">
                                        ${data['T√≠tulo del Formulario']} Nro. ${otNumber} - Fecha: ${data['Fecha Actual']} - A√±o: ${data['A√±o'] || getCurrentCaracasYear()} - P√°gina <span class="page-number"></span>
                                    </div>
                                </div>
                        `;

                        formStructure.forEach((section, secIndex) => {
                            
                            formContentHTML += `<div class="pdf-section" style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                            formContentHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px; page-break-after: avoid;">${section.title}</h3>`;
                            formContentHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;
                            
                            section.fields.forEach(field => {
                                const label = field.label;
                                let value = data[label] || 'N/A';
                                
                                if (label === 'T√≠tulo del Formulario' || label === 'Orden de Trabajo' || label === 'Fecha Actual') return;
                                
                                const fieldDefinition = section.fields.find(f => f.label === label);
                                if (fieldDefinition && fieldDefinition.type === 'date-input' && value !== 'N/A') {
                                    value = formatDateToDDMMYYYY(value);
                                }
                                
                                const isLongText = field.type === 'textarea' || 
                                                  /descripci√≥n|descripcion|detallada|detallado|observaci√≥n|observacion|comentario|notas|detalle|ubicaci√≥n|ubicacion/i.test(label);
                                
                                let valueCellStyle = "padding: 8px 6px; vertical-align: top; border: 1px solid #B0C4DE; font-size: 11px;";
                                let labelCellStyle = "padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE; font-size: 11px;";
                                
                                if (isLongText) {
                                    valueCellStyle += " word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 40px; page-break-inside: avoid;";
                                    value = formatLongTextForPDF(value, 70);
                                } else {
                                    valueCellStyle += " page-break-inside: avoid;";
                                }

                                formContentHTML += `
                                    <tr style="page-break-inside: avoid;">
                                        <td style="${labelCellStyle}">${label}:</td>
                                        <td style="${valueCellStyle} width: 65%;">${value}</td>
                                    </tr>
                                `;
                            });
                            
                            formContentHTML += '</table></div>';
                        });
                        
                        const type = data['Tipo de Construcci√≥n Espec√≠fica'];
                        if (type && type !== 'No aplica') {
                            const prefix = type.includes('Nodo') ? 'node_acceso' : 'isp';
                            
                            const pagoVgtCANTV = data[`${prefix} | Pago x VGT CANTV a cargo de Inter`] || '0.00';
                            const pagoVgtEDC = data[`${prefix} | Pago x VGT EDC a cargo de Inter`] || '0.00'; 
                            
                            const descripcionFormateada = formatLongTextForPDF(data[`${prefix} | Descripci√≥n`], 70);

                            formContentHTML += `<div class="pdf-section" style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                            formContentHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px; page-break-after: avoid;">${type}</h3>`;
                            formContentHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;

                            formContentHTML += `
                                <tr style="page-break-inside: avoid;">
                                    <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE;">Costo Proyectado de la Obra:</td>
                                    <td style="padding: 8px 6px; width: 65%; border: 1px solid #B0C4DE;">${data[`${prefix} | Costo Proyectado de la Obra`]}</td>
                                </tr>
                                <tr style="page-break-inside: avoid;">
                                    <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Pago realizado por:</td>
                                    <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data[`${prefix} | Pago realizado por`]}</td>
                                </tr>
                                
                                <tr style="background-color: #e0f7fa; page-break-inside: avoid;">
                                    <td style="padding: 10px 6px; font-weight: bold; border: 1px solid #B0C4DE;">Pago x VGT CANTV a cargo de Inter:</td>
                                    <td style="padding: 10px 6px; font-weight: bold; background-color: #ADD8E6; border: 1px solid #B0C4DE;">${pagoVgtCANTV}</td>
                                </tr>
                                
                                <tr style="background-color: #e0f7fa; page-break-inside: avoid;">
                                    <td style="padding: 10px 6px; font-weight: bold; border: 1px solid #B0C4DE;">Pago x VGT EDC a cargo de Inter:</td>
                                    <td style="padding: 10px 6px; font-weight: bold; background-color: #ADD8E6; border: 1px solid #B0C4DE;">${pagoVgtEDC}</td>
                                </tr>
                                
                                <tr style="page-break-inside: avoid;">
                                    <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Descripci√≥n:</td>
                                    <td style="padding: 8px 6px; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 60px; border: 1px solid #B0C4DE; page-break-inside: avoid;">${descripcionFormateada}</td>
                                </tr>
                                
                                <tr style="page-break-inside: avoid;">
                                    <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Abono Mensual a Recibir por el cliente:</td>
                                    <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data[`${prefix} | Abono Mensual a Recibir por el cliente`]}</td>
                                </tr>
                            `;

                            formContentHTML += '</table></div>';
                        }

                        formContentHTML += `
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px dashed #B0C4DE; width: 100%; page-break-inside: avoid;">
                                <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; width: 100%;">
                                    <div style="width: 45%;">
                                        Contratista:
                                        <div style="border-top: 1px solid #36454F; margin-top: 5px; padding-top: 40px;"></div>
                                    </div>
                                    <div style="width: 45%;">
                                        Supervisor T√©cnico:
                                        <div style="border-top: 1px solid #36454F; margin-top: 5px; padding-top: 40px;"></div>
                                    </div>
                                </div>
                            </div>
                        `;

                        formContentHTML += '</div>';

                        const pageBreakCSS = `
                            <style>
                                @media print {
                                    @page {
                                        margin: 8mm 10mm 5mm 10mm;
                                        size: A4;
                                    }
                                    
                                    .pdf-main-header {
                                        display: block;
                                    }
                                    
                                    .pdf-secondary-header {
                                        display: block !important;
                                        margin-bottom: 15px;
                                        padding-bottom: 10px;
                                        border-bottom: 1px solid #B0C4DE;
                                    }
                                    
                                    .pdf-section {
                                        page-break-inside: avoid;
                                        break-inside: avoid;
                                    }
                                    
                                    table {
                                        page-break-inside: auto;
                                    }
                                    
                                    tr {
                                        page-break-inside: avoid;
                                        page-break-after: auto;
                                    }
                                    
                                    .keep-together {
                                        page-break-inside: avoid;
                                    }
                                    
                                    .page-break {
                                        page-break-before: always;
                                    }
                                    
                                    .signature-section {
                                        page-break-before: avoid;
                                        page-break-inside: avoid;
                                    }
                                    
                                    .signature-container {
                                        position: relative;
                                        margin-top: 20px;
                                        page-break-inside: avoid;
                                        break-inside: avoid;
                                    }
                                }
                                
                                body {
                                    margin: 0;
                                    padding: 0;
                                    font-family: Arial, sans-serif;
                                    line-height: 1.4;
                                }
                            </style>
                        `;

                        printContainer.innerHTML = pageBreakCSS + formContentHTML;
                        document.body.appendChild(printContainer);

                        console.log('Contenedor PDF creado y agregado al DOM');

                        const opt = {
                            margin:       8,
                            filename:     fileName,
                            image:        { 
                                type: 'jpeg', 
                                quality: 0.98 
                            },
                            html2canvas:  { 
                                scale: 2,
                                useCORS: true,
                                logging: false,
                                scrollX: 0,
                                scrollY: 0,
                                onclone: function(clonedDoc) {
                                    const clonedContainer = clonedDoc.getElementById('pdf-print-container');
                                    if (clonedContainer) {
                                        clonedContainer.style.position = 'relative';
                                        clonedContainer.style.left = '0';
                                        clonedContainer.style.top = '0';
                                        
                                        const pageNumbers = clonedDoc.querySelectorAll('.page-number');
                                        pageNumbers.forEach((span, index) => {
                                            span.textContent = (index + 2);
                                        });
                                    }
                                }
                            },
                            jsPDF:        { 
                                unit: 'mm', 
                                format: 'a4', 
                                orientation: 'portrait',
                                compress: true,
                                hotfixes: ["px_scaling"]
                            }
                        };

                        setTimeout(() => {
                            console.log('Generando PDF desde elemento...');
                            
                            const tempContainer = document.getElementById('pdf-print-container');
                            if (tempContainer) {
                                tempContainer.style.position = 'relative';
                                tempContainer.style.left = '0';
                                tempContainer.style.top = '0';
                            }
                            
                            html2pdf()
                                .set(opt)
                                .from(printContainer)
                                .save()
                                .then(() => {
                                    console.log('PDF generado y descargado exitosamente:', fileName);
                                    if (document.body.contains(printContainer)) {
                                        document.body.removeChild(printContainer);
                                    }
                                    resolve();
                                })
                                .catch(error => {
                                    console.error('Error al generar PDF:', error);
                                    if (document.body.contains(printContainer)) {
                                        document.body.removeChild(printContainer);
                                    }
                                    reject(error);
                                });
                        }, 1000);

                    } catch (error) {
                        console.error('Error en generatePDF:', error);
                        const printContainer = document.getElementById('pdf-print-container');
                        if (printContainer && document.body.contains(printContainer)) {
                            document.body.removeChild(printContainer);
                        }
                        reject(error);
                    }
                });
            }
            
            function downloadOrder(orderId) {
                console.log('Intentando descargar orden ID:', orderId);
                
                const order = workOrders.find(o => o.id === orderId);
                if (order) {
                    console.log('Orden encontrada, generando PDF...');
                    generatePDF(order).then(() => {
                        console.log('PDF descargado exitosamente');
                    }).catch(error => {
                        console.error('Error al generar PDF:', error);
                        alert('Error al generar el PDF. Por favor, intente nuevamente.');
                    });
                } else {
                    console.error('Orden no encontrada con ID:', orderId);
                    alert('No se encontr√≥ la Orden de Trabajo para descargar.');
                }
            }
            
            // *** 7. L√ìGICA DE ELIMINACI√ìN Y CONTADOR ***

            function sortOrdersByNumberDescending(orders) {
                return orders.sort((a, b) => {
                    const numA = extractOrderNumber(a['Orden de Trabajo']);
                    const numB = extractOrderNumber(b['Orden de Trabajo']);
                    return numA - numB;
                });
            }

            function extractOrderNumber(otString) {
                if (!otString || typeof otString !== 'string') return 0;
                
                const match = otString.match(/\((\d+)-(\d+)\)/);
                if (match && match[2]) {
                    return parseInt(match[2], 10);
                }
                
                return 0;
            }

            function recalculateOtCounter() {
                if (workOrders.length === 0) {
                    otCounter = 1;
                    return;
                }

                const currentMonth = getCurrentCaracasMonth();
                
                const currentMonthOrders = workOrders.filter(order => {
                    const otNumber = order['Orden de Trabajo'];
                    if (typeof otNumber === 'string' && otNumber.startsWith(`(${currentMonth}-`)) {
                        return true;
                    }
                    return false;
                });

                const allOtNumbers = currentMonthOrders.map(order => {
                    const otNumber = order['Orden de Trabajo'];
                    if (typeof otNumber === 'string' && otNumber.startsWith(`(${currentMonth}-`)) {
                        const match = otNumber.match(/\((\d+)-(\d+)\)/);
                        if (match && match[2]) {
                            return parseInt(match[2], 10);
                        }
                    }
                    return 0;
                }).filter(ot => !isNaN(ot) && ot > 0);

                if (allOtNumbers.length === 0) {
                    otCounter = 1;
                    return;
                }

                const maxOt = Math.max(...allOtNumbers);
                const uniqueOtNumbers = [...new Set(allOtNumbers)];
                
                if (uniqueOtNumbers.length !== allOtNumbers.length) {
                    console.warn('‚ö†Ô∏è Se detectaron n√∫meros de orden duplicados en el mes actual');
                    
                    let nextAvailable = maxOt + 1;
                    while (allOtNumbers.includes(nextAvailable)) {
                        nextAvailable++;
                    }
                    otCounter = nextAvailable;
                } else {
                    otCounter = maxOt + 1;
                }
                
                console.log(`Contador recalculado para mes ${currentMonth}: ${otCounter} (M√°ximo encontrado: ${maxOt})`);
            }

            function recalculateFinalCertificationCounter() {
                if (finalCertifications.length === 0) {
                    finalCertificationCounter = 1;
                    return;
                }

                const currentMonth = getCurrentCaracasMonth();
                
                const currentMonthCertifications = finalCertifications.filter(cert => {
                    const certNumber = cert['N√∫mero de Certificaci√≥n Final'];
                    if (typeof certNumber === 'string' && certNumber.startsWith(`(${currentMonth}-`)) {
                        return true;
                    }
                    return false;
                });

                const allCertNumbers = currentMonthCertifications.map(cert => {
                    const certNumber = cert['N√∫mero de Certificaci√≥n Final'];
                    if (typeof certNumber === 'string' && certNumber.startsWith(`(${currentMonth}-`)) {
                        const match = certNumber.match(/\((\d+)-(\d+)\)/);
                        if (match && match[2]) {
                            return parseInt(match[2], 10);
                        }
                    }
                    return 0;
                }).filter(cert => !isNaN(cert) && cert > 0);

                if (allCertNumbers.length === 0) {
                    finalCertificationCounter = 1;
                    return;
                }

                const maxCert = Math.max(...allCertNumbers);
                finalCertificationCounter = maxCert + 1;
                
                console.log(`Contador de certificaciones finales recalculado para mes ${currentMonth}: ${finalCertificationCounter}`);
            }

            async function deleteWorkOrder(orderId, otNumber) {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede eliminar √≥rdenes.');
                    return;
                }

                if (!confirm(`¬øEst√° seguro de que desea eliminar la Orden de Trabajo Nro. ${otNumber}? Esta acci√≥n es irreversible y ajustar√° el contador.`)) {
                    return;
                }
                
                try {
                    await ORDERS_COLLECTION.doc(orderId).delete();
                    workOrders = workOrders.filter(order => order.id !== orderId);
                    recalculateOtCounter();
                    await saveFormStructure(true);
                    renderOrdersTable();
                    renderWorkOrderForm(); 
                    renderAdminEditTables();

                    alert(`‚úÖ Orden de Trabajo Nro. ${otNumber} eliminada y contador actualizado a ${otCounter}.`);

                } catch (e) {
                    console.error("Error al eliminar la orden:", e);
                    alert("Error al eliminar la Orden de Trabajo de Firebase. Detalles: " + e.message);
                }
            }

            async function deleteCompletedOrder(orderId, otNumber) {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede eliminar √≥rdenes finalizadas.');
                    return;
                }

                if (!confirm(`¬øEst√° seguro de que desea eliminar permanentemente la Orden Finalizada Nro. ${otNumber}? Esta acci√≥n es irreversible.`)) {
                    return;
                }
                
                try {
                    await COMPLETED_ORDERS_COLLECTION.doc(orderId).delete();
                    completedOrders = completedOrders.filter(order => order.id !== orderId);
                    renderCompletedOrdersTable();
                    renderAdminEditTables();
                    
                    alert(`‚úÖ Orden Finalizada Nro. ${otNumber} eliminada permanentemente.`);

                } catch (e) {
                    console.error("Error al eliminar la orden finalizada:", e);
                    alert("Error al eliminar la Orden Finalizada de Firebase. Detalles: " + e.message);
                }
            }

            // *** NUEVA FUNCI√ìN: Renderizar tabla de √≥rdenes con bot√≥n de edici√≥n para admin ***
            function renderOrdersTable() {
                const tbody = document.getElementById('orders-table').querySelector('tbody');
                const noResultsDiv = document.getElementById('no-results');
                tbody.innerHTML = '';

                let filteredOrders = workOrders;
                if (activeFilters.length > 0) {
                    filteredOrders = workOrders.filter(order => {
                        return activeFilters.every(filter => {
                            const fieldValue = order[filter.field] || '';
                            const filterValue = filter.value;
                            
                            switch (filter.operator) {
                                case 'contains':
                                    return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                                case 'equals':
                                    return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                                case 'startsWith':
                                    return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                                case 'endsWith':
                                    return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                                case 'range':
                                    const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                                    const numValue = parseFloat(fieldValue);
                                    return !isNaN(numValue) && numValue >= min && numValue <= max;
                                case 'greater':
                                    const greaterValue = parseFloat(fieldValue);
                                    const greaterFilter = parseFloat(filterValue);
                                    return !isNaN(greaterValue) && greaterValue > greaterFilter;
                                case 'less':
                                    const lessValue = parseFloat(fieldValue);
                                    const lessFilter = parseFloat(filterValue);
                                    return !isNaN(lessValue) && lessValue < lessFilter;
                                default:
                                    return true;
                            }
                        });
                    });
                }

                const sortedOrders = sortOrdersByNumberDescending([...filteredOrders]);

                if (sortedOrders.length === 0) {
                    noResultsDiv.style.display = 'block';
                } else {
                    noResultsDiv.style.display = 'none';
                }

                sortedOrders.forEach(order => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = order['Orden de Trabajo'];
                    row.insertCell().textContent = order['T√≠tulo del Formulario'];
                    const creationDate = order['Fecha Actual'] || 'N/A';
                    row.insertCell().textContent = creationDate;
                    
                    const statusCell = row.insertCell();
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'status-badge status-in-progress';
                    statusBadge.textContent = 'En curso';
                    statusCell.appendChild(statusBadge);
                    
                    const actionCell = row.insertCell();
                    
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = '‚¨áÔ∏è PDF';
                    downloadBtn.style.backgroundColor = '#77DD77'; 
                    downloadBtn.style.color = 'white';
                    downloadBtn.onclick = () => {
                        console.log('Bot√≥n PDF clickeado para orden:', order.id);
                        downloadOrder(order.id);
                    };
                    actionCell.appendChild(downloadBtn);
                    
                    const completeBtn = document.createElement('button');
                    completeBtn.textContent = '‚úÖ Finalizar';
                    completeBtn.className = 'complete-button';
                    completeBtn.style.marginLeft = '5px';
                    completeBtn.onclick = () => openCertificationModal(order);
                    actionCell.appendChild(completeBtn);
                    
                    // Bot√≥n de edici√≥n para admin
                    if (currentRole === 'admin') {
                        const editBtn = document.createElement('button');
                        editBtn.textContent = '‚úèÔ∏è Editar';
                        editBtn.className = 'edit-button';
                        editBtn.style.marginLeft = '5px';
                        editBtn.onclick = () => openEditOrderModal(order);
                        actionCell.appendChild(editBtn);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                        deleteBtn.style.backgroundColor = 'var(--color-error)';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.marginLeft = '5px';
                        deleteBtn.onclick = () => deleteWorkOrder(order.id, order['Orden de Trabajo']);
                        actionCell.appendChild(deleteBtn);
                    }
                });
            }

            // *** 8. NUEVAS FUNCIONES PARA CERTIFICACI√ìN Y FINALIZACI√ìN ***

            function openCertificationModal(order) {
                currentOrderForCertification = order;
                
                document.getElementById('certification-title').textContent = 
                    `Certificaci√≥n de Obras Nro. ${order['Orden de Trabajo']}`;
                document.getElementById('certification-number').value = order['Orden de Trabajo'];
                document.getElementById('certification-date').value = getCurrentCaracasDate();
                document.getElementById('certification-year').value = getCurrentCaracasYear();
                document.getElementById('work-order-reference').value = order['Orden de Trabajo'];
                
                let companyName = '';
                let companyRif = '';
                
                for (const key in order) {
                    if (key.includes('Empresa') && order[key] && order[key] !== 'N/A' && order[key] !== 'Seleccione una Empresa') {
                        companyName = order[key];
                        break;
                    }
                }
                
                for (const key in order) {
                    if (key.includes('Rif') && order[key] && order[key] !== 'N/A') {
                        companyRif = order[key];
                        break;
                    }
                }
                
                document.getElementById('contractor-company').value = companyName || 'No especificada';
                document.getElementById('contractor-rif').value = companyRif || 'No especificado';
                
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
                document.getElementById('work-details').value = '';
                document.getElementById('total-amount').value = '';
                document.getElementById('deviations').value = '';
                
                document.getElementById('certification-modal').style.display = 'flex';
            }

            function closeCertificationModal() {
                document.getElementById('certification-modal').style.display = 'none';
                currentOrderForCertification = null;
            }

            async function completeWorkOrder() {
                if (!currentOrderForCertification) {
                    alert('Error: No hay orden seleccionada para finalizar.');
                    return;
                }

                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const workDetails = document.getElementById('work-details').value;
                const totalAmount = document.getElementById('total-amount').value;

                if (!startDate || !endDate || !workDetails || !totalAmount) {
                    alert('Por favor, complete todos los campos obligatorios del formulario de certificaci√≥n.');
                    return;
                }

                try {
                    const certificationData = {
                        ...currentOrderForCertification,
                        'Estado': 'Finalizada',
                        'Fecha de Finalizaci√≥n': getCurrentCaracasDate(),
                        'Certificaci√≥n': {
                            'N√∫mero de Certificaci√≥n': currentOrderForCertification['Orden de Trabajo'],
                            'Fecha de Certificaci√≥n': getCurrentCaracasDate(),
                            'A√±o': getCurrentCaracasYear(),
                            'Empresa Contratista': document.getElementById('contractor-company').value,
                            'Identificaci√≥n Fiscal RIF': document.getElementById('contractor-rif').value,
                            'Fecha de Inicio': formatDateToDDMMYYYY(startDate),
                            'Fecha de Fin': formatDateToDDMMYYYY(endDate),
                            'Detalle de Trabajos Realizados': workDetails,
                            'Importe Total de la Obra': totalAmount,
                            'Desviaciones y Justificaci√≥n': document.getElementById('deviations').value
                        },
                        '√öltima modificaci√≥n': getCurrentCaracasDate(),
                        'Modificado por': firebase.auth().currentUser.email
                    };

                    // Registrar historial antes de mover
                    await logChangeHistory(
                        'FINALIZACI√ìN',
                        'Orden de Trabajo',
                        currentOrderForCertification.id,
                        currentOrderForCertification['Orden de Trabajo'],
                        { 
                            tipo: 'finalizacion_certificacion', 
                            importe_anterior: currentOrderForCertification['Certificaci√≥n']?.['Importe Total de la Obra'] || 'N/A',
                            importe_nuevo: totalAmount,
                            detalles: 'Orden finalizada con certificaci√≥n'
                        },
                        firebase.auth().currentUser.email
                    );

                    await COMPLETED_ORDERS_COLLECTION.add(certificationData);
                    await ORDERS_COLLECTION.doc(currentOrderForCertification.id).delete();
                    
                    workOrders = workOrders.filter(order => order.id !== currentOrderForCertification.id);
                    completedOrders.push(certificationData);
                    
                    await generateCertificationPDF(certificationData);
                    
                    closeCertificationModal();
                    renderOrdersTable();
                    renderCompletedOrdersTable();
                    renderAdminEditTables();
                    
                    alert('‚úÖ Orden finalizada exitosamente. Se ha generado la certificaci√≥n en PDF.');
                    
                } catch (error) {
                    console.error('Error al finalizar la orden:', error);
                    alert('Error al finalizar la orden: ' + error.message);
                }
            }

            function generateCertificationPDF(data) {
                return new Promise((resolve, reject) => {
                    try {
                        const certificationNumber = data['Orden de Trabajo'];
                        const fileName = `Certificacion_Obra_${certificationNumber}.pdf`;
                        
                        console.log('Generando PDF de certificaci√≥n para orden:', certificationNumber);

                        const certificationContent = `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <style>
                                    body { 
                                        font-family: Arial, sans-serif; 
                                        margin: 8mm 20px 5mm 20px;
                                        color: #36454F; 
                                        line-height: 1.4;
                                        background: white;
                                    }
                                    h1 { 
                                        color: #4682B4; 
                                        text-align: center; 
                                        border-bottom: 2px solid #4682B4; 
                                        padding-bottom: 10px; 
                                        margin-bottom: 20px; 
                                    }
                                    .section { 
                                        margin-bottom: 25px; 
                                        page-break-inside: avoid;
                                    }
                                    .section h3 { 
                                        color: #4682B4; 
                                        border-left: 4px solid #4682B4; 
                                        padding-left: 8px; 
                                        margin-top: 0;
                                    }
                                    table { 
                                        width: 100%; 
                                        border-collapse: collapse; 
                                        margin-top: 10px;
                                    }
                                    td { 
                                        padding: 10px; 
                                        border: 1px solid #B0C4DE; 
                                        vertical-align: top;
                                    }
                                    .label { 
                                        font-weight: bold; 
                                        background-color: #F0F8FF; 
                                        width: 35%; 
                                    }
                                    .signature-section {
                                        margin-top: 50px;
                                        padding-top: 20px;
                                        border-top: 2px dashed #B0C4DE;
                                        width: 100%;
                                        page-break-inside: avoid;
                                    }
                                    .signatures-container {
                                        display: flex;
                                        justify-content: space-between;
                                        width: 100%;
                                    }
                                    .signature-box {
                                        width: 45%;
                                        text-align: center;
                                    }
                                    .signature-line {
                                        border-bottom: 1px solid #000;
                                        margin-top: 60px;
                                        height: 1px;
                                        width: 100%;
                                    }
                                    @media print {
                                        @page {
                                            margin: 8mm 15mm 5mm 15mm;
                                        }
                                        body { margin: 0; }
                                        .section { page-break-inside: avoid; }
                                        .signatures-container { display: flex; justify-content: space-between; }
                                        .signature-section { page-break-inside: avoid; }
                                    }
                                </style>
                            </head>
                            <body>
                                <h1>Certificaci√≥n de Obras Nro. ${certificationNumber}</h1>
                                
                                <div class="section">
                                    <h3>I. Datos de Certificaci√≥n</h3>
                                    <table>
                                        <tr>
                                            <td class="label">N√∫mero de Certificaci√≥n:</td>
                                            <td>${certificationNumber}</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Fecha de la Certificaci√≥n:</td>
                                            <td>${data['Certificaci√≥n']?.['Fecha de Certificaci√≥n'] || data['Fecha de Finalizaci√≥n'] || getCurrentCaracasDate()}</td>
                                        </tr>
                                        <tr>
                                            <td class="label">A√±o:</td>
                                            <td>${data['Certificaci√≥n']?.['A√±o'] || getCurrentCaracasYear()}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="section">
                                    <h3>II. Identificaci√≥n</h3>
                                    <table>
                                        <tr>
                                            <td class="label">Empresa Contratista:</td>
                                            <td>${data['Certificaci√≥n']?.['Empresa Contratista'] || 'No especificada'}</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Identificaci√≥n Fiscal RIF:</td>
                                            <td>${data['Certificaci√≥n']?.['Identificaci√≥n Fiscal RIF'] || 'No especificado'}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="section">
                                    <h3>III. Informaci√≥n del Proyecto</h3>
                                    <table>
                                        <tr>
                                            <td class="label">Corresponde Orden de trabajo N¬∞:</td>
                                            <td>${certificationNumber}</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Fechas de Inicio:</td>
                                            <td>${data['Certificaci√≥n']?.['Fecha de Inicio'] || 'No especificada'}</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Fin de la Obra:</td>
                                            <td>${data['Certificaci√≥n']?.['Fecha de Fin'] || 'No especificada'}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="section">
                                    <h3>IV. Detalle de los trabajos realizados</h3>
                                    <table>
                                        <tr>
                                            <td class="label">Detalle:</td>
                                            <td style="white-space: pre-wrap; min-height: 100px;">${data['Certificaci√≥n']?.['Detalle de Trabajos Realizados'] || 'No se especificaron detalles'}</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Importe total de la obra:</td>
                                            <td>${data['Certificaci√≥n']?.['Importe Total de la Obra'] || 'No especificado'}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="section">
                                    <h3>V. Desviaciones y Justificaci√≥n</h3>
                                    <table>
                                        <tr>
                                            <td class="label">Detalle de desviaciones:</td>
                                            <td style="white-space: pre-wrap; min-height: 80px;">${data['Certificaci√≥n']?.['Desviaciones y Justificaci√≥n'] || 'No se registraron desviaciones'}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="signature-section">
                                    <div class="signatures-container">
                                        <div class="signature-box">
                                            <strong>Firma Jefe T√©cnico (Firma/Sello)</strong>
                                            <div class="signature-line"></div>
                                        </div>
                                        <div class="signature-box">
                                            <strong>Firma Gerente T√©cnico (Firma/Sello)</strong>
                                            <div class="signature-line"></div>
                                        </div>
                                    </div>
                                </div>
                            </body>
                            </html>
                        `;

                        const printContainer = document.createElement('div');
                        printContainer.innerHTML = certificationContent;
                        document.body.appendChild(printContainer);

                        const opt = {
                            margin: 8,
                            filename: fileName,
                            image: { 
                                type: 'jpeg', 
                                quality: 0.98 
                            },
                            html2canvas: { 
                                scale: 2,
                                useCORS: true,
                                logging: true,
                                backgroundColor: '#FFFFFF',
                                onclone: function(clonedDoc) {
                                    console.log('Documento clonado para PDF de certificaci√≥n');
                                }
                            },
                            jsPDF: { 
                                unit: 'mm', 
                                format: 'a4', 
                                orientation: 'portrait',
                                compress: true
                            }
                        };

                        setTimeout(() => {
                            html2pdf()
                                .set(opt)
                                .from(printContainer)
                                .save()
                                .then(() => {
                                    console.log('PDF de certificaci√≥n generado exitosamente:', fileName);
                                    if (document.body.contains(printContainer)) {
                                        document.body.removeChild(printContainer);
                                    }
                                    resolve();
                                })
                                .catch(error => {
                                    console.error('Error al generar PDF de certificaci√≥n:', error);
                                    if (document.body.contains(printContainer)) {
                                        document.body.removeChild(printContainer);
                                    }
                                    reject(error);
                                });
                        }, 1000);

                    } catch (error) {
                        console.error('Error en generateCertificationPDF:', error);
                        reject(error);
                    }
                });
            }

            // *** MEJORA: Funciones para edici√≥n avanzada ***

            function getCertifiedOrderIds() {
                const certifiedOrderIds = new Set();
                
                finalCertifications.forEach(certification => {
                    if (certification['√ìrdenes Realizadas'] && Array.isArray(certification['√ìrdenes Realizadas'])) {
                        certification['√ìrdenes Realizadas'].forEach(order => {
                            if (order.id) {
                                certifiedOrderIds.add(order.id);
                            }
                        });
                    }
                });
                
                return certifiedOrderIds;
            }

            function getOrderCertificationStatus(orderId) {
                const certifications = [];
                
                finalCertifications.forEach(certification => {
                    if (certification['√ìrdenes Realizadas'] && Array.isArray(certification['√ìrdenes Realizadas'])) {
                        const foundOrder = certification['√ìrdenes Realizadas'].find(order => order.id === orderId);
                        if (foundOrder) {
                            certifications.push({
                                certificationId: certification.id,
                                certificationNumber: certification['N√∫mero de Certificaci√≥n Final'],
                                certificationDate: certification['Fecha de Creaci√≥n'],
                                empresa: certification['Empresa'],
                                orderInCertification: foundOrder
                            });
                        }
                    }
                });
                
                return certifications.length > 0 ? certifications : null;
            }

            function setCertificationFilter(filterType) {
                certificationFilter = filterType;
                
                const buttons = document.querySelectorAll('.certification-filter-button');
                buttons.forEach(button => {
                    button.classList.remove('active');
                });
                
                const activeButton = document.querySelector(`.certification-filter-button${filterType === 'all' ? '' : (filterType === 'certified' ? '' : '.not-certified')}`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
                
                renderCompletedOrdersTable();
            }

            // *** NUEVA FUNCI√ìN: Renderizar tabla de √≥rdenes finalizadas con bot√≥n de edici√≥n avanzada para admin ***
            function renderCompletedOrdersTable() {
                const tbody = document.getElementById('completed-orders-table').querySelector('tbody');
                const noResultsDiv = document.getElementById('no-completed-results');
                tbody.innerHTML = '';

                let filteredOrders = completedOrders;
                
                if (certificationFilter !== 'all') {
                    filteredOrders = completedOrders.filter(order => {
                        const isCertified = getOrderCertificationStatus(order.id) !== null;
                        return certificationFilter === 'certified' ? isCertified : !isCertified;
                    });
                }
                
                if (completedActiveFilters.length > 0) {
                    filteredOrders = filteredOrders.filter(order => {
                        return completedActiveFilters.every(filter => {
                            const fieldValue = order[filter.field] || '';
                            const filterValue = filter.value;
                            
                            switch (filter.operator) {
                                case 'contains':
                                    return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                                case 'equals':
                                    return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                                case 'startsWith':
                                    return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                                case 'endsWith':
                                    return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                                case 'range':
                                    const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                                    const numValue = parseFloat(fieldValue);
                                    return !isNaN(numValue) && numValue >= min && numValue <= max;
                                case 'greater':
                                    const greaterValue = parseFloat(fieldValue);
                                    const greaterFilter = parseFloat(filterValue);
                                    return !isNaN(greaterValue) && greaterValue > greaterFilter;
                                case 'less':
                                    const lessValue = parseFloat(fieldValue);
                                    const lessFilter = parseFloat(filterValue);
                                    return !isNaN(lessValue) && lessValue < lessFilter;
                                default:
                                    return true;
                            }
                        });
                    });
                }

                const sortedOrders = sortOrdersByNumberDescending([...filteredOrders]);

                if (sortedOrders.length === 0) {
                    noResultsDiv.style.display = 'block';
                } else {
                    noResultsDiv.style.display = 'none';
                }

                sortedOrders.forEach(order => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = order['Orden de Trabajo'];
                    row.insertCell().textContent = order['T√≠tulo del Formulario'];
                    row.insertCell().textContent = order['Fecha Actual'] || 'N/A';
                    row.insertCell().textContent = order['Fecha de Finalizaci√≥n'] || 'N/A';
                    
                    const certificationCell = row.insertCell();
                    const certificationStatus = getOrderCertificationStatus(order.id);
                    if (certificationStatus) {
                        let certificationsHTML = '';
                        certificationStatus.forEach(cert => {
                            certificationsHTML += `
                                <div style="margin-bottom: 3px;">
                                    <span class="certified-badge" title="Certificada en CF N¬∞ ${cert.certificationNumber} (${cert.certificationDate})">
                                        ‚úÖ CF ${cert.certificationNumber}
                                    </span>
                                </div>
                            `;
                        });
                        certificationCell.innerHTML = certificationsHTML;
                    } else {
                        certificationCell.innerHTML = '<span style="color: #666;">No certificada</span>';
                    }
                    
                    const actionCell = row.insertCell();
                    
                    const orderPdfBtn = document.createElement('button');
                    orderPdfBtn.textContent = 'üìã Orden';
                    orderPdfBtn.style.backgroundColor = '#87CEFA';
                    orderPdfBtn.style.color = 'white';
                    orderPdfBtn.onclick = () => generatePDF(order);
                    actionCell.appendChild(orderPdfBtn);
                    
                    const certPdfBtn = document.createElement('button');
                    certPdfBtn.textContent = 'üìÑ Certificaci√≥n';
                    certPdfBtn.style.backgroundColor = '#77DD77';
                    certPdfBtn.style.color = 'white';
                    certPdfBtn.style.marginLeft = '5px';
                    certPdfBtn.onclick = () => generateCertificationPDF(order);
                    actionCell.appendChild(certPdfBtn);
                    
                    // Bot√≥n de edici√≥n avanzada para admin (incluye certificadas)
                    if (currentRole === 'admin') {
                        const editBtn = document.createElement('button');
                        editBtn.textContent = certificationStatus ? '‚úèÔ∏è Editar (Certificada)' : '‚úèÔ∏è Editar';
                        editBtn.className = certificationStatus ? 'edit-certified-button' : 'edit-button';
                        editBtn.style.marginLeft = '5px';
                        editBtn.onclick = () => openEditCompletedAdvancedModal(order);
                        actionCell.appendChild(editBtn);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                        deleteBtn.style.backgroundColor = 'var(--color-error)';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.marginLeft = '5px';
                        deleteBtn.onclick = () => deleteCompletedOrder(order.id, order['Orden de Trabajo']);
                        actionCell.appendChild(deleteBtn);
                    }
                });
            }

            // *** 9. NUEVAS FUNCIONES PARA CERTIFICACI√ìN FINAL ***

            function renderFinalCertificationForm() {
                const certificationNumber = document.getElementById('certification-number');
                if (certificationNumber) {
                    const currentMonth = getCurrentCaracasMonth();
                    certificationNumber.value = `(${currentMonth}-${finalCertificationCounter})`;
                }
                
                const certificationYear = document.getElementById('certification-year');
                if (certificationYear) {
                    certificationYear.value = getCurrentCaracasYear();
                }
                
                const companySelect = document.getElementById('certification-company');
                if (companySelect) {
                    companySelect.innerHTML = '<option value="">Seleccionar empresa...</option>';
                    
                    companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.name;
                        option.textContent = company.name;
                        companySelect.appendChild(option);
                    });
                }
            }

            function updateOrdersForCertification() {
                const companySelect = document.getElementById('certification-company');
                const ordersContainer = document.getElementById('certification-orders-container');
                const noOrdersMessage = document.getElementById('no-orders-message');
                const allOrdersCertifiedMessage = document.getElementById('all-orders-certified-message');
                const selectedCompany = companySelect.value;
                
                if (!selectedCompany) {
                    ordersContainer.style.display = 'none';
                    noOrdersMessage.style.display = 'none';
                    allOrdersCertifiedMessage.style.display = 'none';
                    updateCertificationTotal();
                    return;
                }
                
                const certifiedOrderIds = getCertifiedOrderIds();
                
                const ordersForCompany = completedOrders.filter(order => {
                    if (certifiedOrderIds.has(order.id)) {
                        return false;
                    }
                    
                    for (const key in order) {
                        if (order[key] === selectedCompany) {
                            return true;
                        }
                    }
                    return false;
                });
                
                if (ordersForCompany.length === 0) {
                    ordersContainer.style.display = 'none';
                    noOrdersMessage.style.display = 'none';
                    allOrdersCertifiedMessage.style.display = 'block';
                    updateCertificationTotal();
                    return;
                }
                
                ordersContainer.style.display = 'block';
                noOrdersMessage.style.display = 'none';
                allOrdersCertifiedMessage.style.display = 'none';
                
                ordersContainer.innerHTML = '';
                
                ordersForCompany.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-checkbox-item';
                    
                    const orderNumber = order['Orden de Trabajo'];
                    const importeTotal = order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00';
                    
                    orderDiv.innerHTML = `
                        <div>
                            <input type="checkbox" id="order-${order.id}" value="${order.id}" data-amount="${importeTotal}" onchange="updateCertificationTotal()">
                            <label for="order-${order.id}">Orden de Trabajo ${orderNumber}</label>
                        </div>
                        <div class="order-amount">${parseFloat(importeTotal).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    `;
                    
                    ordersContainer.appendChild(orderDiv);
                });
                
                updateCertificationTotal();
            }

            function updateCertificationTotal() {
                const checkboxes = document.querySelectorAll('#certification-orders-container input[type="checkbox"]');
                let total = 0;
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        const amount = parseFloat(checkbox.getAttribute('data-amount')) || 0;
                        total += amount;
                    }
                });
                
                const totalDisplay = document.getElementById('certification-total');
                const totalHidden = document.getElementById('certification-total-hidden');
                
                if (totalDisplay) {
                    totalDisplay.textContent = total.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
                
                if (totalHidden) {
                    totalHidden.value = total.toFixed(2);
                }
            }

            async function generateFinalCertification() {
                const companySelect = document.getElementById('certification-company');
                const selectedCompany = companySelect.value;
                
                if (!selectedCompany) {
                    alert('Por favor, seleccione una empresa.');
                    return;
                }
                
                const checkboxes = document.querySelectorAll('#certification-orders-container input[type="checkbox"]:checked');
                
                if (checkboxes.length === 0) {
                    alert('Por favor, seleccione al menos una orden finalizada.');
                    return;
                }
                
                const certifiedOrderIds = getCertifiedOrderIds();
                const selectedOrders = [];
                let totalAmount = 0;
                let hasAlreadyCertified = false;
                
                checkboxes.forEach(checkbox => {
                    const orderId = checkbox.value;
                    
                    if (certifiedOrderIds.has(orderId)) {
                        hasAlreadyCertified = true;
                        const order = completedOrders.find(o => o.id === orderId);
                        if (order) {
                            alert(`‚ö†Ô∏è La Orden de Trabajo ${order['Orden de Trabajo']} ya est√° incluida en otra certificaci√≥n final y no puede ser seleccionada nuevamente.`);
                        }
                        return;
                    }
                    
                    const order = completedOrders.find(o => o.id === orderId);
                    
                    if (order) {
                        selectedOrders.push({
                            id: order.id,
                            numero: order['Orden de Trabajo'],
                            importe: order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00',
                            fechaFinalizacion: order['Fecha de Finalizaci√≥n'] || 'N/A'
                        });
                        
                        totalAmount += parseFloat(order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00');
                    }
                });
                
                if (hasAlreadyCertified) {
                    alert('No se puede crear la certificaci√≥n final porque algunas √≥rdenes seleccionadas ya est√°n certificadas.');
                    return;
                }
                
                if (selectedOrders.length === 0) {
                    alert('No hay √≥rdenes v√°lidas para certificar.');
                    return;
                }
                
                try {
                    const currentMonth = getCurrentCaracasMonth();
                    const currentUserEmail = firebase.auth().currentUser.email;
                    
                    const certificationData = {
                        'T√≠tulo del Formulario': 'Certificaci√≥n Final',
                        'N√∫mero de Certificaci√≥n Final': `(${currentMonth}-${finalCertificationCounter})`,
                        'A√±o': getCurrentCaracasYear(),
                        'Empresa': selectedCompany,
                        '√ìrdenes Realizadas': selectedOrders,
                        'Total': totalAmount.toFixed(2),
                        'Fecha de Creaci√≥n': getCurrentCaracasDate(),
                        'Creado por': currentUserEmail,
                        '√öltima modificaci√≥n': getCurrentCaracasDate(),
                        'Modificado por': currentUserEmail
                    };
                    
                    const docRef = await FINAL_CERTIFICATIONS_COLLECTION.add(certificationData);
                    
                    certificationData.id = docRef.id;
                    finalCertifications.push(certificationData);
                    
                    // Registrar historial
                    await logChangeHistory(
                        'CREACI√ìN',
                        'Certificaci√≥n Final',
                        docRef.id,
                        certificationData['N√∫mero de Certificaci√≥n Final'],
                        { 
                            tipo: 'nueva_certificacion_final', 
                            empresa: selectedCompany,
                            total: totalAmount.toFixed(2),
                            cantidad_ordenes: selectedOrders.length,
                            ordenes: selectedOrders.map(o => o.numero).join(', ')
                        },
                        currentUserEmail
                    );
                    
                    finalCertificationCounter++;
                    await saveFormStructure(true);
                    
                    updateCertificationNumberDisplay();
                    
                    await generateFinalCertificationPDF(certificationData);
                    
                    clearCertificationForm();
                    
                    renderFinalCertificationsList();
                    renderAdminEditTables();
                    
                    alert('‚úÖ Certificaci√≥n Final creada exitosamente y PDF generado.');
                    
                } catch (error) {
                    console.error('Error al crear certificaci√≥n final:', error);
                    alert('Error al crear la certificaci√≥n final: ' + error.message);
                }
            }

            function updateCertificationNumberDisplay() {
                const certificationNumber = document.getElementById('certification-number');
                if (certificationNumber) {
                    const currentMonth = getCurrentCaracasMonth();
                    certificationNumber.value = `(${currentMonth}-${finalCertificationCounter})`;
                }
            }

            function clearCertificationForm() {
                document.getElementById('certification-company').value = '';
                document.getElementById('certification-orders-container').style.display = 'none';
                document.getElementById('no-orders-message').style.display = 'none';
                document.getElementById('all-orders-certified-message').style.display = 'none';
                document.getElementById('certification-total').textContent = '0.00';
                document.getElementById('certification-total-hidden').value = '0.00';
                
                updateCertificationNumberDisplay();
            }

            function generateFinalCertificationPDF(data) {
                return new Promise((resolve, reject) => {
                    try {
                        const certificationNumber = data['N√∫mero de Certificaci√≥n Final'];
                        const fileName = `Certificacion_Final_${certificationNumber}.pdf`;
                        
                        console.log('Generando PDF de certificaci√≥n final:', certificationNumber);

                        const certificationContent = `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <style>
                                    body { 
                                        font-family: Arial, sans-serif; 
                                        margin: 8mm 10mm 5mm 10mm;
                                        color: #36454F; 
                                        line-height: 1.4;
                                        background: white;
                                    }
                                    h1 { 
                                        color: #9C27B0; 
                                        text-align: center; 
                                        border-bottom: 2px solid #9C27B0; 
                                        padding-bottom: 10px; 
                                        margin-bottom: 20px; 
                                        font-size: 20px;
                                    }
                                    .section { 
                                        margin-bottom: 20px; 
                                        page-break-inside: avoid;
                                    }
                                    .section h3 { 
                                        color: #9C27B0; 
                                        border-left: 4px solid #9C27B0; 
                                        padding-left: 8px; 
                                        margin-top: 0;
                                        font-size: 16px;
                                    }
                                    table { 
                                        width: 100%; 
                                        border-collapse: collapse; 
                                        margin-top: 10px;
                                        font-size: 12px;
                                    }
                                    td { 
                                        padding: 8px; 
                                        border: 1px solid #B0C4DE; 
                                        vertical-align: top;
                                    }
                                    .label { 
                                        font-weight: bold; 
                                        background-color: #F3E5F5; 
                                        width: 35%; 
                                    }
                                    .orders-table {
                                        margin-top: 15px;
                                    }
                                    .orders-table th {
                                        background-color: #E1BEE7;
                                        font-weight: bold;
                                        text-align: left;
                                    }
                                    .total-section {
                                        margin-top: 20px;
                                        padding: 15px;
                                        background-color: #F3E5F5;
                                        border: 1px solid #9C27B0;
                                        border-radius: 5px;
                                        text-align: center;
                                        font-weight: bold;
                                        font-size: 14px;
                                    }
                                    .footer-text {
                                        margin-top: 40px;
                                        padding-top: 20px;
                                        border-top: 2px dashed #9C27B0;
                                        font-style: italic;
                                        text-align: center;
                                        font-size: 12px;
                                    }
                                    .signature-section {
                                        margin-top: 50px;
                                        padding-top: 20px;
                                        border-top: 2px dashed #9C27B0;
                                        width: 100%;
                                        page-break-inside: avoid;
                                    }
                                    .signatures-container {
                                        display: flex;
                                        justify-content: space-between;
                                        width: 100%;
                                    }
                                    .signature-box {
                                        width: 45%;
                                        text-align: center;
                                    }
                                    .signature-line {
                                        border-bottom: 1px solid #000;
                                        margin-top: 60px;
                                        height: 1px;
                                        width: 100%;
                                    }
                                    @media print {
                                        @page {
                                            margin: 8mm 10mm 5mm 10mm;
                                        }
                                        body { margin: 0; }
                                        .section { page-break-inside: avoid; }
                                        .page-break { page-break-before: always; }
                                        .signature-section { page-break-inside: avoid; }
                                    }
                                </style>
                            </head>
                            <body>
                                <h1>Certificaci√≥n Final N¬∞ ${certificationNumber}</h1>
                                
                                <div class="section">
                                    <h3>I. Informaci√≥n de la Certificaci√≥n</h3>
                                    <table>
                                        <tr>
                                            <td class="label">N√∫mero de Certificaci√≥n Final:</td>
                                            <td>${certificationNumber}</td>
                                        </tr>
                                        <tr>
                                            <td class="label">A√±o:</td>
                                            <td>${data['A√±o'] || getCurrentCaracasYear()}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="section">
                                    <h3>II. Informaci√≥n de la Empresa</h3>
                                    <table>
                                        <tr>
                                            <td class="label">Empresa:</td>
                                            <td>${data['Empresa']}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="section">
                                    <h3>III. √ìrdenes Realizadas</h3>
                                    <table class="orders-table">
                                        <thead>
                                            <tr>
                                                <th>N√∫mero de Orden</th>
                                                <th>Importe Total</th>
                                                <th>Fecha Finalizaci√≥n</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data['√ìrdenes Realizadas'].map(order => `
                                                <tr>
                                                    <td>${order.numero}</td>
                                                    <td>${parseFloat(order.importe).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                    <td>${getCurrentCaracasDate()}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="total-section">
                                    <h3>Total Certificaci√≥n Final</h3>
                                    <div style="font-size: 16px; color: #9C27B0;">
                                        ${parseFloat(data['Total']).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                    </div>
                                </div>
                                
                                <div class="signature-section">
                                    <div class="signatures-container">
                                        <div class="signature-box">
                                            <strong>Gerente T√©cnico</strong>
                                            <div class="signature-line"></div>
                                        </div>
                                        <div class="signature-box">
                                            <strong>Contratista</strong>
                                            <div class="signature-line"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="footer-text">
                                    Quedan archivadas cada una de las Ordenes de Trabajo finalizadas indicadas en la presente Certificaci√≥n Final.
                                </div>
                            </body>
                            </html>
                        `;

                        const printContainer = document.createElement('div');
                        printContainer.innerHTML = certificationContent;
                        document.body.appendChild(printContainer);

                        const opt = {
                            margin: 8,
                            filename: fileName,
                            image: { 
                                type: 'jpeg', 
                                quality: 0.98 
                            },
                            html2canvas: { 
                                scale: 2,
                                useCORS: true,
                                logging: false,
                                backgroundColor: '#FFFFFF'
                            },
                            jsPDF: { 
                                unit: 'mm', 
                                format: 'a4', 
                                orientation: 'portrait',
                                compress: true
                            }
                        };

                        setTimeout(() => {
                            html2pdf()
                                .set(opt)
                                .from(printContainer)
                                .save()
                                .then(() => {
                                    console.log('PDF de certificaci√≥n final generado exitosamente:', fileName);
                                    if (document.body.contains(printContainer)) {
                                        document.body.removeChild(printContainer);
                                    }
                                    resolve();
                                })
                                .catch(error => {
                                    console.error('Error al generar PDF de certificaci√≥n final:', error);
                                    if (document.body.contains(printContainer)) {
                                        document.body.removeChild(printContainer);
                                    }
                                    reject(error);
                                });
                        }, 1000);

                    } catch (error) {
                        console.error('Error en generateFinalCertificationPDF:', error);
                        reject(error);
                    }
                });
            }

            function renderFinalCertificationsList() {
                const certificationsList = document.getElementById('certifications-list');
                const noResultsDiv = document.getElementById('no-certifications-results');
                
                if (!certificationsList) return;
                
                certificationsList.innerHTML = '';
                
                let filteredCertifications = finalCertifications;
                if (certificationActiveFilters.length > 0) {
                    filteredCertifications = finalCertifications.filter(certification => {
                        return certificationActiveFilters.every(filter => {
                            const fieldValue = certification[filter.field] || '';
                            const filterValue = filter.value;
                            
                            switch (filter.operator) {
                                case 'contains':
                                    return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                                case 'equals':
                                    return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                                case 'startsWith':
                                    return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                                case 'endsWith':
                                    return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                                case 'range':
                                    const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                                    const numValue = parseFloat(fieldValue);
                                    return !isNaN(numValue) && numValue >= min && numValue <= max;
                                case 'greater':
                                    const greaterValue = parseFloat(fieldValue);
                                    const greaterFilter = parseFloat(filterValue);
                                    return !isNaN(greaterValue) && greaterValue > greaterFilter;
                                case 'less':
                                    const lessValue = parseFloat(fieldValue);
                                    const lessFilter = parseFloat(filterValue);
                                    return !isNaN(lessValue) && lessValue < lessFilter;
                                default:
                                    return true;
                            }
                        });
                    });
                }
                
                if (filteredCertifications.length === 0) {
                    noResultsDiv.style.display = 'block';
                    certificationsList.style.display = 'none';
                    return;
                }
                
                noResultsDiv.style.display = 'none';
                certificationsList.style.display = 'block';
                
                const sortedCertifications = [...filteredCertifications].sort((a, b) => {
                    return b['N√∫mero de Certificaci√≥n Final'] - a['N√∫mero de Certificaci√≥n Final'];
                });
                
                sortedCertifications.forEach(certification => {
                    const certificationItem = document.createElement('div');
                    certificationItem.className = 'certification-item';
                    
                    const certificationHeader = document.createElement('div');
                    certificationHeader.className = 'certification-header';
                    
                    const certificationTitle = document.createElement('div');
                    certificationTitle.className = 'certification-title';
                    certificationTitle.textContent = `Certificaci√≥n Final N¬∞ ${certification['N√∫mero de Certificaci√≥n Final']} - ${certification['Empresa']}`;
                    
                    const certificationInfo = document.createElement('div');
                    certificationInfo.className = 'certification-info';
                    certificationInfo.innerHTML = `
                        <div style="font-size: 0.9em; color: #666;">
                            <strong>Total:</strong> ${parseFloat(certification['Total']).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} | 
                            <strong>Fecha:</strong> ${certification['Fecha de Creaci√≥n']} | 
                            <strong>A√±o:</strong> ${certification['A√±o'] || getCurrentCaracasYear()} | 
                            <strong>√ìrdenes:</strong> ${certification['√ìrdenes Realizadas'].length}
                        </div>
                    `;
                    
                    const certificationActions = document.createElement('div');
                    certificationActions.className = 'certification-actions';
                    
                    const pdfButton = document.createElement('button');
                    pdfButton.textContent = 'üìÑ Descargar PDF';
                    pdfButton.className = 'certification-pdf-button';
                    pdfButton.onclick = () => generateFinalCertificationPDF(certification);
                    
                    // Bot√≥n de edici√≥n avanzada para admin
                    if (currentRole === 'admin') {
                        const editButton = document.createElement('button');
                        editButton.textContent = '‚úèÔ∏è Editar Avanzado';
                        editButton.className = 'edit-certified-button';
                        editButton.style.marginLeft = '5px';
                        editButton.onclick = () => openEditCertificationAdvancedModal(certification);
                        certificationActions.appendChild(editButton);
                    }
                    
                    certificationActions.appendChild(pdfButton);
                    certificationHeader.appendChild(certificationTitle);
                    certificationHeader.appendChild(certificationInfo);
                    certificationHeader.appendChild(certificationActions);
                    
                    certificationItem.appendChild(certificationHeader);
                    
                    const ordersList = document.createElement('div');
                    ordersList.className = 'orders-list';
                    
                    certification['√ìrdenes Realizadas'].forEach(order => {
                        const orderItem = document.createElement('div');
                        orderItem.className = 'order-item';
                        
                        const orderInfo = document.createElement('div');
                        orderInfo.innerHTML = `
                            <strong>Orden Finalizada ${order.numero}</strong>
                            <div style="font-size: 0.85em; color: #666;">
                                Importe: ${parseFloat(order.importe).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} | 
                                Fecha Finalizaci√≥n: ${order.fechaFinalizacion}
                            </div>
                        `;
                        
                        const orderActions = document.createElement('div');
                        orderActions.className = 'order-actions';
                        
                        const completeOrder = completedOrders.find(o => o.id === order.id);
                        
                        if (completeOrder) {
                            const certificationPdfButton = document.createElement('button');
                            certificationPdfButton.textContent = 'üìÑ Certificaci√≥n';
                            certificationPdfButton.className = 'order-pdf-button';
                            certificationPdfButton.onclick = () => generateCertificationPDF(completeOrder);
                            
                            const orderPdfButton = document.createElement('button');
                            orderPdfButton.textContent = 'üìã Orden';
                            orderPdfButton.className = 'order-pdf-button';
                            orderPdfButton.onclick = () => generatePDF(completeOrder);
                            
                            orderActions.appendChild(certificationPdfButton);
                            orderActions.appendChild(orderPdfButton);
                        }
                        
                        orderItem.appendChild(orderInfo);
                        orderItem.appendChild(orderActions);
                        ordersList.appendChild(orderItem);
                    });
                    
                    certificationItem.appendChild(ordersList);
                    certificationsList.appendChild(certificationItem);
                });
            }

            // *** 10. FUNCIONES DE EDICI√ìN AVANZADA ***

            // *** 10.1. Renderizar tablas de edici√≥n administrativa avanzada ***
            function renderAdminEditTables() {
                if (currentRole !== 'admin') return;
                
                renderAdminOrdersEditTable();
                renderAdminCompletedEditTable();
                renderAdminCertificationEditList();
            }

            function renderAdminOrdersEditTable() {
                const tbody = document.getElementById('admin-orders-edit-tbody');
                const noResultsDiv = document.getElementById('no-orders-edit-results');
                
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (workOrders.length === 0) {
                    noResultsDiv.style.display = 'block';
                    return;
                }
                
                noResultsDiv.style.display = 'none';
                
                const sortedOrders = sortOrdersByNumberDescending([...workOrders]);
                
                sortedOrders.forEach(order => {
                    const row = tbody.insertRow();
                    
                    row.insertCell().textContent = order['Orden de Trabajo'];
                    row.insertCell().textContent = order['T√≠tulo del Formulario'];
                    row.insertCell().textContent = order['Fecha Actual'] || 'N/A';
                    
                    let empresa = 'No especificada';
                    for (const key in order) {
                        if (key.includes('Empresa') && order[key] && order[key] !== 'N/A' && order[key] !== 'Seleccione una Empresa') {
                            empresa = order[key];
                            break;
                        }
                    }
                    row.insertCell().textContent = empresa;
                    
                    const actionCell = row.insertCell();
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '‚úèÔ∏è Editar';
                    editBtn.className = 'edit-button';
                    editBtn.onclick = () => openEditOrderModal(order);
                    actionCell.appendChild(editBtn);
                });
            }

            function renderAdminCompletedEditTable() {
                const tbody = document.getElementById('admin-completed-edit-tbody');
                const noResultsDiv = document.getElementById('no-completed-edit-results');
                
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (completedOrders.length === 0) {
                    noResultsDiv.style.display = 'block';
                    return;
                }
                
                noResultsDiv.style.display = 'none';
                
                const sortedOrders = sortOrdersByNumberDescending([...completedOrders]);
                
                sortedOrders.forEach(order => {
                    const row = tbody.insertRow();
                    
                    row.insertCell().textContent = order['Orden de Trabajo'];
                    row.insertCell().textContent = order['T√≠tulo del Formulario'];
                    row.insertCell().textContent = order['Fecha de Finalizaci√≥n'] || 'N/A';
                    
                    let empresa = 'No especificada';
                    for (const key in order) {
                        if (key.includes('Empresa') && order[key] && order[key] !== 'N/A' && order[key] !== 'Seleccione una Empresa') {
                            empresa = order[key];
                            break;
                        }
                    }
                    row.insertCell().textContent = empresa;
                    
                    const importe = order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00';
                    row.insertCell().textContent = parseFloat(importe).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    
                    const statusCell = row.insertCell();
                    const certificationStatus = getOrderCertificationStatus(order.id);
                    if (certificationStatus) {
                        statusCell.innerHTML = '<span class="status-badge status-certificada">Certificada</span>';
                    } else {
                        statusCell.innerHTML = '<span class="status-badge status-finalizada">Finalizada</span>';
                    }
                    
                    const actionCell = row.insertCell();
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = certificationStatus ? '‚úèÔ∏è Editar (Certificada)' : '‚úèÔ∏è Editar';
                    editBtn.className = certificationStatus ? 'edit-certified-button' : 'edit-button';
                    editBtn.onclick = () => openEditCompletedAdvancedModal(order);
                    actionCell.appendChild(editBtn);
                });
            }

            function renderAdminCertificationEditList() {
                const container = document.getElementById('admin-certification-edit-list');
                const noResultsDiv = document.getElementById('no-certification-edit-results');
                
                if (!container) return;
                
                container.innerHTML = '';
                
                if (finalCertifications.length === 0) {
                    noResultsDiv.style.display = 'block';
                    return;
                }
                
                noResultsDiv.style.display = 'none';
                
                const sortedCertifications = [...finalCertifications].sort((a, b) => {
                    return b['N√∫mero de Certificaci√≥n Final'] - a['N√∫mero de Certificaci√≥n Final'];
                });
                
                sortedCertifications.forEach(certification => {
                    const certificationDiv = document.createElement('div');
                    certificationDiv.className = 'certification-item';
                    certificationDiv.style.marginBottom = '15px';
                    
                    certificationDiv.innerHTML = `
                        <div class="certification-header">
                            <div class="certification-title">
                                Certificaci√≥n Final N¬∞ ${certification['N√∫mero de Certificaci√≥n Final']} - ${certification['Empresa']}
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                Total: ${parseFloat(certification['Total']).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} | 
                                Fecha: ${certification['Fecha de Creaci√≥n']} | 
                                √ìrdenes: ${certification['√ìrdenes Realizadas'].length}
                            </div>
                            <div>
                                <button class="edit-certified-button" onclick="openEditCertificationAdvancedModal(${JSON.stringify(certification).replace(/"/g, '&quot;')})">
                                    ‚úèÔ∏è Editar Avanzado
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(certificationDiv);
                });
            }

            // *** 10.2. Funciones de b√∫squeda para edici√≥n administrativa avanzada ***
            function searchOrderForEdit() {
                const searchTerm = document.getElementById('admin-edit-order-search').value.toLowerCase();
                const tbody = document.getElementById('admin-orders-edit-tbody');
                const rows = tbody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.getElementsByTagName('td');
                    let found = false;
                    
                    for (let j = 0; j < cells.length - 1; j++) {
                        if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    
                    row.style.display = found ? '' : 'none';
                }
            }

            function searchCompletedOrderForEdit() {
                const searchTerm = document.getElementById('admin-edit-completed-search').value.toLowerCase();
                const tbody = document.getElementById('admin-completed-edit-tbody');
                const rows = tbody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.getElementsByTagName('td');
                    let found = false;
                    
                    for (let j = 0; j < cells.length - 1; j++) {
                        if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    
                    row.style.display = found ? '' : 'none';
                }
            }

            function searchCertificationForEdit() {
                const searchTerm = document.getElementById('admin-edit-certification-search').value.toLowerCase();
                const container = document.getElementById('admin-certification-edit-list');
                const items = container.getElementsByClassName('certification-item');
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? '' : 'none';
                }
            }

            // *** 10.3. Funciones para abrir modales de edici√≥n avanzada ***
            function openEditOrderModal(order) {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede editar √≥rdenes.');
                    return;
                }
                
                editingOrderId = order.id;
                currentEditingOrder = order;
                editingOrderOriginalData = JSON.parse(JSON.stringify(order));
                
                const formContainer = document.getElementById('edit-order-form-container');
                formContainer.innerHTML = '';
                
                formStructure.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'edit-form-section';
                    sectionDiv.innerHTML = `<h4>${section.title}</h4>`;
                    
                    const fieldRow = document.createElement('div');
                    fieldRow.className = 'field-row';
                    
                    section.fields.forEach(field => {
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'field-group';
                        
                        const label = document.createElement('label');
                        label.textContent = field.label + (field.required ? ' *' : '');
                        label.htmlFor = `edit_${field.id}`;
                        
                        let inputHTML = '';
                        const currentValue = order[field.label] || '';
                        
                        if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || 
                            field.type === 'user-auto-fill' || field.type === 'year-auto') {
                            inputHTML = `<input type="text" id="edit_${field.id}" value="${currentValue}" disabled>`;
                        } else if (field.type === 'select') {
                            const options = field.options.map(opt => 
                                `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`
                            ).join('');
                            inputHTML = `<select id="edit_${field.id}">${options}</select>`;
                        } else if (field.type === 'textarea') {
                            inputHTML = `<textarea id="edit_${field.id}" style="min-height: 100px;">${currentValue}</textarea>`;
                        } else if (field.type === 'date-input') {
                            const dateValue = currentValue !== 'N/A' ? formatDateToInput(currentValue) : '';
                            inputHTML = `<input type="date" id="edit_${field.id}" value="${dateValue}">`;
                        } else {
                            inputHTML = `<input type="${field.type}" id="edit_${field.id}" value="${currentValue}">`;
                        }
                        
                        fieldDiv.appendChild(label);
                        fieldDiv.innerHTML += inputHTML;
                        fieldRow.appendChild(fieldDiv);
                    });
                    
                    sectionDiv.appendChild(fieldRow);
                    formContainer.appendChild(sectionDiv);
                });
                
                document.getElementById('edit-order-modal').style.display = 'flex';
            }

            function formatDateToInput(dateString) {
                if (!dateString || dateString === 'N/A') return '';
                
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        return `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                }
                
                return dateString;
            }

            function closeEditOrderModal() {
                document.getElementById('edit-order-modal').style.display = 'none';
                editingOrderId = null;
                currentEditingOrder = null;
                editingOrderOriginalData = null;
            }

            async function saveEditedOrder() {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede editar √≥rdenes.');
                    return;
                }
                
                try {
                    const updatedData = {};
                    const changes = {};
                    
                    formStructure.forEach(section => {
                        section.fields.forEach(field => {
                            const inputElement = document.getElementById(`edit_${field.id}`);
                            if (inputElement && !inputElement.disabled) {
                                let value = inputElement.value;
                                const originalValue = editingOrderOriginalData[field.label] || '';
                                
                                if (field.type === 'date-input' && value) {
                                    value = formatDateToDDMMYYYY(value);
                                }
                                
                                updatedData[field.label] = value;
                                
                                // Registrar cambios
                                if (value !== originalValue) {
                                    changes[field.label] = {
                                        anterior: originalValue,
                                        nuevo: value
                                    };
                                }
                            }
                        });
                    });
                    
                    // Agregar campos de auditor√≠a
                    updatedData['√öltima modificaci√≥n'] = getCurrentCaracasDate();
                    updatedData['Modificado por'] = firebase.auth().currentUser.email;
                    
                    console.log('Actualizando orden con datos:', updatedData);
                    console.log('ID de orden a actualizar:', editingOrderId);
                    
                    await ORDERS_COLLECTION.doc(editingOrderId).update(updatedData);
                    
                    // Registrar historial si hay cambios
                    if (Object.keys(changes).length > 0) {
                        await logChangeHistory(
                            'EDICI√ìN',
                            'Orden de Trabajo (En Curso)',
                            editingOrderId,
                            currentEditingOrder['Orden de Trabajo'],
                            changes,
                            firebase.auth().currentUser.email
                        );
                    }
                    
                    const index = workOrders.findIndex(o => o.id === editingOrderId);
                    if (index !== -1) {
                        workOrders[index] = { ...workOrders[index], ...updatedData };
                    }
                    
                    closeEditOrderModal();
                    renderOrdersTable();
                    renderAdminEditTables();
                    
                    alert('‚úÖ Orden actualizada exitosamente.');
                    
                } catch (error) {
                    console.error('Error al guardar orden editada:', error);
                    console.error('Detalles del error:', error.message);
                    console.error('Stack trace:', error.stack);
                    alert('Error al guardar los cambios: ' + error.message);
                }
            }

            // *** NUEVA FUNCI√ìN: Abrir modal de edici√≥n avanzada para √≥rdenes finalizadas ***
            function openEditCompletedAdvancedModal(order) {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede editar √≥rdenes finalizadas.');
                    return;
                }
                
                editingCompletedOrderId = order.id;
                currentEditingCompletedOrder = order;
                editingOrderOriginalData = JSON.parse(JSON.stringify(order));
                
                // Mostrar n√∫mero de orden en el modal
                document.getElementById('edit-order-number-display').textContent = order['Orden de Trabajo'];
                
                // Verificar si est√° certificada y mostrar advertencia
                const certificationStatus = getOrderCertificationStatus(order.id);
                const warningSection = document.getElementById('edit-certified-warning');
                const certificationList = document.getElementById('certification-list-warning');
                
                if (certificationStatus && certificationStatus.length > 0) {
                    warningSection.style.display = 'block';
                    certificationList.innerHTML = '';
                    
                    certificationStatus.forEach(cert => {
                        const li = document.createElement('li');
                        li.textContent = `Certificaci√≥n Final N¬∞ ${cert.certificationNumber} (${cert.certificationDate})`;
                        certificationList.appendChild(li);
                    });
                } else {
                    warningSection.style.display = 'none';
                }
                
                // Cargar datos b√°sicos
                renderEditCompletedBasicForm(order);
                
                // Cargar datos de certificaci√≥n
                renderEditCompletedCertificationForm(order);
                
                // Cargar historial
                renderEditOrderHistory(order.id);
                
                // Calcular impacto
                calculateEditImpact(order);
                
                document.getElementById('edit-completed-advanced-modal').style.display = 'flex';
            }

            function renderEditCompletedBasicForm(order) {
                const formContainer = document.getElementById('edit-completed-advanced-form-container');
                formContainer.innerHTML = '';
                
                formStructure.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'edit-form-section';
                    sectionDiv.innerHTML = `<h4>${section.title}</h4>`;
                    
                    const fieldRow = document.createElement('div');
                    fieldRow.className = 'field-row';
                    
                    section.fields.forEach(field => {
                        // No mostrar campos que son espec√≠ficos de certificaci√≥n
                        if (field.id === 'ot_number' || field.id === 'form_title' || field.id === 'current_date' || 
                            field.id === 'current_year' || field.id === 'user_auto_fill') {
                            return;
                        }
                        
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'field-group';
                        
                        const label = document.createElement('label');
                        label.textContent = field.label + (field.required ? ' *' : '');
                        label.htmlFor = `edit_completed_${field.id}`;
                        
                        let inputHTML = '';
                        const currentValue = order[field.label] || '';
                        
                        if (field.type === 'select') {
                            const options = field.options.map(opt => 
                                `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`
                            ).join('');
                            inputHTML = `<select id="edit_completed_${field.id}">${options}</select>`;
                        } else if (field.type === 'textarea') {
                            inputHTML = `<textarea id="edit_completed_${field.id}" style="min-height: 100px;">${currentValue}</textarea>`;
                        } else if (field.type === 'date-input') {
                            const dateValue = currentValue !== 'N/A' ? formatDateToInput(currentValue) : '';
                            inputHTML = `<input type="date" id="edit_completed_${field.id}" value="${dateValue}">`;
                        } else {
                            inputHTML = `<input type="${field.type}" id="edit_completed_${field.id}" value="${currentValue}">`;
                        }
                        
                        fieldDiv.appendChild(label);
                        fieldDiv.innerHTML += inputHTML;
                        fieldRow.appendChild(fieldDiv);
                    });
                    
                    sectionDiv.appendChild(fieldRow);
                    formContainer.appendChild(sectionDiv);
                });
            }

            function renderEditCompletedCertificationForm(order) {
                const container = document.getElementById('edit-order-certification-container');
                container.innerHTML = '';
                
                const certification = order['Certificaci√≥n'] || {};
                
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'edit-form-section';
                sectionDiv.innerHTML = `<h4>Datos de Certificaci√≥n de Obra</h4>`;
                
                const fields = [
                    { label: 'Fecha de Inicio', id: 'cert_fecha_inicio', value: certification['Fecha de Inicio'] || '', type: 'date' },
                    { label: 'Fecha de Fin', id: 'cert_fecha_fin', value: certification['Fecha de Fin'] || '', type: 'date' },
                    { label: 'Importe Total de la Obra', id: 'cert_importe_total', value: certification['Importe Total de la Obra'] || '0.00', type: 'number' },
                    { label: 'Detalle de Trabajos Realizados', id: 'cert_detalle', value: certification['Detalle de Trabajos Realizados'] || '', type: 'textarea' },
                    { label: 'Desviaciones y Justificaci√≥n', id: 'cert_desviaciones', value: certification['Desviaciones y Justificaci√≥n'] || '', type: 'textarea' }
                ];
                
                fields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-group';
                    fieldDiv.style.marginBottom = '15px';
                    
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    label.htmlFor = field.id;
                    
                    let input;
                    if (field.type === 'textarea') {
                        input = document.createElement('textarea');
                        input.id = field.id;
                        input.value = field.value;
                        input.style.minHeight = '80px';
                        input.style.width = '100%';
                    } else if (field.type === 'date') {
                        input = document.createElement('input');
                        input.type = 'date';
                        input.id = field.id;
                        input.value = field.value !== '' ? formatDateToInput(field.value) : '';
                        input.style.width = '100%';
                    } else if (field.type === 'number') {
                        input = document.createElement('input');
                        input.type = 'number';
                        input.id = field.id;
                        input.value = field.value;
                        input.step = '0.01';
                        input.style.width = '100%';
                    } else {
                        input = document.createElement('input');
                        input.type = 'text';
                        input.id = field.id;
                        input.value = field.value;
                        input.style.width = '100%';
                    }
                    
                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                    sectionDiv.appendChild(fieldDiv);
                });
                
                container.appendChild(sectionDiv);
            }

            function renderEditOrderHistory(orderId) {
                const container = document.getElementById('edit-order-history-container');
                container.innerHTML = '';
                
                const orderHistory = changeHistory.filter(entry => 
                    (entry.entityType === 'Orden de Trabajo' || entry.entityType === 'Orden de Trabajo (En Curso)') && 
                    entry.entityId === orderId
                ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (orderHistory.length === 0) {
                    container.innerHTML = '<p>No hay historial de cambios para esta orden.</p>';
                    return;
                }
                
                orderHistory.forEach(entry => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    let changesText = '';
                    if (entry.changes && typeof entry.changes === 'object') {
                        Object.keys(entry.changes).forEach(field => {
                            if (entry.changes[field].anterior && entry.changes[field].nuevo) {
                                changesText += `<strong>${field}:</strong> "${entry.changes[field].anterior}" ‚Üí "${entry.changes[field].nuevo}"<br>`;
                            }
                        });
                    }
                    
                    historyItem.innerHTML = `
                        <div class="history-date">${entry.date} ${entry.time}</div>
                        <div class="history-action">
                            <strong>${entry.action}</strong> por ${entry.userId}<br>
                            ${changesText || 'Sin detalles espec√≠ficos'}
                        </div>
                    `;
                    
                    container.appendChild(historyItem);
                });
            }

            function calculateEditImpact(order) {
                const container = document.getElementById('edit-order-impact-container');
                container.innerHTML = '';
                
                const certificationStatus = getOrderCertificationStatus(order.id);
                
                if (!certificationStatus || certificationStatus.length === 0) {
                    container.innerHTML = `
                        <h5>‚úÖ Sin Impacto en Certificaciones</h5>
                        <p>Esta orden no est√° incluida en ninguna certificaci√≥n final. Los cambios solo afectar√°n a esta orden.</p>
                    `;
                    return;
                }
                
                let impactHTML = `<h5>‚ö†Ô∏è IMPACTO EN CERTIFICACIONES FINALES</h5>`;
                impactHTML += `<p>Esta orden est√° incluida en ${certificationStatus.length} certificaci√≥n(es) final(es):</p>`;
                impactHTML += `<ul style="margin-left: 20px;">`;
                
                certificationStatus.forEach(cert => {
                    const currentImporte = parseFloat(cert.orderInCertification.importe) || 0;
                    impactHTML += `<li><strong>Certificaci√≥n Final N¬∞ ${cert.certificationNumber}:</strong> Importe actual: ${currentImporte.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</li>`;
                });
                
                impactHTML += `</ul>`;
                impactHTML += `<p><strong>ADVERTENCIA:</strong> Si modifica el importe de esta orden, deber√° recalcular manualmente los totales de las certificaciones afectadas.</p>`;
                impactHTML += `<p>Puede usar la herramienta "Recalcular Todos los Totales" en la pesta√±a de Edici√≥n Avanzada.</p>`;
                
                container.innerHTML = impactHTML;
            }

            function closeEditCompletedAdvancedModal() {
                document.getElementById('edit-completed-advanced-modal').style.display = 'none';
                editingCompletedOrderId = null;
                currentEditingCompletedOrder = null;
                editingOrderOriginalData = null;
            }

            async function saveEditedCompletedOrderAdvanced() {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede editar √≥rdenes finalizadas.');
                    return;
                }
                
                try {
                    // 1. Verificar que el documento existe
                    const docRef = COMPLETED_ORDERS_COLLECTION.doc(editingCompletedOrderId);
                    const doc = await docRef.get();
                    
                    if (!doc.exists) {
                        throw new Error(`El documento con ID ${editingCompletedOrderId} no existe.`);
                    }
                    
                    console.log('Documento encontrado. Actualizando datos...');
                    
                    // 2. Recopilar datos del formulario b√°sico
                    const updatedBasicData = {};
                    const basicChanges = {};
                    
                    formStructure.forEach(section => {
                        section.fields.forEach(field => {
                            // No incluir campos espec√≠ficos de certificaci√≥n
                            if (field.id === 'ot_number' || field.id === 'form_title' || field.id === 'current_date' || 
                                field.id === 'current_year' || field.id === 'user_auto_fill') {
                                return;
                            }
                            
                            const inputElement = document.getElementById(`edit_completed_${field.id}`);
                            if (inputElement) {
                                let value = inputElement.value;
                                const originalValue = editingOrderOriginalData[field.label] || '';
                                
                                if (field.type === 'date-input' && value) {
                                    value = formatDateToDDMMYYYY(value);
                                }
                                
                                updatedBasicData[field.label] = value;
                                
                                // Registrar cambios
                                if (value !== originalValue) {
                                    basicChanges[field.label] = {
                                        anterior: originalValue,
                                        nuevo: value
                                    };
                                }
                            }
                        });
                    });
                    
                    // 3. Recopilar datos de certificaci√≥n
                    const updatedCertification = {
                        'Fecha de Inicio': formatDateToDDMMYYYY(document.getElementById('cert_fecha_inicio').value),
                        'Fecha de Fin': formatDateToDDMMYYYY(document.getElementById('cert_fecha_fin').value),
                        'Importe Total de la Obra': document.getElementById('cert_importe_total').value,
                        'Detalle de Trabajos Realizados': document.getElementById('cert_detalle').value,
                        'Desviaciones y Justificaci√≥n': document.getElementById('cert_desviaciones').value
                    };
                    
                    // 4. Verificar cambios en el importe
                    const originalImporte = editingOrderOriginalData['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00';
                    const nuevoImporte = updatedCertification['Importe Total de la Obra'];
                    let importeChanged = false;
                    
                    if (parseFloat(originalImporte) !== parseFloat(nuevoImporte)) {
                        importeChanged = true;
                        basicChanges['Importe Total de la Obra'] = {
                            anterior: originalImporte,
                            nuevo: nuevoImporte
                        };
                    }
                    
                    // 5. Preparar datos finales para actualizaci√≥n
                    const updatedData = {
                        ...updatedBasicData,
                        'Certificaci√≥n': updatedCertification,
                        '√öltima modificaci√≥n': getCurrentCaracasDate(),
                        'Modificado por': firebase.auth().currentUser.email
                    };
                    
                    console.log('Actualizando orden finalizada con datos:', updatedData);
                    console.log('ID de orden finalizada a actualizar:', editingCompletedOrderId);
                    
                    // 6. Actualizar en Firebase
                    await docRef.update(updatedData);
                    
                    // 7. Actualizar en el array local
                    const index = completedOrders.findIndex(o => o.id === editingCompletedOrderId);
                    if (index !== -1) {
                        completedOrders[index] = { 
                            ...completedOrders[index], 
                            ...updatedData,
                            'Certificaci√≥n': { ...completedOrders[index]['Certificaci√≥n'], ...updatedCertification }
                        };
                    }
                    
                    // 8. Registrar en historial si hay cambios
                    if (Object.keys(basicChanges).length > 0) {
                        await logChangeHistory(
                            'EDICI√ìN',
                            'Orden de Trabajo (Finalizada)',
                            editingCompletedOrderId,
                            currentEditingCompletedOrder['Orden de Trabajo'],
                            basicChanges,
                            firebase.auth().currentUser.email
                        );
                    }
                    
                    // 9. Si cambi√≥ el importe y est√° certificada, actualizar certificaciones
                    if (importeChanged) {
                        const certificationStatus = getOrderCertificationStatus(editingCompletedOrderId);
                        if (certificationStatus && certificationStatus.length > 0) {
                            await updateCertificationsWithNewImporte(editingCompletedOrderId, nuevoImporte);
                        }
                    }
                    
                    closeEditCompletedAdvancedModal();
                    renderCompletedOrdersTable();
                    renderAdminEditTables();
                    renderFinalCertificationsList();
                    
                    alert('‚úÖ Orden finalizada actualizada exitosamente.');
                    
                } catch (error) {
                    console.error('Error al guardar orden finalizada editada:', error);
                    console.error('Detalles del error:', error.message);
                    console.error('C√≥digo del error:', error.code);
                    
                    let errorMessage = 'Error al guardar los cambios: ';
                    
                    if (error.message.includes('no existe')) {
                        errorMessage += 'La orden ya no existe en la base de datos. ';
                        errorMessage += 'Puede que haya sido eliminada mientras editaba. ';
                        
                        // Eliminar del array local si existe
                        completedOrders = completedOrders.filter(o => o.id !== editingCompletedOrderId);
                        renderCompletedOrdersTable();
                        renderAdminEditTables();
                    } else if (error.code === 'permission-denied') {
                        errorMessage += 'No tiene permisos para editar esta orden.';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    alert(errorMessage);
                }
            }

            async function updateCertificationsWithNewImporte(orderId, nuevoImporte) {
                try {
                    const certificationStatus = getOrderCertificationStatus(orderId);
                    if (!certificationStatus) return;
                    
                    for (const cert of certificationStatus) {
                        const certRef = FINAL_CERTIFICATIONS_COLLECTION.doc(cert.certificationId);
                        const certDoc = await certRef.get();
                        
                        if (certDoc.exists) {
                            const certificationData = certDoc.data();
                            const orders = certificationData['√ìrdenes Realizadas'] || [];
                            
                            // Actualizar el importe en la orden espec√≠fica
                            const updatedOrders = orders.map(order => {
                                if (order.id === orderId) {
                                    return { ...order, importe: nuevoImporte };
                                }
                                return order;
                            });
                            
                            // Recalcular total
                            const nuevoTotal = updatedOrders.reduce((sum, order) => {
                                return sum + (parseFloat(order.importe) || 0);
                            }, 0);
                            
                            // Actualizar certificaci√≥n
                            await certRef.update({
                                '√ìrdenes Realizadas': updatedOrders,
                                'Total': nuevoTotal.toFixed(2),
                                '√öltima modificaci√≥n': getCurrentCaracasDate(),
                                'Modificado por': firebase.auth().currentUser.email
                            });
                            
                            // Actualizar array local
                            const certIndex = finalCertifications.findIndex(c => c.id === cert.certificationId);
                            if (certIndex !== -1) {
                                finalCertifications[certIndex] = {
                                    ...finalCertifications[certIndex],
                                    '√ìrdenes Realizadas': updatedOrders,
                                    'Total': nuevoTotal.toFixed(2)
                                };
                            }
                            
                            // Registrar historial
                            await logChangeHistory(
                                'ACTUALIZACI√ìN AUTOM√ÅTICA',
                                'Certificaci√≥n Final',
                                cert.certificationId,
                                certificationData['N√∫mero de Certificaci√≥n Final'],
                                { 
                                    motivo: 'actualizacion_importe_orden',
                                    orden_afectada: currentEditingCompletedOrder['Orden de Trabajo'],
                                    importe_anterior: cert.orderInCertification.importe,
                                    importe_nuevo: nuevoImporte,
                                    total_anterior: certificationData['Total'],
                                    total_nuevo: nuevoTotal.toFixed(2)
                                },
                                firebase.auth().currentUser.email
                            );
                        }
                    }
                    
                    console.log('Certificaciones actualizadas con nuevo importe');
                    
                } catch (error) {
                    console.error('Error al actualizar certificaciones:', error);
                }
            }

            // *** 10.4. Funciones para editar certificaciones finales (avanzado) ***
            function openEditCertificationAdvancedModal(certification) {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede editar certificaciones finales.');
                    return;
                }
                
                editingCertificationId = certification.id;
                currentEditingCertification = certification;
                editingCertificationOriginalData = JSON.parse(JSON.stringify(certification));
                
                // Mostrar n√∫mero de certificaci√≥n en el modal
                document.getElementById('edit-cert-number-display').textContent = certification['N√∫mero de Certificaci√≥n Final'];
                
                // Cargar datos b√°sicos
                renderEditCertificationBasicForm(certification);
                
                // Cargar gesti√≥n de √≥rdenes
                renderEditCertificationOrders(certification);
                
                // Cargar rec√°lculo de total
                renderEditCertificationTotal(certification);
                
                document.getElementById('edit-certification-advanced-modal').style.display = 'flex';
            }

            function renderEditCertificationBasicForm(certification) {
                const formContainer = document.getElementById('edit-certification-advanced-form-container');
                formContainer.innerHTML = '';
                
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'edit-form-section';
                sectionDiv.innerHTML = `<h4>Datos B√°sicos de la Certificaci√≥n</h4>`;
                
                const fields = [
                    { label: 'N√∫mero de Certificaci√≥n Final', id: 'edit_cert_number', value: certification['N√∫mero de Certificaci√≥n Final'], disabled: true },
                    { label: 'A√±o', id: 'edit_cert_year', value: certification['A√±o'] || getCurrentCaracasYear(), disabled: false },
                    { label: 'Empresa', id: 'edit_cert_empresa', value: certification['Empresa'], disabled: false },
                    { label: 'Fecha de Creaci√≥n', id: 'edit_cert_fecha', value: certification['Fecha de Creaci√≥n'], disabled: false }
                ];
                
                const fieldRow = document.createElement('div');
                fieldRow.className = 'field-row';
                
                fields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-group';
                    
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    label.htmlFor = field.id;
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = field.id;
                    input.value = field.value;
                    input.disabled = field.disabled;
                    
                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                    fieldRow.appendChild(fieldDiv);
                });
                
                sectionDiv.appendChild(fieldRow);
                formContainer.appendChild(sectionDiv);
            }

            function renderEditCertificationOrders(certification) {
                const container = document.getElementById('edit-certification-orders-container');
                container.innerHTML = '';
                
                // Lista de √≥rdenes actuales
                const currentOrdersSection = document.createElement('div');
                currentOrdersSection.className = 'edit-form-section';
                currentOrdersSection.innerHTML = `<h4>√ìrdenes Actuales en esta Certificaci√≥n</h4>`;
                
                const ordersList = document.createElement('div');
                ordersList.className = 'available-orders-list';
                
                certification['√ìrdenes Realizadas'].forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-edit-item';
                    orderItem.dataset.orderId = order.id;
                    
                    const orderInfo = document.createElement('div');
                    orderInfo.innerHTML = `
                        <strong>Orden de Trabajo ${order.numero}</strong>
                        <div style="font-size: 0.85em; color: #666;">
                            Importe: ${parseFloat(order.importe).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </div>
                    `;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = '‚ùå Quitar';
                    removeBtn.className = 'remove-order-button';
                    removeBtn.onclick = () => removeOrderFromCertificationAdvanced(order.id);
                    
                    orderItem.appendChild(orderInfo);
                    orderItem.appendChild(removeBtn);
                    ordersList.appendChild(orderItem);
                });
                
                currentOrdersSection.appendChild(ordersList);
                container.appendChild(currentOrdersSection);
                
                // √ìrdenes disponibles para agregar
                const availableOrders = completedOrders.filter(order => {
                    // Verificar que no est√© ya en esta certificaci√≥n
                    const isInThisCertification = certification['√ìrdenes Realizadas'].some(o => o.id === order.id);
                    if (isInThisCertification) return false;
                    
                    // Verificar empresa
                    let empresa = '';
                    for (const key in order) {
                        if (key.includes('Empresa') && order[key] && order[key] !== 'N/A' && order[key] !== 'Seleccione una Empresa') {
                            empresa = order[key];
                            break;
                        }
                    }
                    
                    return empresa === certification['Empresa'];
                });
                
                if (availableOrders.length > 0) {
                    const addOrdersSection = document.createElement('div');
                    addOrdersSection.className = 'edit-form-section';
                    addOrdersSection.innerHTML = '<h4>Agregar √ìrdenes Disponibles</h4>';
                    
                    const availableList = document.createElement('div');
                    availableList.className = 'available-orders-list';
                    
                    availableOrders.forEach(order => {
                        const orderItem = document.createElement('div');
                        orderItem.className = 'order-edit-item';
                        orderItem.dataset.orderId = order.id;
                        
                        const orderInfo = document.createElement('div');
                        orderInfo.innerHTML = `
                            <strong>Orden de Trabajo ${order['Orden de Trabajo']}</strong>
                            <div style="font-size: 0.85em; color: #666;">
                                Importe: ${parseFloat(order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00').toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} | 
                                Fecha Finalizaci√≥n: ${order['Fecha de Finalizaci√≥n'] || 'N/A'}
                            </div>
                        `;
                        
                        const addBtn = document.createElement('button');
                        addBtn.textContent = '‚ûï Agregar';
                        addBtn.className = 'add-order-button';
                        addBtn.onclick = () => addOrderToCertificationAdvanced(order.id);
                        
                        orderItem.appendChild(orderInfo);
                        orderItem.appendChild(addBtn);
                        availableList.appendChild(orderItem);
                    });
                    
                    addOrdersSection.appendChild(availableList);
                    container.appendChild(addOrdersSection);
                }
            }

            function renderEditCertificationTotal(certification) {
                const container = document.getElementById('edit-certification-total-container');
                container.innerHTML = '';
                
                const totalSection = document.createElement('div');
                totalSection.className = 'edit-form-section';
                totalSection.innerHTML = '<h4>Recalcular Total</h4>';
                
                // Calcular total actual
                const currentTotal = certification['√ìrdenes Realizadas'].reduce((sum, order) => {
                    return sum + (parseFloat(order.importe) || 0);
                }, 0);
                
                totalSection.innerHTML += `
                    <p><strong>Total Actual:</strong> ${parseFloat(certification['Total']).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                    <p><strong>Total Calculado:</strong> ${currentTotal.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                `;
                
                if (Math.abs(parseFloat(certification['Total']) - currentTotal) > 0.01) {
                    totalSection.innerHTML += `
                        <div class="warning-section">
                            <h5>‚ö†Ô∏è DESAJUSTE DETECTADO</h5>
                            <p>El total almacenado no coincide con la suma de los importes de las √≥rdenes.</p>
                            <p>Diferencia: ${Math.abs(parseFloat(certification['Total']) - currentTotal).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            <button class="certification-button" onclick="recalculateCertificationTotal()" style="margin-top: 10px;">
                                üîÑ Recalcular Total Autom√°ticamente
                            </button>
                        </div>
                    `;
                } else {
                    totalSection.innerHTML += `
                        <p style="color: var(--color-success);">‚úÖ El total est√° correctamente calculado.</p>
                    `;
                }
                
                container.appendChild(totalSection);
            }

            function removeOrderFromCertificationAdvanced(orderId) {
                if (!confirm('¬øEst√° seguro de que desea quitar esta orden de la certificaci√≥n final?')) {
                    return;
                }
                
                const order = currentEditingCertification['√ìrdenes Realizadas'].find(o => o.id === orderId);
                if (!order) return;
                
                currentEditingCertification['√ìrdenes Realizadas'] = currentEditingCertification['√ìrdenes Realizadas'].filter(o => o.id !== orderId);
                
                // Recalcular total
                const nuevoTotal = currentEditingCertification['√ìrdenes Realizadas'].reduce((sum, order) => {
                    return sum + (parseFloat(order.importe) || 0);
                }, 0);
                
                currentEditingCertification['Total'] = nuevoTotal.toFixed(2);
                
                openEditCertificationAdvancedModal(currentEditingCertification);
            }

            function addOrderToCertificationAdvanced(orderId) {
                const order = completedOrders.find(o => o.id === orderId);
                if (!order) return;
                
                const newOrder = {
                    id: order.id,
                    numero: order['Orden de Trabajo'],
                    importe: order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00',
                    fechaFinalizacion: order['Fecha de Finalizaci√≥n'] || 'N/A'
                };
                
                currentEditingCertification['√ìrdenes Realizadas'].push(newOrder);
                
                // Recalcular total
                const nuevoTotal = currentEditingCertification['√ìrdenes Realizadas'].reduce((sum, order) => {
                    return sum + (parseFloat(order.importe) || 0);
                }, 0);
                
                currentEditingCertification['Total'] = nuevoTotal.toFixed(2);
                
                openEditCertificationAdvancedModal(currentEditingCertification);
            }

            function recalculateCertificationTotal() {
                const nuevoTotal = currentEditingCertification['√ìrdenes Realizadas'].reduce((sum, order) => {
                    return sum + (parseFloat(order.importe) || 0);
                }, 0);
                
                currentEditingCertification['Total'] = nuevoTotal.toFixed(2);
                
                openEditCertificationAdvancedModal(currentEditingCertification);
            }

            function closeEditCertificationAdvancedModal() {
                document.getElementById('edit-certification-advanced-modal').style.display = 'none';
                editingCertificationId = null;
                currentEditingCertification = null;
                editingCertificationOriginalData = null;
            }

            async function saveEditedCertificationAdvanced() {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede editar certificaciones finales.');
                    return;
                }
                
                if (currentEditingCertification['√ìrdenes Realizadas'].length === 0) {
                    alert('La certificaci√≥n final debe contener al menos una orden.');
                    return;
                }
                
                try {
                    // Verificar que el documento existe
                    const docRef = FINAL_CERTIFICATIONS_COLLECTION.doc(editingCertificationId);
                    const doc = await docRef.get();
                    
                    if (!doc.exists) {
                        throw new Error(`La certificaci√≥n con ID ${editingCertificationId} no existe.`);
                    }
                    
                    // Recopilar cambios
                    const changes = {};
                    const originalData = editingCertificationOriginalData;
                    
                    // Verificar cambios en datos b√°sicos
                    const basicFields = ['A√±o', 'Empresa', 'Fecha de Creaci√≥n'];
                    basicFields.forEach(field => {
                        const inputElement = document.getElementById(`edit_cert_${field.toLowerCase()}`);
                        if (inputElement) {
                            const newValue = inputElement.value;
                            const oldValue = originalData[field] || '';
                            
                            if (newValue !== oldValue) {
                                changes[field] = {
                                    anterior: oldValue,
                                    nuevo: newValue
                                };
                            }
                        }
                    });
                    
                    // Verificar cambios en √≥rdenes
                    const originalOrders = originalData['√ìrdenes Realizadas'] || [];
                    const newOrders = currentEditingCertification['√ìrdenes Realizadas'] || [];
                    
                    // Verificar √≥rdenes agregadas
                    const addedOrders = newOrders.filter(newOrder => 
                        !originalOrders.some(originalOrder => originalOrder.id === newOrder.id)
                    );
                    
                    // Verificar √≥rdenes eliminadas
                    const removedOrders = originalOrders.filter(originalOrder => 
                        !newOrders.some(newOrder => newOrder.id === originalOrder.id)
                    );
                    
                    if (addedOrders.length > 0) {
                        changes['√≥rdenes_agregadas'] = {
                            cantidad: addedOrders.length,
                            √≥rdenes: addedOrders.map(o => o.numero).join(', ')
                        };
                    }
                    
                    if (removedOrders.length > 0) {
                        changes['√≥rdenes_eliminadas'] = {
                            cantidad: removedOrders.length,
                            √≥rdenes: removedOrders.map(o => o.numero).join(', ')
                        };
                    }
                    
                    // Verificar cambio en total
                    const originalTotal = parseFloat(originalData['Total']) || 0;
                    const newTotal = parseFloat(currentEditingCertification['Total']) || 0;
                    
                    if (Math.abs(originalTotal - newTotal) > 0.01) {
                        changes['total'] = {
                            anterior: originalTotal.toFixed(2),
                            nuevo: newTotal.toFixed(2)
                        };
                    }
                    
                    // Preparar datos actualizados
                    const updatedData = {
                        'A√±o': document.getElementById('edit_cert_year').value,
                        'Empresa': document.getElementById('edit_cert_empresa').value,
                        'Fecha de Creaci√≥n': document.getElementById('edit_cert_fecha').value,
                        '√ìrdenes Realizadas': currentEditingCertification['√ìrdenes Realizadas'],
                        'Total': currentEditingCertification['Total'],
                        '√öltima modificaci√≥n': getCurrentCaracasDate(),
                        'Modificado por': firebase.auth().currentUser.email
                    };
                    
                    console.log('Actualizando certificaci√≥n final con datos:', updatedData);
                    console.log('ID de certificaci√≥n a actualizar:', editingCertificationId);
                    
                    // Actualizar en Firebase
                    await docRef.update(updatedData);
                    
                    // Actualizar en el array local
                    const index = finalCertifications.findIndex(c => c.id === editingCertificationId);
                    if (index !== -1) {
                        finalCertifications[index] = { 
                            ...finalCertifications[index], 
                            ...updatedData 
                        };
                    }
                    
                    // Registrar en historial si hay cambios
                    if (Object.keys(changes).length > 0) {
                        await logChangeHistory(
                            'EDICI√ìN',
                            'Certificaci√≥n Final',
                            editingCertificationId,
                            currentEditingCertification['N√∫mero de Certificaci√≥n Final'],
                            changes,
                            firebase.auth().currentUser.email
                        );
                    }
                    
                    closeEditCertificationAdvancedModal();
                    renderFinalCertificationsList();
                    renderAdminEditTables();
                    renderCompletedOrdersTable();
                    
                    alert('‚úÖ Certificaci√≥n final actualizada exitosamente.');
                    
                } catch (error) {
                    console.error('Error al guardar certificaci√≥n editada:', error);
                    console.error('Detalles del error:', error.message);
                    alert('Error al guardar los cambios: ' + error.message);
                }
            }

            // *** 10.5. Funciones para recalcular totales de certificaciones ***
            async function recalculateAllCertificationTotals() {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede recalcular totales.');
                    return;
                }
                
                if (!confirm('¬øEst√° seguro de que desea recalcular todos los totales de las certificaciones finales?\n\nEsta acci√≥n revisar√° todas las certificaciones y corregir√° cualquier desajuste.')) {
                    return;
                }
                
                try {
                    const resultsDiv = document.getElementById('recalculation-results');
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = '<p>üîç Recalculando totales... Por favor espere.</p>';
                    
                    let updatedCount = 0;
                    let detailsHTML = '<h5>Resultados del Recalculo:</h5><ul>';
                    
                    for (const certification of finalCertifications) {
                        // Calcular total basado en √≥rdenes
                        const calculatedTotal = certification['√ìrdenes Realizadas'].reduce((sum, order) => {
                            return sum + (parseFloat(order.importe) || 0);
                        }, 0);
                        
                        const storedTotal = parseFloat(certification['Total']) || 0;
                        const difference = Math.abs(storedTotal - calculatedTotal);
                        
                        if (difference > 0.01) {
                            // Actualizar certificaci√≥n
                            const certRef = FINAL_CERTIFICATIONS_COLLECTION.doc(certification.id);
                            await certRef.update({
                                'Total': calculatedTotal.toFixed(2),
                                '√öltima modificaci√≥n': getCurrentCaracasDate(),
                                'Modificado por': firebase.auth().currentUser.email
                            });
                            
                            // Actualizar array local
                            const index = finalCertifications.findIndex(c => c.id === certification.id);
                            if (index !== -1) {
                                finalCertifications[index]['Total'] = calculatedTotal.toFixed(2);
                            }
                            
                            // Registrar historial
                            await logChangeHistory(
                                'RECALCULO AUTOM√ÅTICO',
                                'Certificaci√≥n Final',
                                certification.id,
                                certification['N√∫mero de Certificaci√≥n Final'],
                                { 
                                    total_anterior: storedTotal.toFixed(2),
                                    total_nuevo: calculatedTotal.toFixed(2),
                                    diferencia: difference.toFixed(2)
                                },
                                firebase.auth().currentUser.email
                            );
                            
                            updatedCount++;
                            detailsHTML += `<li>${certification['N√∫mero de Certificaci√≥n Final']}: ${storedTotal.toFixed(2)} ‚Üí ${calculatedTotal.toFixed(2)} (diferencia: ${difference.toFixed(2)})</li>`;
                        }
                    }
                    
                    detailsHTML += '</ul>';
                    
                    if (updatedCount === 0) {
                        resultsDiv.innerHTML = '<p>‚úÖ Todos los totales est√°n correctamente calculados. No se realizaron cambios.</p>';
                    } else {
                        resultsDiv.innerHTML = `<p>‚úÖ ${updatedCount} certificaci√≥n(es) actualizada(s).</p>${detailsHTML}`;
                        
                        // Recargar datos
                        renderFinalCertificationsList();
                        renderAdminEditTables();
                    }
                    
                } catch (error) {
                    console.error('Error al recalcular totales:', error);
                    const resultsDiv = document.getElementById('recalculation-results');
                    resultsDiv.innerHTML = `<p style="color: var(--color-error);">‚ùå Error al recalcular totales: ${error.message}</p>`;
                }
            }

            function showCertificationRecalculationReport() {
                const resultsDiv = document.getElementById('recalculation-results');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<h5>Reporte de Desajustes en Totales</h5>';
                
                let hasIssues = false;
                let reportHTML = '<ul>';
                
                finalCertifications.forEach(certification => {
                    // Calcular total basado en √≥rdenes
                    const calculatedTotal = certification['√ìrdenes Realizadas'].reduce((sum, order) => {
                        return sum + (parseFloat(order.importe) || 0);
                    }, 0);
                    
                    const storedTotal = parseFloat(certification['Total']) || 0;
                    const difference = Math.abs(storedTotal - calculatedTotal);
                    
                    if (difference > 0.01) {
                        hasIssues = true;
                        reportHTML += `
                            <li>
                                <strong>${certification['N√∫mero de Certificaci√≥n Final']}</strong> - ${certification['Empresa']}<br>
                                Total almacenado: ${storedTotal.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}<br>
                                Total calculado: ${calculatedTotal.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}<br>
                                <span style="color: var(--color-warning);">Diferencia: ${difference.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </li>
                        `;
                    }
                });
                
                reportHTML += '</ul>';
                
                if (!hasIssues) {
                    resultsDiv.innerHTML += '<p>‚úÖ No se detectaron desajustes en los totales de las certificaciones.</p>';
                } else {
                    resultsDiv.innerHTML += reportHTML;
                    resultsDiv.innerHTML += `
                        <div style="margin-top: 15px;">
                            <button class="certification-button" onclick="recalculateAllCertificationTotals()">
                                üîÑ Recalcular Todos los Totales
                            </button>
                        </div>
                    `;
                }
            }

            // *** 11. FUNCIONES DE GESTI√ìN DE EMPRESAS ***

            function renderCompaniesTable() {
                const companyManagement = document.getElementById('company-management');
                const companyAccessDenied = document.getElementById('company-access-denied');
                const tbody = document.getElementById('companies-table-body');
                const noCompaniesMessage = document.getElementById('no-companies-message');
                
                if (currentRole === 'admin') {
                    companyManagement.style.display = 'block';
                    companyAccessDenied.style.display = 'none';
                    
                    tbody.innerHTML = '';
                    
                    if (companies.length === 0) {
                        noCompaniesMessage.style.display = 'block';
                        return;
                    }
                    
                    noCompaniesMessage.style.display = 'none';
                    
                    companies.forEach(company => {
                        const row = tbody.insertRow();
                        
                        row.insertCell().textContent = company.name;
                        row.insertCell().textContent = company.responsible;
                        row.insertCell().textContent = company.rif;
                        
                        const actionCell = row.insertCell();
                        
                        const editBtn = document.createElement('button');
                        editBtn.textContent = '‚úèÔ∏è Editar';
                        editBtn.style.backgroundColor = '#FFB347';
                        editBtn.style.color = 'white';
                        editBtn.style.marginRight = '5px';
                        editBtn.onclick = () => editCompany(company);
                        actionCell.appendChild(editBtn);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                        deleteBtn.style.backgroundColor = 'var(--color-error)';
                        deleteBtn.style.color = 'white';
                        deleteBtn.onclick = () => deleteCompany(company.id, company.name);
                        actionCell.appendChild(deleteBtn);
                    });
                    
                } else {
                    companyManagement.style.display = 'none';
                    companyAccessDenied.style.display = 'block';
                }
            }

            function validateCompanyForm() {
                const name = document.getElementById('company-name').value.trim();
                const responsible = document.getElementById('company-responsible').value.trim();
                const rif = document.getElementById('company-rif').value.trim();
                
                if (!name) {
                    alert('El nombre de la empresa es obligatorio.');
                    document.getElementById('company-name').focus();
                    return false;
                }
                
                if (!responsible) {
                    alert('El nombre del responsable es obligatorio.');
                    document.getElementById('company-responsible').focus();
                    return false;
                }
                
                if (!rif) {
                    alert('El RIF es obligatorio.');
                    document.getElementById('company-rif').focus();
                    return false;
                }
                
                const rifRegex = /^[JGV]-\d{8,9}-\d$/i;
                if (!rifRegex.test(rif)) {
                    alert('El formato del RIF no es v√°lido. Debe ser: J-XXXXXXXX-X');
                    document.getElementById('company-rif').focus();
                    return false;
                }
                
                return true;
            }

            async function saveCompany() {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede gestionar empresas.');
                    return;
                }
                
                if (!validateCompanyForm()) {
                    return;
                }
                
                const name = document.getElementById('company-name').value.trim();
                const responsible = document.getElementById('company-responsible').value.trim();
                const rif = document.getElementById('company-rif').value.trim();
                const companyId = document.getElementById('company-id').value;
                
                const companyData = {
                    name: name,
                    responsible: responsible,
                    rif: rif,
                    updatedAt: new Date().toISOString(),
                    updatedBy: firebase.auth().currentUser.email
                };
                
                try {
                    if (companyId) {
                        await COMPANIES_COLLECTION.doc(companyId).update(companyData);
                        
                        const index = companies.findIndex(c => c.id === companyId);
                        if (index !== -1) {
                            companies[index] = { ...companies[index], ...companyData };
                        }
                        
                        alert('‚úÖ Empresa actualizada exitosamente.');
                    } else {
                        companyData.createdAt = new Date().toISOString();
                        companyData.createdBy = firebase.auth().currentUser.email;
                        
                        const docRef = await COMPANIES_COLLECTION.add(companyData);
                        
                        companies.push({
                            id: docRef.id,
                            ...companyData
                        });
                        
                        alert('‚úÖ Empresa agregada exitosamente.');
                    }
                    
                    companies.sort((a, b) => a.name.localeCompare(b.name));
                    
                    clearCompanyForm();
                    renderCompaniesTable();
                    renderWorkOrderForm();
                    renderFinalCertificationForm();
                    
                } catch (error) {
                    console.error('Error al guardar empresa:', error);
                    alert('Error al guardar la empresa: ' + error.message);
                }
            }

            function editCompany(company) {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede editar empresas.');
                    return;
                }
                
                document.getElementById('company-id').value = company.id;
                document.getElementById('company-name').value = company.name;
                document.getElementById('company-responsible').value = company.responsible;
                document.getElementById('company-rif').value = company.rif;
                
                document.getElementById('save-company-btn').textContent = 'üíæ Actualizar Empresa';
                
                document.getElementById('company-name').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('company-name').focus();
            }

            async function deleteCompany(companyId, companyName) {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede eliminar empresas.');
                    return;
                }
                
                if (!confirm(`¬øEst√° seguro de que desea eliminar la empresa "${companyName}"?\n\n‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n no se puede deshacer.`)) {
                    return;
                }
                
                try {
                    const ordersWithCompany = workOrders.filter(order => 
                        order['Empresa'] === companyName
                    );
                    
                    const completedOrdersWithCompany = completedOrders.filter(order => 
                        order['Empresa'] === companyName
                    );
                    
                    const totalOrders = ordersWithCompany.length + completedOrdersWithCompany.length;
                    
                    if (totalOrders > 0) {
                        const confirmDelete = confirm(
                            `‚ö†Ô∏è Esta empresa est√° siendo utilizada en ${totalOrders} √≥rdenes:\n` +
                            `‚Ä¢ ${ordersWithCompany.length} √≥rdenes en curso\n` +
                            `‚Ä¢ ${completedOrdersWithCompany.length} √≥rdenes finalizadas\n\n` +
                            `Si elimina la empresa, las √≥rdenes existentes mantendr√°n el nombre de la empresa pero no podr√° seleccionarla en nuevas √≥rdenes.\n\n` +
                            `¬øDesea continuar con la eliminaci√≥n?`
                        );
                        
                        if (!confirmDelete) {
                            return;
                        }
                    }
                    
                    await COMPANIES_COLLECTION.doc(companyId).delete();
                    
                    companies = companies.filter(c => c.id !== companyId);
                    
                    renderCompaniesTable();
                    renderWorkOrderForm();
                    renderFinalCertificationForm();
                    
                    alert(`‚úÖ Empresa "${companyName}" eliminada exitosamente.`);
                    
                } catch (error) {
                    console.error('Error al eliminar empresa:', error);
                    alert('Error al eliminar la empresa: ' + error.message);
                }
            }

            function clearCompanyForm() {
                document.getElementById('company-id').value = '';
                document.getElementById('company-name').value = '';
                document.getElementById('company-responsible').value = '';
                document.getElementById('company-rif').value = '';
                document.getElementById('save-company-btn').textContent = 'üíæ Guardar Empresa';
            }

            // *** 12. FUNCIONES DE FILTRADO PARA CERTIFICACIONES FINALES ***

            function initializeCertificationFilters() {
                updateCertificationFilterInput();
            }

            function updateCertificationFilterInput() {
                const fieldSelect = document.getElementById('certification-filter-field');
                const operatorSelect = document.getElementById('certification-filter-operator');
                const valueContainer = document.getElementById('certification-filter-value-container');
                
                const selectedField = fieldSelect.value;
                const selectedOperator = operatorSelect.value;
                
                valueContainer.innerHTML = '';
                
                if (!selectedField) {
                    valueContainer.innerHTML = '<label for="certification-filter-value">Valor:</label><input type="text" id="certification-filter-value" placeholder="Seleccione un campo primero...">';
                    return;
                }
                
                const label = document.createElement('label');
                label.htmlFor = 'certification-filter-value';
                label.textContent = 'Valor:';
                valueContainer.appendChild(label);
                
                let fieldType = 'text';
                if (selectedField === 'Total') fieldType = 'number';
                if (selectedField === 'Fecha de Creaci√≥n') fieldType = 'date';
                if (selectedField === 'A√±o') fieldType = 'number';
                
                if (selectedOperator === 'range' && (fieldType === 'number' || fieldType === 'date')) {
                    const rangeDiv = document.createElement('div');
                    rangeDiv.className = 'range-inputs';
                    rangeDiv.innerHTML = `
                        <input type="${fieldType === 'date' ? 'date' : 'number'}" id="certification-filter-value-min" placeholder="M√≠nimo">
                        <span style="align-self: center;">a</span>
                        <input type="${fieldType === 'date' ? 'date' : 'number'}" id="certification-filter-value-max" placeholder="M√°ximo">
                    `;
                    valueContainer.appendChild(rangeDiv);
                } else {
                    let inputType = 'text';
                    if (fieldType === 'number') inputType = 'number';
                    if (fieldType === 'date') inputType = 'date';
                    
                    const input = document.createElement('input');
                    input.type = inputType;
                    input.id = 'certification-filter-value';
                    
                    if (inputType === 'text') {
                        input.placeholder = 'Texto a buscar...';
                    } else if (inputType === 'number') {
                        input.placeholder = '0';
                        input.step = '0.01';
                    }
                    
                    valueContainer.appendChild(input);
                }
            }

            function addCertificationFilter() {
                const fieldSelect = document.getElementById('certification-filter-field');
                const operatorSelect = document.getElementById('certification-filter-operator');
                const selectedField = fieldSelect.value;
                const selectedOperator = operatorSelect.value;
                
                if (!selectedField) {
                    alert('Por favor, seleccione un campo para filtrar.');
                    return;
                }
                
                let filterValue = '';
                
                if (selectedOperator === 'range') {
                    const minValue = document.getElementById('certification-filter-value-min').value;
                    const maxValue = document.getElementById('certification-filter-value-max').value;
                    
                    if (!minValue || !maxValue) {
                        alert('Por favor, complete ambos valores para el rango.');
                        return;
                    }
                    
                    filterValue = `${minValue}-${maxValue}`;
                } else {
                    const valueInput = document.getElementById('certification-filter-value');
                    filterValue = valueInput.value.trim();
                    
                    if (!filterValue) {
                        alert('Por favor, ingrese un valor para el filtro.');
                        return;
                    }
                }
                
                const existingFilter = certificationActiveFilters.find(f => 
                    f.field === selectedField && f.operator === selectedOperator && f.value === filterValue
                );
                
                if (existingFilter) {
                    alert('Este filtro ya est√° activo.');
                    return;
                }
                
                certificationActiveFilters.push({
                    field: selectedField,
                    operator: selectedOperator,
                    value: filterValue
                });
                
                updateCertificationActiveFiltersDisplay();
                renderFinalCertificationsList();
                
                fieldSelect.value = '';
                operatorSelect.value = 'contains';
                updateCertificationFilterInput();
            }

            function removeCertificationFilter(index) {
                certificationActiveFilters.splice(index, 1);
                updateCertificationActiveFiltersDisplay();
                renderFinalCertificationsList();
            }

            function clearAllCertificationFilters() {
                certificationActiveFilters = [];
                updateCertificationActiveFiltersDisplay();
                renderFinalCertificationsList();
            }

            function updateCertificationActiveFiltersDisplay() {
                const activeFiltersDiv = document.getElementById('certification-active-filters');
                const activeFiltersList = document.getElementById('certification-active-filters-list');
                
                if (certificationActiveFilters.length === 0) {
                    activeFiltersDiv.style.display = 'none';
                    return;
                }
                
                activeFiltersDiv.style.display = 'block';
                activeFiltersList.innerHTML = '';
                
                certificationActiveFilters.forEach((filter, index) => {
                    const filterTag = document.createElement('span');
                    filterTag.className = 'active-filter-tag';
                    
                    let operatorText = '';
                    switch (filter.operator) {
                        case 'contains': operatorText = 'contiene'; break;
                        case 'equals': operatorText = 'es igual a'; break;
                        case 'startsWith': operatorText = 'comienza con'; break;
                        case 'endsWith': operatorText = 'termina con'; break;
                        case 'range': operatorText = 'est√° entre'; break;
                        case 'greater': operatorText = 'es mayor que'; break;
                        case 'less': operatorText = 'es menor que'; break;
                    }
                    
                    filterTag.innerHTML = `
                        <strong>${filter.field}</strong> ${operatorText} "${filter.value}"
                        <span class="remove-filter" onclick="removeCertificationFilter(${index})">√ó</span>
                    `;
                    
                    activeFiltersList.appendChild(filterTag);
                });
            }

            // *** 13. FUNCI√ìN PARA EXPORTAR CERTIFICACIONES A EXCEL ***

            function exportCertificationsToExcel() {
                try {
                    if (finalCertifications.length === 0) {
                        alert('No hay certificaciones finales para exportar.');
                        return;
                    }

                    const excelData = finalCertifications.map(certification => {
                        const row = {
                            'N√∫mero de Certificaci√≥n Final': certification['N√∫mero de Certificaci√≥n Final'],
                            'A√±o': certification['A√±o'] || getCurrentCaracasYear(),
                            'Empresa': certification['Empresa'],
                            'Total': parseFloat(certification['Total']).toFixed(2),
                            'Fecha de Creaci√≥n': certification['Fecha de Creaci√≥n'],
                            'Creado por': certification['Creado por'],
                            '√öltima modificaci√≥n': certification['√öltima modificaci√≥n'] || 'N/A',
                            'Modificado por': certification['Modificado por'] || 'N/A'
                        };
                        
                        const ordenes = certification['√ìrdenes Realizadas'].map(order => 
                            `Orden ${order.numero} (${parseFloat(order.importe).toFixed(2)})`
                        ).join('; ');
                        
                        row['√ìrdenes Realizadas'] = ordenes;
                        row['Cantidad de √ìrdenes'] = certification['√ìrdenes Realizadas'].length;
                        
                        return row;
                    });

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Certificaciones Finales');
                    
                    const currentDate = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(wb, `Certificaciones_Finales_${currentDate}.xlsx`);
                    
                    alert(`‚úÖ ${finalCertifications.length} certificaciones finales exportadas exitosamente a Excel.`);
                    
                } catch (error) {
                    console.error('Error al exportar certificaciones a Excel:', error);
                    alert('Error al exportar certificaciones a Excel: ' + error.message);
                }
            }

            // *** 14. FUNCIONES DE EXPORTACI√ìN E IMPORTACI√ìN ***

            async function exportDatabase() {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede exportar la base de datos.');
                    return;
                }

                try {
                    const ordersSnapshot = await ORDERS_COLLECTION.get();
                    const ordersData = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const completedSnapshot = await COMPLETED_ORDERS_COLLECTION.get();
                    const completedData = completedSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const certificationsSnapshot = await FINAL_CERTIFICATIONS_COLLECTION.get();
                    const certificationsData = certificationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const companiesSnapshot = await COMPANIES_COLLECTION.get();
                    const companiesData = companiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                    const configData = configDoc.exists ? configDoc.data() : {};

                    const exportData = {
                        timestamp: new Date().toISOString(),
                        exportedBy: firebase.auth().currentUser.email,
                        orders: ordersData,
                        completedOrders: completedData,
                        finalCertifications: certificationsData,
                        companies: companiesData,
                        config: configData
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `respaldo_ordenes_trabajo_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    
                    alert(`‚úÖ Base de datos exportada exitosamente. Se descargaron:\n` +
                          `‚Ä¢ ${ordersData.length} √≥rdenes en curso\n` +
                          `‚Ä¢ ${completedData.length} √≥rdenes finalizadas\n` +
                          `‚Ä¢ ${certificationsData.length} certificaciones finales\n` +
                          `‚Ä¢ ${companiesData.length} empresas`);
                    
                } catch (error) {
                    console.error('Error al exportar la base de datos:', error);
                    alert('Error al exportar la base de datos: ' + error.message);
                }
            }

            async function importDatabase(file) {
                if (currentRole !== 'admin') {
                    alert('üö´ Permiso denegado. Solo un administrador puede importar la base de datos.');
                    return;
                }

                if (!file) {
                    return;
                }

                if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n reemplazar√° TODOS los datos actuales en la base de datos. ¬øEst√° seguro de que desea continuar?')) {
                    return;
                }

                try {
                    const fileText = await readFileAsText(file);
                    const importData = JSON.parse(fileText);

                    if (!importData.orders || !importData.config) {
                        alert('El archivo seleccionado no tiene el formato correcto para importar.');
                        return;
                    }

                    const companiesCount = importData.companies?.length || 0;
                    
                    if (!confirm(`Se importar√°n:\n` +
                               `‚Ä¢ ${importData.orders.length} √≥rdenes en curso\n` +
                               `‚Ä¢ ${importData.completedOrders?.length || 0} √≥rdenes finalizadas\n` +
                               `‚Ä¢ ${importData.finalCertifications?.length || 0} certificaciones finales\n` +
                               `‚Ä¢ ${companiesCount} empresas\n` +
                               `‚Ä¢ La configuraci√≥n del sistema\n\n¬øContinuar?`)) {
                        return;
                    }

                    const importedFormStructure = importData.config.formStructure;
                    
                    if (!importedFormStructure || !Array.isArray(importedFormStructure)) {
                        alert('El archivo de importaci√≥n no contiene una estructura de formulario v√°lida. Se usar√° la estructura fija actual.');
                    } else {
                        console.log('‚úÖ Importando estructura completa del formulario desde el archivo de respaldo');
                    }

                    await clearDatabase();

                    const updatedConfig = {
                        ...importData.config,
                        formStructure: FIXED_FORM_STRUCTURE,
                        otCounter: importData.config.otCounter || otCounter,
                        finalCertificationCounter: importData.config.finalCertificationCounter || finalCertificationCounter
                    };

                    await CONFIG_COLLECTION.doc("systemConfig").set(updatedConfig);

                    if (importData.companies && importData.companies.length > 0) {
                        console.log(`üè¢ Importando ${importData.companies.length} empresas...`);
                        
                        for (const company of importData.companies) {
                            const { id, ...companyData } = company;
                            await COMPANIES_COLLECTION.add(companyData);
                        }
                    }

                    console.log('üîÑ Ordenando √≥rdenes por n√∫mero de forma descendente...');
                    const sortedOrders = sortOrdersByNumberDescending(importData.orders);
                    const sortedCompletedOrders = importData.completedOrders ? sortOrdersByNumberDescending(importData.completedOrders) : [];
                    
                    console.log('‚úÖ √ìrdenes ordenadas:', sortedOrders.map(order => order['Orden de Trabajo']));

                    let importedCount = 0;
                    for (const order of sortedOrders) {
                        const { id, ...orderData } = order;
                        
                        if (!orderData.hasOwnProperty('A√±o')) {
                            const creationDate = orderData['Fecha Actual'];
                            let year = extractYearFromDate(creationDate);
                            
                            orderData['A√±o'] = year.toString();
                        }
                        
                        await ORDERS_COLLECTION.add(orderData);
                        importedCount++;
                    }

                    let importedCompletedCount = 0;
                    if (sortedCompletedOrders.length > 0) {
                        for (const order of sortedCompletedOrders) {
                            const { id, ...orderData } = order;
                            
                            if (!orderData.hasOwnProperty('A√±o')) {
                                const creationDate = orderData['Fecha Actual'];
                                let year = extractYearFromDate(creationDate);
                                
                                orderData['A√±o'] = year.toString();
                            }
                            
                            if (orderData.Certificaci√≥n && !orderData.Certificaci√≥n.hasOwnProperty('A√±o')) {
                                orderData.Certificaci√≥n['A√±o'] = getCurrentCaracasYear().toString();
                            }
                            
                            await COMPLETED_ORDERS_COLLECTION.add(orderData);
                            importedCompletedCount++;
                        }
                    }

                    let importedCertificationCount = 0;
                    if (importData.finalCertifications) {
                        const sortedCertifications = importData.finalCertifications.sort((a, b) => {
                            const numA = extractOrderNumber(a['N√∫mero de Certificaci√≥n Final']);
                            const numB = extractOrderNumber(b['N√∫mero de Certificaci√≥n Final']);
                            return numA - numB;
                        });
                        
                        for (const certification of sortedCertifications) {
                            const { id, ...certificationData } = certification;
                            
                            if (!certificationData.hasOwnProperty('A√±o')) {
                                certificationData['A√±o'] = getCurrentCaracasYear().toString();
                            }
                            
                            await FINAL_CERTIFICATIONS_COLLECTION.add(certificationData);
                            importedCertificationCount++;
                        }
                    }

                    await loadInitialData();
                    renderOrdersTable();
                    renderCompletedOrdersTable();
                    renderCompaniesTable();
                    renderFinalCertificationsList();
                    renderWorkOrderForm();
                    renderAdminEditTables();
                    
                    alert(`‚úÖ Base de datos importada exitosamente:\n\n` +
                          `üìã ${importedCount} √≥rdenes en curso\n` +
                          `‚úÖ ${importedCompletedCount} √≥rdenes finalizadas\n` +
                          `üìú ${importedCertificationCount} certificaciones finales\n` +
                          `üè¢ ${companiesCount} empresas\n\n` +
                          `üìù Se utiliz√≥ la estructura fija del formulario.\n` +
                          `üî¢ Las √≥rdenes se ordenaron correctamente por n√∫mero (menor a mayor).`);

                } catch (error) {
                    console.error('Error al importar la base de datos:', error);
                    alert('Error al importar la base de datos: ' + error.message);
                }
            }

            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(e);
                    reader.readAsText(file);
                });
            }

            async function clearDatabase() {
                try {
                    const ordersSnapshot = await ORDERS_COLLECTION.get();
                    const deletePromises = ordersSnapshot.docs.map(doc => ORDERS_COLLECTION.doc(doc.id).delete());
                    await Promise.all(deletePromises);

                    const completedSnapshot = await COMPLETED_ORDERS_COLLECTION.get();
                    const completedDeletePromises = completedSnapshot.docs.map(doc => COMPLETED_ORDERS_COLLECTION.doc(doc.id).delete());
                    await Promise.all(completedDeletePromises);

                    const certificationsSnapshot = await FINAL_CERTIFICATIONS_COLLECTION.get();
                    const certificationsDeletePromises = certificationsSnapshot.docs.map(doc => FINAL_CERTIFICATIONS_COLLECTION.doc(doc.id).delete());
                    await Promise.all(certificationsDeletePromises);

                    const companiesSnapshot = await COMPANIES_COLLECTION.get();
                    const companiesDeletePromises = companiesSnapshot.docs.map(doc => COMPANIES_COLLECTION.doc(doc.id).delete());
                    await Promise.all(companiesDeletePromises);

                    await CONFIG_COLLECTION.doc("systemConfig").delete();

                    console.log('Base de datos limpiada exitosamente');
                } catch (error) {
                    console.error('Error al limpiar la base de datos:', error);
                    throw error;
                }
            }

            // *** 15. FUNCIONES DE FILTRADO DIN√ÅMICO ***

            function initializeFilters() {
                const filterFieldSelect = document.getElementById('filter-field');
                filterFieldSelect.innerHTML = '<option value="">Seleccionar campo...</option>';
                
                const availableFields = new Set();
                
                availableFields.add('Orden de Trabajo');
                availableFields.add('T√≠tulo del Formulario');
                availableFields.add('Fecha Actual');
                availableFields.add('A√±o');
                availableFields.add('Usuario que Crea la Orden');
                availableFields.add('Tipo de Construcci√≥n Espec√≠fica');
                availableFields.add('Estado');
                availableFields.add('Presupuesto Total de la Obra');
                
                formStructure.forEach(section => {
                    section.fields.forEach(field => {
                        if (field.type !== 'static' && field.type !== 'ot_counter' && field.type !== 'date-auto' && field.type !== 'user-auto-fill' && field.type !== 'year-auto') {
                            availableFields.add(field.label);
                        }
                    });
                });
                
                availableFields.add('node_acceso | Costo Proyectado de la Obra');
                availableFields.add('node_acceso | Pago realizado por');
                availableFields.add('node_acceso | Pago x VGT CANTV a cargo de Inter');
                availableFields.add('node_acceso | Pago x VGT EDC a cargo de Inter');
                availableFields.add('node_acceso | Descripci√≥n');
                availableFields.add('node_acceso | Abono Mensual a Recibir por el cliente');
                availableFields.add('isp | Costo Proyectado de la Obra');
                availableFields.add('isp | Pago realizado por');
                availableFields.add('isp | Pago x VGT CANTV a cargo de Inter');
                availableFields.add('isp | Pago x VGT EDC a cargo de Inter');
                availableFields.add('isp | Descripci√≥n');
                availableFields.add('isp | Abono Mensual a Recibir por el cliente');
                
                Array.from(availableFields).sort().forEach(field => {
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    filterFieldSelect.appendChild(option);
                });
                
                updateActiveFiltersDisplay();
            }

            function updateFilterInput() {
                const fieldSelect = document.getElementById('filter-field');
                const operatorSelect = document.getElementById('filter-operator');
                const valueContainer = document.getElementById('filter-value-container');
                
                const selectedField = fieldSelect.value;
                const selectedOperator = operatorSelect.value;
                
                valueContainer.innerHTML = '';
                
                if (!selectedField) {
                    valueContainer.innerHTML = '<label for="filter-value">Valor:</label><input type="text" id="filter-value" placeholder="Seleccione un campo primero...">';
                    return;
                }
                
                let fieldType = 'text';
                
                formStructure.forEach(section => {
                    section.fields.forEach(field => {
                        if (field.label === selectedField) {
                            fieldType = field.type;
                        }
                    });
                });
                
                if (selectedField.includes('Pago x VGT') || selectedField.includes('Costo Proyectado') || selectedField === 'Presupuesto Total de la Obra' || selectedField === 'A√±o') {
                    fieldType = 'number';
                }
                
                if (selectedField === 'Fecha Actual') {
                    fieldType = 'date';
                }
                
                const label = document.createElement('label');
                label.htmlFor = 'filter-value';
                label.textContent = 'Valor:';
                valueContainer.appendChild(label);
                
                if (selectedOperator === 'range' && (fieldType === 'number' || fieldType === 'date')) {
                    const rangeDiv = document.createElement('div');
                    rangeDiv.className = 'range-inputs';
                    rangeDiv.innerHTML = `
                        <input type="${fieldType === 'date' ? 'date' : 'number'}" id="filter-value-min" placeholder="M√≠nimo">
                        <span style="align-self: center;">a</span>
                        <input type="${fieldType === 'date' ? 'date' : 'number'}" id="filter-value-max" placeholder="M√°ximo">
                    `;
                    valueContainer.appendChild(rangeDiv);
                } else {
                    let inputType = 'text';
                    if (fieldType === 'number') inputType = 'number';
                    if (fieldType === 'date') inputType = 'date';
                    
                    const input = document.createElement('input');
                    input.type = inputType;
                    input.id = 'filter-value';
                    
                    if (inputType === 'text') {
                        input.placeholder = 'Texto a buscar...';
                    } else if (inputType === 'number') {
                        input.placeholder = '0';
                        input.step = fieldType === 'number' ? '0.01' : '1';
                    }
                    
                    valueContainer.appendChild(input);
                }
            }

            function addFilter() {
                const fieldSelect = document.getElementById('filter-field');
                const operatorSelect = document.getElementById('filter-operator');
                const selectedField = fieldSelect.value;
                const selectedOperator = operatorSelect.value;
                
                if (!selectedField) {
                    alert('Por favor, seleccione un campo para filtrar.');
                    return;
                }
                
                let filterValue = '';
                
                if (selectedOperator === 'range') {
                    const minValue = document.getElementById('filter-value-min').value;
                    const maxValue = document.getElementById('filter-value-max').value;
                    
                    if (!minValue || !maxValue) {
                        alert('Por favor, complete ambos valores para el rango.');
                        return;
                    }
                    
                    filterValue = `${minValue}-${maxValue}`;
                } else {
                    const valueInput = document.getElementById('filter-value');
                    filterValue = valueInput.value.trim();
                    
                    if (!filterValue) {
                        alert('Por favor, ingrese un valor para el filtro.');
                        return;
                    }
                }
                
                const existingFilter = activeFilters.find(f => 
                    f.field === selectedField && f.operator === selectedOperator && f.value === filterValue
                );
                
                if (existingFilter) {
                    alert('Este filtro ya est√° activo.');
                    return;
                }
                
                activeFilters.push({
                    field: selectedField,
                    operator: selectedOperator,
                    value: filterValue
                });
                
                updateActiveFiltersDisplay();
                renderOrdersTable();
                
                fieldSelect.value = '';
                operatorSelect.value = 'contains';
                updateFilterInput();
            }

            function removeFilter(index) {
                activeFilters.splice(index, 1);
                updateActiveFiltersDisplay();
                renderOrdersTable();
            }

            function clearAllFilters() {
                activeFilters = [];
                updateActiveFiltersDisplay();
                renderOrdersTable();
            }

            function updateActiveFiltersDisplay() {
                const activeFiltersDiv = document.getElementById('active-filters');
                const activeFiltersList = document.getElementById('active-filters-list');
                
                if (activeFilters.length === 0) {
                    activeFiltersDiv.style.display = 'none';
                    return;
                }
                
                activeFiltersDiv.style.display = 'block';
                activeFiltersList.innerHTML = '';
                
                activeFilters.forEach((filter, index) => {
                    const filterTag = document.createElement('span');
                    filterTag.className = 'active-filter-tag';
                    
                    let operatorText = '';
                    switch (filter.operator) {
                        case 'contains': operatorText = 'contiene'; break;
                        case 'equals': operatorText = 'es igual a'; break;
                        case 'startsWith': operatorText = 'comienza con'; break;
                        case 'endsWith': operatorText = 'termina con'; break;
                        case 'range': operatorText = 'est√° entre'; break;
                        case 'greater': operatorText = 'es mayor que'; break;
                        case 'less': operatorText = 'es menor que'; break;
                    }
                    
                    filterTag.innerHTML = `
                        <strong>${filter.field}</strong> ${operatorText} "${filter.value}"
                        <span class="remove-filter" onclick="removeFilter(${index})">√ó</span>
                    `;
                    
                    activeFiltersList.appendChild(filterTag);
                });
            }

            // *** 16. FUNCIONES DE FILTRADO PARA √ìRDENES FINALIZADAS ***

            function initializeCompletedFilters() {
                const filterFieldSelect = document.getElementById('completed-filter-field');
                filterFieldSelect.innerHTML = '<option value="">Seleccionar campo...</option>';
                
                const availableFields = new Set();
                
                availableFields.add('Orden de Trabajo');
                availableFields.add('T√≠tulo del Formulario');
                availableFields.add('Fecha Actual');
                availableFields.add('A√±o');
                availableFields.add('Fecha de Finalizaci√≥n');
                availableFields.add('Usuario que Crea la Orden');
                availableFields.add('Tipo de Construcci√≥n Espec√≠fica');
                availableFields.add('Presupuesto Total de la Obra');
                availableFields.add('Estado de Certificaci√≥n Final');
                
                availableFields.add('Certificaci√≥n | Empresa Contratista');
                availableFields.add('Certificaci√≥n | Identificaci√≥n Fiscal RIF');
                availableFields.add('Certificaci√≥n | Importe Total de la Obra');
                
                formStructure.forEach(section => {
                    section.fields.forEach(field => {
                        if (field.type !== 'static' && field.type !== 'ot_counter' || 
                            field.type !== 'date-auto' || field.type !== 'user-auto-fill' || field.type !== 'year-auto') {
                            if (field.label) {
                                availableFields.add(field.label);
                            }
                        }
                    });
                });
                
                Array.from(availableFields).sort().forEach(field => {
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    filterFieldSelect.appendChild(option);
                });
                
                updateCompletedActiveFiltersDisplay();
            }

            function updateCompletedFilterInput() {
                const fieldSelect = document.getElementById('completed-filter-field');
                const operatorSelect = document.getElementById('completed-filter-operator');
                const valueContainer = document.getElementById('completed-filter-value-container');
                
                const selectedField = fieldSelect.value;
                const selectedOperator = operatorSelect.value;
                
                valueContainer.innerHTML = '';
                
                if (!selectedField) {
                    valueContainer.innerHTML = '<label for="completed-filter-value">Valor:</label><input type="text" id="completed-filter-value" placeholder="Seleccione un campo primero...">';
                    return;
                }
                
                let fieldType = 'text';
                
                formStructure.forEach(section => {
                    section.fields.forEach(field => {
                        if (field.label === selectedField) {
                            if (field.type === 'number' || field.type === 'date-input') {
                                fieldType = field.type;
                            }
                        }
                    });
                });
                
                if (selectedField.includes('Importe Total') || selectedField.includes('Pago x VGT') || 
                    selectedField === 'Presupuesto Total de la Obra' || selectedField === 'A√±o') {
                    fieldType = 'number';
                }
                
                if (selectedField === 'Fecha Actual' || selectedField === 'Fecha de Finalizaci√≥n' || 
                    selectedField.includes('Fecha')) {
                    fieldType = 'date';
                }
                
                const label = document.createElement('label');
                label.htmlFor = 'completed-filter-value';
                label.textContent = 'Valor:';
                valueContainer.appendChild(label);
                
                if (selectedOperator === 'range' && (fieldType === 'number' || fieldType === 'date')) {
                    const rangeDiv = document.createElement('div');
                    rangeDiv.className = 'range-inputs';
                    rangeDiv.innerHTML = `
                        <input type="${fieldType === 'date' ? 'date' : 'number'}" id="completed-filter-value-min" placeholder="M√≠nimo">
                        <span style="align-self: center;">a</span>
                        <input type="${fieldType === 'date' ? 'date' : 'number'}" id="completed-filter-value-max" placeholder="M√°ximo">
                    `;
                    valueContainer.appendChild(rangeDiv);
                } else {
                    let inputType = 'text';
                    if (fieldType === 'number') inputType = 'number';
                    if (fieldType === 'date') inputType = 'date';
                    
                    const input = document.createElement('input');
                    input.type = inputType;
                    input.id = 'completed-filter-value';
                    
                    if (inputType === 'text') {
                        input.placeholder = 'Texto a buscar...';
                    } else if (inputType === 'number') {
                        input.placeholder = '0';
                        input.step = fieldType === 'number' ? '0.01' : '1';
                    }
                    
                    valueContainer.appendChild(input);
                }
            }

            function addCompletedFilter() {
                const fieldSelect = document.getElementById('completed-filter-field');
                const operatorSelect = document.getElementById('completed-filter-operator');
                const selectedField = fieldSelect.value;
                const selectedOperator = operatorSelect.value;
                
                if (!selectedField) {
                    alert('Por favor, seleccione un campo para filtrar.');
                    return;
                }
                
                let filterValue = '';
                
                if (selectedOperator === 'range') {
                    const minValue = document.getElementById('completed-filter-value-min').value;
                    const maxValue = document.getElementById('completed-filter-value-max').value;
                    
                    if (!minValue || !maxValue) {
                        alert('Por favor, complete ambos valores para el rango.');
                        return;
                    }
                    
                    filterValue = `${minValue}-${maxValue}`;
                } else {
                    const valueInput = document.getElementById('completed-filter-value');
                    filterValue = valueInput.value.trim();
                    
                    if (!filterValue) {
                        alert('Por favor, ingrese un valor para el filtro.');
                        return;
                    }
                }
                
                const existingFilter = completedActiveFilters.find(f => 
                    f.field === selectedField && f.operator === selectedOperator && f.value === filterValue
                );
                
                if (existingFilter) {
                    alert('Este filtro ya est√° activo.');
                    return;
                }
                
                completedActiveFilters.push({
                    field: selectedField,
                    operator: selectedOperator,
                    value: filterValue
                });
                
                updateCompletedActiveFiltersDisplay();
                renderCompletedOrdersTable();
                
                fieldSelect.value = '';
                operatorSelect.value = 'contains';
                updateCompletedFilterInput();
            }

            function removeCompletedFilter(index) {
                completedActiveFilters.splice(index, 1);
                updateCompletedActiveFiltersDisplay();
                renderCompletedOrdersTable();
            }

            function clearAllCompletedFilters() {
                completedActiveFilters = [];
                updateCompletedActiveFiltersDisplay();
                renderCompletedOrdersTable();
            }

            function updateCompletedActiveFiltersDisplay() {
                const activeFiltersDiv = document.getElementById('completed-active-filters');
                const activeFiltersList = document.getElementById('completed-active-filters-list');
                
                if (completedActiveFilters.length === 0) {
                    activeFiltersDiv.style.display = 'none';
                    return;
                }
                
                activeFiltersDiv.style.display = 'block';
                activeFiltersList.innerHTML = '';
                
                completedActiveFilters.forEach((filter, index) => {
                    const filterTag = document.createElement('span');
                    filterTag.className = 'active-filter-tag';
                    
                    let operatorText = '';
                    switch (filter.operator) {
                        case 'contains': operatorText = 'contiene'; break;
                        case 'equals': operatorText = 'es igual a'; break;
                        case 'startsWith': operatorText = 'comienza con'; break;
                        case 'endsWith': operatorText = 'termina con'; break;
                        case 'range': operatorText = 'est√° entre'; break;
                        case 'greater': operatorText = 'es mayor que'; break;
                        case 'less': operatorText = 'es menor que'; break;
                    }
                    
                    filterTag.innerHTML = `
                        <strong>${filter.field}</strong> ${operatorText} "${filter.value}"
                        <span class="remove-filter" onclick="removeCompletedFilter(${index})">√ó</span>
                    `;
                    
                    activeFiltersList.appendChild(filterTag);
                });
            }

            // *** 17. FUNCIONES DE EXPORTACI√ìN A EXCEL ***

            function exportToExcel(type) {
                try {
                    const orders = type === 'current' ? workOrders : completedOrders;
                    const fileName = type === 'current' ? 'Ordenes_En_Curso' : 'Ordenes_Finalizadas';
                    
                    if (orders.length === 0) {
                        alert(`No hay √≥rdenes ${type === 'current' ? 'en curso' : 'finalizadas'} para exportar.`);
                        return;
                    }

                    const excelData = prepareExcelData(orders, type);
                    
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, '√ìrdenes de Trabajo');
                    
                    const currentDate = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(wb, `${fileName}_${currentDate}.xlsx`);
                    
                    alert(`‚úÖ ${orders.length} √≥rdenes exportadas exitosamente a Excel.`);
                    
                } catch (error) {
                    console.error('Error al exportar a Excel:', error);
                    alert('Error al exportar a Excel: ' + error.message);
                }
            }

            function exportFilteredToExcel(type) {
                try {
                    let filteredOrders = [];
                    const fileName = type === 'current' ? 'Ordenes_Filtradas_En_Curso' : 'Ordenes_Filtradas_Finalizadas';
                    
                    if (type === 'current') {
                        filteredOrders = workOrders;
                        if (activeFilters.length > 0) {
                            filteredOrders = workOrders.filter(order => {
                                return activeFilters.every(filter => applyFilterLogic(order, filter));
                            });
                        }
                    } else {
                        filteredOrders = completedOrders;
                        if (completedActiveFilters.length > 0) {
                            filteredOrders = completedOrders.filter(order => {
                                return completedActiveFilters.every(filter => applyFilterLogic(order, filter));
                            });
                        }
                    }

                    if (filteredOrders.length === 0) {
                        alert('No hay √≥rdenes que coincidan con los filtros actuales.');
                        return;
                    }

                    const excelData = prepareExcelData(filteredOrders, type);
                    
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, '√ìrdenes Filtradas');
                    
                    const currentDate = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(wb, `${fileName}_${currentDate}.xlsx`);
                    
                    alert(`‚úÖ ${filteredOrders.length} √≥rdenes filtradas exportadas exitosamente.`);
                    
                } catch (error) {
                    console.error('Error al exportar √≥rdenes filtradas:', error);
                    alert('Error al exportar √≥rdenes filtradas: ' + error.message);
                }
            }

            function exportCurrentViewToExcel(type) {
                try {
                    const tableId = type === 'current' ? 'orders-table' : 'completed-orders-table';
                    const table = document.getElementById(tableId);
                    const rows = table.querySelectorAll('tbody tr');
                    
                    if (rows.length === 0) {
                        alert('No hay datos visibles en la tabla para exportar.');
                        return;
                    }

                    const excelData = [];
                    const headers = [];
                    
                    const headerCells = table.querySelectorAll('thead th');
                    headerCells.forEach(header => {
                        if (!header.textContent.includes('Acciones')) {
                            headers.push(header.textContent.trim());
                        }
                    });

                    rows.forEach(row => {
                        const rowData = {};
                        const cells = row.querySelectorAll('td');
                        
                        cells.forEach((cell, index) => {
                            if (index < headers.length) {
                                rowData[headers[index]] = cell.textContent.trim();
                            }
                        });
                        
                        if (Object.keys(rowData).length > 0) {
                            excelData.push(rowData);
                        }
                    });

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Vista Actual');
                    
                    const currentDate = new Date().toISOString().split('T')[0];
                    const fileName = type === 'current' ? 'Vista_Actual_En_Curso' : 'Vista_Actual_Finalizadas';
                    XLSX.writeFile(wb, `${fileName}_${currentDate}.xlsx`);
                    
                    alert(`‚úÖ ${excelData.length} registros de la vista actual exportados exitosamente.`);
                    
                } catch (error) {
                    console.error('Error al exportar vista actual:', error);
                    alert('Error al exportar vista actual: ' + error.message);
                }
            }

            function prepareExcelData(orders, type) {
                const allFields = new Set();
                
                orders.forEach(order => {
                    Object.keys(order).forEach(key => {
                        if (key !== 'id' && !key.startsWith('_')) {
                            allFields.add(key);
                        }
                    });
                });

                if (type === 'completed') {
                    allFields.add('Estado de Certificaci√≥n Final');
                }
                
                const fieldNames = Array.from(allFields).sort();
                
                const excelData = orders.map(order => {
                    const row = {};
                    
                    fieldNames.forEach(field => {
                        let value = order[field];
                        
                        if (field === 'Estado de Certificaci√≥n Final') {
                            const certificationStatus = getOrderCertificationStatus(order.id);
                            if (certificationStatus) {
                                value = `Certificada en ${certificationStatus.length} certificaci√≥n(es) final(es)`;
                            } else {
                                value = 'No certificada';
                            }
                        }
                        else if (value === null || value === undefined) {
                            value = '';
                        } else if (typeof value === 'object') {
                            if (field === 'Certificaci√≥n') {
                                value = Object.entries(value).map(([k, v]) => `${k}: ${v}`).join('; ');
                            } else {
                                value = JSON.stringify(value);
                            }
                        } else if (field.includes('Fecha')) {
                            value = String(value);
                        } else if (typeof value === 'number') {
                            value = value;
                        } else {
                            value = String(value).trim();
                        }
                        
                        row[field] = value;
                    });
                    
                    return row;
                });

                return excelData;
            }

            function applyFilterLogic(order, filter) {
                const fieldValue = order[filter.field] || '';
                const filterValue = filter.value;
                
                switch (filter.operator) {
                    case 'contains':
                        return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                    case 'equals':
                        return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                    case 'startsWith':
                        return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                    case 'endsWith':
                        return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                    case 'range':
                        const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                        const numValue = parseFloat(fieldValue);
                        return !isNaN(numValue) && numValue >= min && numValue <= max;
                    case 'greater':
                        const greaterValue = parseFloat(fieldValue);
                        const greaterFilter = parseFloat(filterValue);
                        return !isNaN(greaterValue) && greaterValue > greaterFilter;
                    case 'less':
                        const lessValue = parseFloat(fieldValue);
                        const lessFilter = parseFloat(filterValue);
                        return !isNaN(lessValue) && lessValue < lessFilter;
                    default:
                        return true;
                }
            }

        </script>

    </body>
</html>

